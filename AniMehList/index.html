<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AniMehList — Your Anime Shelf</title>
    <link rel="icon" href="assets/logo.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <style>
      :root {
        --bg: #0b0c10;
        --panel: #0f1117;
        --panel-2: #0b0f16;
        --text: #e6e8ef;
        --muted: #9aa3b2;
        --brand: #7c3aed;
        --brand-2: #22d3ee;
        --ok: #22c55e;
        --warn: #f59e0b;
        --danger: #f56565;
        --card: #151927;
        --chip: #1d2336;
        --ring: #2b2f45;
        --shadow: 0 10px 24px rgba(0, 0, 0, .35);
        --radius: 14px;
        --radius-sm: 10px;
        --container: 1100px;
        --title-font: 'Orbitron', system-ui, -apple-system, 'Segoe UI', Roboto;
        --body-font: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial;
        --ui-duration: 220ms;
        --bp-mobile: 720px;
        --bp-compact: 520px;
        --bp-small: 600px;
        --focus-ring: 0 0 0 4px rgba(124, 58, 237, .14);
        --accent-1: #6ee7ff;
        --accent-2: #a78bfa;
        --accent-3: #22d3ee;
      }

      * { box-sizing: border-box }
      img { max-width: 100% }

      html, body {
        height: 100%;
        overflow-x: hidden; /* keep this per user request */
      }

      body {
        margin: 0;
        background: linear-gradient(180deg, #07070a, #0b0c10 40%);
        color: var(--text);
        font: 400 16px/1.55 var(--body-font);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        -webkit-tap-highlight-color: transparent;
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
      }

      a { color: inherit }

      .container {
        max-width: var(--container);
        margin: 0 auto;
        padding: 0 16px;
        width: 100%;
      }

      .header {
        position: sticky;
        top: 0;
        z-index: 60;
        background: rgba(11, 12, 16, .9);
        backdrop-filter: blur(6px);
        border-bottom: 1px solid rgba(255, 255, 255, .06);
      }

      .nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        min-height: 66px;
        padding: 6px 0;
        flex-wrap: nowrap;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 800;
        letter-spacing: .3px;
        min-width: 0;
        flex: 1 1 auto;
      }

      .logo-img {
        height: 34px;
        border-radius: 5px;
        object-fit: cover;
        display: block;
        flex: 0 0 auto;
      }

      .brand-title {
        font-family: var(--title-font);
        letter-spacing: .4px;
        white-space: nowrap;
      }

      .nav-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .nav-cta {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-left: auto;
      }

      .btn {
        appearance: none;
        border: 0;
        border-radius: 12px;
        padding: 10px 14px;
        background: var(--panel);
        color: #e9ecf3;
        cursor: pointer;
        display: inline-flex;
        gap: 8px;
        align-items: center;
        box-shadow: var(--shadow);
        transition: transform var(--ui-duration) ease, opacity var(--ui-duration) ease, background .2s ease;
      }
      .btn:hover { transform: translateY(-2px) }
      .btn:focus-visible { outline: 0; box-shadow: var(--focus-ring) }
      .btn.brand { background: linear-gradient(90deg, var(--brand), var(--brand-2)); color: #fff; font-weight: 700 }
      .btn.ghost { background: #131826; border: 1px solid rgba(255, 255, 255, .08); box-shadow: none }
      .btn.danger { background: #2d1a25; color: #fee2e2; border: 1px solid rgba(255, 255, 255, .06) }
      .btn.sm { padding: 8px 10px; border-radius: 10px; font-size: 13px }
      .btn.icon { padding: 8px 10px; border-radius: 10px; font-size: 14px; box-shadow: none; background: rgba(0, 0, 0, .35); border: 1px solid rgba(255, 255, 255, .15) }

      .btn.loading {
        pointer-events: none;
        opacity: 0.85;
        position: relative;
      }
      .btn.loading::before {
        content: '';
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      .tag {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        background: #151a2b;
        border: 1px solid rgba(255, 255, 255, .06);
        color: #b6bfd3;
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 12px;
        white-space: nowrap;
      }

      .hamburger { display: none }

      @media (max-width:var(--bp-mobile)) {
        .nav { row-gap: 8px; flex-direction: column; align-items: center }
        .nav-cta { display: none }
        .hamburger { display: inline-flex; margin-left: auto }
        .brand-title { font-size: 15px }
        .logo-img { width: 30px; height: 30px }
        .logo { justify-content: center; flex: none }
        .nav-meta { display: none }
        .toolbar-top { flex-direction: column; align-items: stretch; gap: 8px }
        .actions-row { flex-direction: row; justify-content: space-between }
        .search { width: 100% }
        .view-toggle { justify-content: center; flex: 1 1 auto }
        .btn.brand { flex: 0 0 auto }
      }

      .menu-panel, .account-panel {
        position: fixed;
        top: 66px;
        right: 12px;
        z-index: 80;
        width: min(360px, 94vw);
        background: #101525;
        border: 1px solid rgba(255, 255, 255, .08);
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, .5);
        transform-origin: top right;
        transform: scale(.98) translateY(-6px);
        opacity: 0;
        pointer-events: none;
        transition: transform .2s ease, opacity .2s ease;
      }
      .menu-panel.open, .account-panel.open {
        transform: scale(1) translateY(0);
        opacity: 1;
        pointer-events: auto;
      }

      .menu-sec { padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, .06) }
      .menu-sec:last-child { border-bottom: 0 }
      .menu-title { font-family: var(--title-font); font-size: 13px; color: #cbd5f7; margin-bottom: 8px }
      .menu-row { display: flex; flex-wrap: wrap; gap: 8px }
      .menu-item {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        background: #12182a;
        border: 1px solid rgba(255, 255, 255, .08);
        border-radius: 12px;
        padding: 10px 12px;
      }
      .menu-kv { display: flex; align-items: center; gap: 10px }
      .menu-note { font-size: 12px; color: #9aa3b2 }

      /* Banner */
      .banner {
        position: relative;
        display: block;
        height: clamp(520px, 70vw, 880px);
        width: 100vw;
        margin-left: calc(50% - 50vw);
        border-bottom: 1px solid rgba(255, 255, 255, .06);
        overflow: hidden;
      }
      .banner-image {
        position: absolute;
        inset: 0;
        background-position: center;
        background-size: cover;
        background-repeat: no-repeat;
        opacity: 1;
        filter: saturate(1.02) contrast(1.05) brightness(.9);
        transform: scale(1.02);
      }
      .banner::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(7, 8, 12, .6), rgba(7, 8, 12, .75) 40%, rgba(7, 8, 12, .9));
        pointer-events: none;
      }
      .banner-inner {
        position: relative;
        z-index: 2;
        height: 100%;
        display: flex;
        align-items: flex-end;
        padding: 96px 0 40px;
      }
      .hero {
        display: grid;
        gap: 10px;
        max-width: var(--container);
        margin: 0 auto;
        width: 100%;
        padding: 0 16px;
      }
      .hero-box {
        max-width: min(820px, 96%);
        background: rgba(7, 8, 12, .45);
        border: 1px solid rgba(255, 255, 255, .15);
        padding: 14px 16px;
        border-radius: 14px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, .45);
        backdrop-filter: blur(4px);
      }
      .hero h1 {
        margin: 0 0 6px 0;
        font-size: clamp(22px, 3.2vw, 38px);
        line-height: 1.1;
        letter-spacing: .6px;
        font-family: var(--title-font);
        font-weight: 700;
        text-shadow: 0 2px 6px rgba(0, 0, 0, .55);
      }
      .hero .sub { color: #d4daf0; font-size: 14px; text-shadow: 0 1px 4px rgba(0, 0, 0, .5) }

      /* Toolbar */
      .toolbar { display: flex; flex-direction: column; gap: 12px; margin: 14px 0 10px }
      .toolbar-top { display: flex; gap: 10px; flex-wrap: wrap; align-items: center }
      .actions-row { display: flex; gap: 10px; align-items: center; flex-wrap: nowrap }
      .search-container { position: relative; flex: 1; min-width: 220px }
      .search {
        width: 100%;
        background: #0f1424;
        border: 1px solid rgba(255, 255, 255, .08);
        border-radius: 12px;
        color: #e8ecfa;
        padding: 10px 40px 10px 12px;
        outline: 0;
      }
      .search:focus { box-shadow: var(--focus-ring); border-color: rgba(124, 58, 237, .7) }
      .search-clear {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: 0 0;
        border: none;
        color: var(--muted);
        cursor: pointer;
        font-size: 16px;
        display: none;
      }
      .search-clear.visible { display: block }

      .toolbar-tabs {
        display: flex;
        gap: 8px;
        flex-wrap: nowrap;
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      .toolbar-tabs::-webkit-scrollbar { display: none }
      .tab {
        padding: 8px 12px;
        border-radius: 999px;
        color: #c6cde0;
        background: #141a2a;
        border: 1px solid rgba(255, 255, 255, .06);
        cursor: pointer;
        transition: transform .15s;
        flex: 0 0 auto;
      }
      .tab:hover { transform: translateY(-1px) }
      .tab.active {
        background: linear-gradient(90deg, rgba(124, 58, 237, .25), rgba(34, 211, 238, .2));
        color: #fff;
        border-color: rgba(255, 255, 255, .12);
      }
      .tab .count { opacity: .7; margin-left: 6px }

      /* Sort segmented control */
      .sort-toggle, .view-toggle {
        display: inline-flex;
        background: #11162a;
        border: 1px solid rgba(255, 255, 255, .06);
        border-radius: 12px;
        overflow: hidden;
      }
      .seg {
        appearance: none;
        background: 0 0;
        color: #cfe0ff;
        padding: 8px 12px;
        border: 0;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .seg:hover { background: rgba(255, 255, 255, .04) }
      .seg.active {
        background: linear-gradient(90deg, rgba(124, 58, 237, .25), rgba(34, 211, 238, .2));
        color: #fff;
      }
      /* Push view toggle to the right */
      .toolbar .toolbar-top .view-toggle { margin-left: auto }

      .section { margin-top: 18px }
      .section-title {
        display: flex; align-items: center; gap: 10px; margin: 8px 0 10px;
        font-family: var(--title-font); font-size: 18px; letter-spacing: .3px; color: #d6dbef;
      }

      /* Grid/shelf */
      .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px }
      .col { grid-column: span 12 }
      .grid.view-grid .col { grid-column: span 6 }
      @media (min-width:540px){ .grid.view-grid .col { grid-column: span 4 } }
      @media (min-width:780px){ .grid.view-grid .col { grid-column: span 3 } }
      @media (min-width:1024px){ .grid.view-grid .col { grid-column: span 3 } }

      .grid.view-compact .col { grid-column: span 12 }
      @media (min-width:900px){ .grid.view-compact .col { grid-column: span 6 } }
      @media (min-width:1200px){ .grid.view-compact .col { grid-column: span 4 } }

      .card {
        background: #12182a;
        border: 1px solid rgba(255, 255, 255, .08);
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(1, 5, 18, .5);
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      .cover {
        position: relative;
        width: 100%;
        aspect-ratio: 1/1.4;
        background: #0e1323;
        overflow: hidden;
      }
      .cover img {
        width: 100%; height: 100%; object-fit: cover; display: block;
      }
      .cover .ph {
        position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
        background: linear-gradient(180deg, #1a2040, #11162e); color: #aeb8d9; font-weight: 800;
        font-size: clamp(22px, 5vw, 36px); letter-spacing: .8px; text-transform: uppercase;
      }
      /* Per-card image loader */
      .cover-loader {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        background: linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.25));
      }
      .cover-loader i {
        color: var(--brand-2);
        font-size: 18px;
        animation: spin 0.8s linear infinite;
        filter: drop-shadow(0 2px 6px rgba(0,0,0,.5));
      }

      .floating-actions {
        position: absolute;
        top: 6px;
        right: 6px;
        display: flex;
        gap: 6px;
        z-index: 2;
      }
      .floating-actions .icon-btn {
        background: rgba(6, 9, 16, .7);
        color: #e8ecfa;
        border: 1px solid rgba(255, 255, 255, .15);
        padding: 6px;
        border-radius: 8px;
        cursor: pointer;
      }
      .floating-actions .icon-btn:hover { background: rgba(6, 9, 16, .9) }

      .badge-bottom {
        position: absolute;
        right: 6px;
        bottom: 6px;
        background: rgba(0, 0, 0, .55);
        border: 1px solid rgba(255, 255, 255, .12);
        color: #eaf0ff;
        font-size: 11px;
        padding: 4px 6px;
        border-radius: 999px;
        display: flex;
        gap: 6px;
        align-items: center;
        z-index: 1;
      }

      .card-body { padding: 8px; min-width: 0; display: flex; flex-direction: column; gap: 6px }
      .title-row { display: grid; grid-template-columns: 1fr; align-items: center; gap: 6px; min-width: 0 }
      .title {
        font-weight: 800; letter-spacing: .2px; font-family: var(--title-font);
        font-size: 14px; line-height: 1.2; min-width: 0; overflow: hidden;
        text-overflow: ellipsis; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2;
        height: 2.4em;
      }
      .chips { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; color: #b3bad2; font-size: 11px; margin: 2px 0 4px }
      .chip { font-size: 10px; padding: 3px 6px; border-radius: 999px; background: #161c2e; border: 1px solid rgba(255, 255, 255, .08); color: #cfe0ff }

      .controls {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 2px;
        flex-wrap: wrap; /* default can wrap */
      }
      .control-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 32px;
        border-radius: 8px;
        background: #1a2240;
        color: #dfe6ff;
        border: 1px solid rgba(255, 255, 255, .12);
        cursor: pointer;
        flex: 0 0 auto;
      }
      .control-btn:hover { background: #1f2850 }
      .progress-readout {
        display: inline-flex; gap: 4px; align-items: center; padding: 6px 10px; border-radius: 8px;
        background: #131a2f; border: 1px solid rgba(255, 255, 255, .08);
        font-size: 12px; color: #cfe0ff; flex: 1 1 auto; min-width: 0;
      }

      .move-select, .select {
        appearance: none;
        background: #0f1424;
        border: 1px solid rgba(255, 255, 255, .1);
        border-radius: 12px;
        color: #e8ecfa;
        padding: 10px 38px 10px 12px;
        outline: 0;
        height: 38px;
        line-height: 1;
        position: relative;
        cursor: pointer;
        box-shadow: none;
      }
      .move-select { height: 32px; padding: 6px 34px 6px 8px; border-radius: 8px; margin-left: auto }
      .move-select:focus, .select:focus { box-shadow: var(--focus-ring); border-color: rgba(124, 58, 237, .7) }
      .move-select, .select {
        background-image: linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, 0) 40%),
          url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23cfe0ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat, no-repeat;
        background-position: 0 0, calc(100% - 12px) 50%;
        background-size: auto, 14px;
      }

      @media (max-width:520px) {
        /* Keep -1, EP, +1 on the same line; move-select drops to next line full width */
        .controls {
          display: grid;
          grid-template-columns: 32px 1fr 32px;
          align-items: center;
          gap: 6px;
        }
        .control-btn { 
          /* width: 32px; */
           height: 28px;
            padding: 0; }
        .progress-readout { padding: 4px 8px; font-size: 12px; min-width: 0; }
        .move-select { grid-column: 1 / -1; width: 100%; margin-left: 0; }
      }

      .muted { color: #9aa3b2 }
      .muted-small { color: #9aa3b2; font-size: 13px }

      .card.row {
        flex-direction: row;
        align-items: stretch;
        gap: 0;
        flex-wrap: nowrap !important;
        position: relative; /* so floating actions position correctly on compact cards */
      }
      .card.row .cover { width: 80px; flex: 0 0 80px; aspect-ratio: 1/1.4 }
      .card.row .badge-bottom { display: none }
      .card.row .card-body { padding: 8px 10px; gap: 6px }
      .card.row .chips { margin: 2px 0 2px }
      .card.row .title { height: 2.4em; }
      .card.row .controls { margin-top: 2px }
      .card.row .floating-actions { top: 6px; right: 6px }

      /* Modal basics */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(5, 7, 12, .72);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 120;
        transition: opacity var(--ui-duration) ease;
      }
      .modal.open { display: flex }
      .sheet {
        background: #10162a;
        border: 1px solid rgba(255, 255, 255, .08);
        border-radius: 14px;
        width: min(760px, 98%);
        padding: 18px;
        transform: translateY(8px) scale(.995);
        opacity: 0;
        transition: transform .28s cubic-bezier(.2, .9, .3, 1), opacity .2s ease;
      }
      .modal.open .sheet { transform: translateY(0) scale(1); opacity: 1 }
      .sheet h3 { margin: 0 0 8px; font-family: var(--title-font) }

      .form { display: grid; gap: 10px }
      .row { display: flex; gap: 10px; flex-wrap: wrap }
      .row.img-row { align-items: center; flex-wrap: nowrap }
      @media (max-width:520px) { .row.img-row { flex-wrap: wrap } }

      .input-wrapper { position: relative; flex: 1 }
      .file, .input, .select {
        background: #0f1424;
        border: 1px solid rgba(255, 255, 255, .08);
        border-radius: 12px;
        color: #e8ecfa;
        padding: 12px 12px;
        outline: 0;
        width: 100%;
      }
      .input:focus, .select:focus { box-shadow: var(--focus-ring); border-color: rgba(124, 58, 237, .7) }
      .float-group { position: relative; flex: 1 1 auto }
      .float-group .input { padding: 18px 40px 10px 12px; border-radius: 12px }
      .float-group label {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9aa3b2; font-size: 13px; pointer-events: none;
        transition: all .16s ease; background: 0 0; padding: 0 4px
      }
      .float-group.filled label, .float-group:focus-within label {
        top: 6px; transform: none; font-size: 11px; color: #cbd5f7; background: #10162a
      }
      .clear-btn {
        position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
        background: rgba(255, 255, 255, .06); border: 1px solid rgba(255, 255, 255, .12);
        color: #cfd6ea; cursor: pointer; font-size: 12px; width: 24px; height: 24px; border-radius: 6px;
        display: none; align-items: center; justify-content: center;
      }
      .clear-btn.visible { display: inline-flex }
      .clear-btn:focus-visible { box-shadow: var(--focus-ring) }

      .hint { color: #9aa3b2; font-size: 12px }
      .danger-text { color: var(--danger) }
      .link { color: #8ab4ff; cursor: pointer }
      .small { font-size: 12px }

      .oauth-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 8px }
      .btn.oauth { justify-content: center; font-weight: 700 }
      .btn.oauth.email { background: #1a2138 }

      #toasts {
        position: fixed; right: 18px; bottom: 18px; display: flex; flex-direction: column; gap: 10px; z-index: 150;
      }
      .toast {
        min-width: 220px; max-width: 420px; padding: 12px 14px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.45);
        color: #fff; font-weight: 700; display: flex; gap: 10px; align-items: center; transform: translateY(10px) scale(.995); opacity: 0;
      }
      .toast .msg { font-weight: 700; font-size: 14px }
      .toast.info { background: #1b304a }
      .toast.success { background: linear-gradient(90deg, #16a34a, #22c55e) }
      .toast.error { background: linear-gradient(90deg, var(--danger), #ef6b6b) }
      .toast.enter { animation: toast-in .26s cubic-bezier(.2, .9, .3, 1) forwards }
      .toast.exit { animation: toast-out .3s ease forwards }
      @keyframes toast-in { to { transform: translateY(0) scale(1); opacity: 1 } }
      @keyframes toast-out { to { transform: translateY(8px) scale(.98); opacity: 0 } }

      footer { border-top: 1px solid rgba(255, 255, 255, .08); margin-top: auto; background: #0f1117 }
      footer .foot-wrap { display: block; justify-content: space-between; align-items: center; gap: 16px; padding: 22px 0 26px }

      .center { display: flex; align-items: center; justify-content: center }
      .hidden { display: none !important }

      @media (max-width:var(--bp-mobile)) {
        .hero h1 { font-size: 22px }
        .toolbar-top { gap: 8px }
        .move-select { margin-left: 0; width: 100% }
        .card.row .cover { width: 68px; flex: 0 0 68px }
        .controls { gap: 8px }
        .progress-readout { font-size: 12px }
        footer .foot-wrap { flex-direction: column; text-align: center }
      }

      /* global loading spinner (for blocking global ops) */
      #loading-spinner {
        position: fixed;
        top: 50%; left: 50%; transform: translate(-50%, -50%);
        z-index: 140;
        display: none;
        color: var(--brand);
        font-size: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0) } 100% { transform: rotate(360deg) } }
      #loading-spinner.active { display: block }

      /* Scroll-to-top — raise z-index and robust visibility with scrollY */
      #scroll-to-top i { font-size: 20px }
      #scroll-to-top {
        position: fixed;
        width: 50px; height: 50px;
        background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
        color: #061220;
        bottom: 30px; right: 30px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; font-size: 22px; z-index: 160;
        border: 1px solid rgba(255,255,255,.12);
        -webkit-tap-highlight-color: transparent;
        transition: all .2s ease; transform: translateY(8px) scale(.95); opacity: 0; pointer-events: none;
      }
      #scroll-to-top.visible { pointer-events: auto; opacity: 1; transform: translateY(0) scale(1) }
      #scroll-to-top.visible:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 3px 12px rgba(34,211,238,.45), 0 0 14px rgba(167,139,250,.35) }
      #scroll-to-top.visible:active { transform: translateY(1px) scale(.93) }
      @media(max-width:600px){
        #scroll-to-top { height: 40px; width: 40px; font-size: 18px; right: calc(50vw - 20px); bottom: 18px }
      }

      .section-divider {
        border: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,.1), transparent); margin: 24px 0;
      }

      @media (max-width:var(--bp-mobile)) {
        .view-toggle .seg span { display: none }
        .view-toggle .seg { padding: 8px }
      }

      @media (prefers-reduced-motion:reduce) {
        * { transition: none !important; animation: none !important }
      }

      ::selection { background: #ec4899; color: #fff }
      ::-moz-selection { background: #ec4899; color: #fff }
      .highlight-pink::selection { background: #f472b6; color: #fff }
      @media (prefers-color-scheme:dark) {
        ::selection { background: #f472b6; color: #1a202c }
      }

      /* Skeleton loading */
      .skeleton-card {
        background: #12182a;
        border: 1px solid rgba(255, 255, 255, .08);
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(1, 5, 18, .5);
        display: flex; flex-direction: column;
        animation: pulse 1.5s infinite ease-in-out;
      }
      .skeleton-cover {
        width: 100%; height: 0; padding-bottom: 140%;
        background: linear-gradient(90deg, #0e1323 25%, #12182a 50%, #0e1323 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }
      .skeleton-body { padding: 8px; display: flex; flex-direction: column; gap: 6px }
      .skeleton-title { height: 1.2em; width: 80%; background: #1a2240; border-radius: 4px }
      .skeleton-chip { height: 1em; width: 60%; background: #1a2240; border-radius: 4px }
      .skeleton-controls { display: flex; gap: 6px }
      .skeleton-btn { height: 32px; width: 36px; background: #1a2240; border-radius: 8px }
      @keyframes pulse { 0% { opacity: 0.85 } 50% { opacity: 0.6 } 100% { opacity: 0.85 } }
      @keyframes shimmer { 0% { background-position: -200% 0 } 100% { background-position: 200% 0 } }

      /* Tabbed modal */
      .tab-group { display: flex; gap: 8px; margin-bottom: 12px }
      .tab-btn { flex: 1; padding: 8px; border-radius: 8px; background: #12182a; border: 1px solid rgba(255, 255, 255, .06); color: #c6cde0; cursor: pointer }
      .tab-btn.active { background: linear-gradient(90deg, rgba(124,58,237,.25), rgba(34,211,238,.2)); color: #fff }

      /* Account panel — redesigned */
      .account-panel {
        padding: 0;
        overflow: hidden;
      }
      .account-header {
        display: flex; align-items: center; gap: 12px;
        padding: 14px;
        background: linear-gradient(135deg, rgba(124,58,237,.22), rgba(34,211,238,.15));
        border-bottom: 1px solid rgba(255,255,255,.08);
      }
      .account-avatar {
        width: 44px; height: 44px; border-radius: 10px; background: #1a2240; display: flex; align-items: center; justify-content: center;
        font-weight: 900; font-family: var(--title-font); letter-spacing: .5px; color: #e9ecf3; border: 1px solid rgba(255,255,255,.15);
      }
      .account-id .name {
        font-family: var(--title-font); font-size: 15px; letter-spacing: .3px; color: #e9ecf3;
      }
      .account-id .email { font-size: 12px; color: #cbd3ea; opacity: .9 }
      .account-stats {
        display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; padding: 12px;
      }
      .stat-card {
        background: #12182a; border: 1px solid rgba(255,255,255,.08); border-radius: 12px; padding: 10px 12px;
      }
      .stat-label { font-size: 12px; color: #aab3cf; display:flex; gap:8px; align-items:center }
      .stat-value { font-size: 20px; font-weight: 800; color: #e9f0ff; margin-top: 2px }
      .stat-card.total .stat-value { color: var(--accent-2) }
      .stat-card.watch .stat-value { color: var(--accent-1) }
      .account-actions { padding: 12px; border-top: 1px solid rgba(255,255,255,.06) }

      /* Preloader (app-level) */
      .preloader {
        position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
        background: radial-gradient(1200px 600px at 50% 30%, rgba(124,58,237,.10), transparent 70%), rgba(7,8,12,.92);
        z-index: 200;
      }
      .preloader.active { display: flex }
      .preloader-inner {
        display: grid; gap: 14px; place-items: center; text-align: center; padding: 20px;
      }
      .preloader-logo {
        font-family: var(--title-font); font-weight: 900; letter-spacing: 1px; font-size: 20px; color: #e9ecf3;
      }
      .preloader-spinner {
        width: 38px; height: 38px; border-radius: 50%;
        border: 3px solid rgba(255,255,255,.2);
        border-top-color: #a78bfa;
        animation: spin 0.9s linear infinite;
        filter: drop-shadow(0 4px 12px rgba(167,139,250,.35));
      }
      .preloader-msg { color: #cbd5f7; font-size: 13px }
    </style>
  </head>
  <body>
    <!-- App preloader -->
    <div id="app-preloader" class="preloader" aria-hidden="true">
      <div class="preloader-inner">
        <div class="preloader-spinner" aria-hidden="true"></div>
        <div class="preloader-logo">AniMehList</div>
        <div id="preloader-msg" class="preloader-msg">Warming up the ramen…</div>
      </div>
    </div>

    <header class="header">
      <div class="container nav">
        <div class="logo">
          <img src="assets/wide_logo.png" alt="AniMehList" class="logo-img">
          <div class="nav-meta">
            <span class="tag" id="presence"><i class="fa-solid fa-circle" style="color:var(--ok);font-size:8px"></i><span id="presence-text">0 online</span></span>
          </div>
        </div>
        <div class="nav-cta" id="auth-cta"></div>
        <button class="btn icon hamburger" id="btn-menu" aria-haspopup="true" aria-expanded="false" aria-controls="mobile-menu" title="Menu"><i class="fa-solid fa-bars"></i></button>
      </div>

      <!-- Mobile menu -->
      <div class="menu-panel" id="mobile-menu" role="menu" aria-label="Navigation menu">
        <div class="menu-sec">
          <div class="menu-title">Status</div>
          <div class="menu-row"><span class="tag"><i class="fa-solid fa-circle" style="color:var(--ok);font-size:8px"></i><span id="m-presence-text">0 online</span></span></div>
        </div>
        <div class="menu-sec">
          <div class="menu-title">Quick actions</div>
          <div class="menu-row"><button class="btn brand" id="m-add"><i class="fa-solid fa-plus"></i>Add item</button></div>
        </div>
        <div class="menu-sec">
          <div class="menu-title">View</div>
          <div class="menu-row" role="group" aria-label="View toggle">
            <div class="menu-item">
              <div class="menu-kv"><i class="fa-solid fa-grip"></i>
              
              </div>
              <button class="btn ghost sm" id="m-view-grid">Use</button>
            </div>
            <div class="menu-item">
              <div class="menu-kv"><i class="fa-solid fa-list"></i>Shelf</div>
              <button class="btn ghost sm" id="m-view-compact">Use</button>
            </div>
          </div>
        </div>
        <div class="menu-sec">
          <div class="menu-title">Account</div>
          <div class="menu-row">
            <div class="menu-item" id="m-auth-row">
              <div class="menu-kv"><i class="fa-solid fa-user"></i><span id="m-user-email">Signed out</span></div>
              <button class="btn ghost sm" id="m-login"><i class="fa-solid fa-right-to-bracket"></i>Sign in</button>
              <button class="btn ghost sm hidden" id="m-logout"><i class="fa-solid fa-right-from-bracket"></i>Sign out</button>
            </div>
          </div>
        </div>
        <div class="menu-sec">
          <div class="menu-title">Data</div>
          <div class="menu-row">
            <button class="btn ghost sm" id="m-import"><i class="fa-solid fa-file-import"></i>Import JSON</button>
            <button class="btn ghost sm" id="m-export"><i class="fa-solid fa-file-export"></i>Export JSON</button>
            <div class="menu-note">Import/Export your list as JSON</div>
          </div>
        </div>
      </div>

      <!-- Account panel (redesigned) -->
      <div class="account-panel" id="account-panel" aria-label="Account panel">
        <div class="account-header">
          <div class="account-avatar" id="account-avatar">U</div>
          <div class="account-id">
            <div class="name" id="account-username"></div>
            <div class="email" id="account-email"></div>
          </div>
        </div>
        <div class="account-stats">
          <div class="stat-card total">
            <div class="stat-label"><i class="fa-solid fa-layer-group"></i> Total Items</div>
            <div class="stat-value" id="account-total">0</div>
          </div>
          <div class="stat-card watch">
            <div class="stat-label"><i class="fa-solid fa-eye"></i> Watching</div>
            <div class="stat-value" id="account-watching">0</div>
          </div>
        </div>
        <div class="account-actions">
          <button class="btn ghost sm" id="account-logout"><i class="fa-solid fa-right-from-bracket"></i>Sign out</button>
        </div>
      </div>
    </header>

    <section class="banner" aria-label="Featured">
      <div class="banner-image" id="banner-image" aria-hidden="true"></div>
      <div class="banner-inner">
        <div class="hero container">
          <div class="hero-box">
            <h1 id="hero-title">AniMehList — Anime Watchlist For The Bros</h1>
            <div class="sub">Fast. Private. Built for bros who binge and forget where they left off.</div>
          </div>
        </div>
      </div>
    </section>

    <main class="container" id="main">
      <div class="toolbar">
        <div class="toolbar-top">
          <div class="search-container">
            <input class="search" id="search" placeholder="Search title…" aria-label="Search titles (press / to focus)">
            <button class="search-clear" id="search-clear" aria-label="Clear search"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div class="actions-row">
            <button class="btn brand" id="btn-add"><i class="fa-solid fa-plus"></i>New</button>
          </div>
        </div>

        <div class="toolbar-tabs" id="tabs"></div>

        <!-- Sort (segmented) + View toggle to the right -->
        <div class="toolbar-top">
          <div id="sort-toggle" class="sort-toggle" role="group" aria-label="Sort by">
            <button class="seg" data-sort="recent" title="Newest"><i class="fa-solid fa-clock"></i></button>
            <button class="seg" data-sort="az" title="A–Z"><i class="fa-solid fa-arrow-down-a-z"></i></button>
            <button class="seg" data-sort="za" title="Z–A"><i class="fa-solid fa-arrow-down-z-a"></i></button>
          </div>
          <div class="view-toggle" role="group" aria-label="View mode">
            <button class="seg" id="view-btn-grid" aria-pressed="true" title="Grid"><i class="fa-solid fa-grip"></i></button>
            <button class="seg" id="view-btn-compact" aria-pressed="false" title="Shelf"><i class="fa-solid fa-list"></i></button>
          </div>
        </div>
      </div>

      <div id="empty" class="muted-small" style="display:none;margin:16px 0">Sign in to start your shelf.</div>
      <div id="sections"></div>
      <div class="grid" id="grid"></div>

      <div class="foot" style="margin:22px 0 30px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div class="muted small">Pro tip: press / to search. Click -1/+1 to adjust EP (Shift = ±5). Use the gear to edit, trash to delete.</div>
        <div class="right" style="display:flex;gap:8px;flex-wrap:wrap">
          <input type="file" id="import-file" accept="application/json" class="hidden">
          <button class="btn ghost small" id="btn-import"><i class="fa-solid fa-file-import"></i>Import JSON</button>
          <button class="btn ghost small" id="btn-export"><i class="fa-solid fa-file-export"></i>Export JSON</button>
          <button class="btn ghost small" id="btn-refresh-covers"><i class="fa-solid fa-sync"></i>Refresh covers</button>
        </div>
      </div>
    </main>

    <!-- Add/Edit Modal -->
    <div class="modal" id="modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="sheet" role="document">
        <h3 id="modal-title"><i class="fa-solid fa-pen-to-square"></i>Add item</h3>
        <div class="form">
          <div class="row">
            <div class="float-group input-wrapper">
              <input id="f-title" class="input" aria-label="Title">
              <label for="f-title">Title</label>
              <button class="clear-btn" id="clear-title" aria-label="Clear title"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
          <div class="row">
            <div class="input-wrapper">
              <select id="f-kind" class="select" aria-label="Kind">
                <option value="" disabled selected>Series/Movie</option>
                <option value="SERIES">Series</option>
                <option value="MOVIE">Movie</option>
              </select>
            </div>
            <div class="input-wrapper">
              <select id="f-status" class="select" aria-label="Status">
                <option value="" disabled selected>Category</option>
                <option>WATCHING</option>
                <option>PLAN</option>
                <option>REWATCH</option>
                <option>WAITING</option>
                <option>COMPLETED</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="float-group input-wrapper">
              <input type="number" id="f-season" class="input" inputmode="numeric" aria-label="Season number">
              <label for="f-season">Season #</label>
              <button class="clear-btn" id="clear-season" aria-label="Clear season"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="float-group input-wrapper">
              <input type="number" id="f-episode" class="input" inputmode="numeric" aria-label="Episode number">
              <label for="f-episode">Episode #</label>
              <button class="clear-btn" id="clear-episode" aria-label="Clear episode"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="float-group input-wrapper">
              <input type="number" id="f-abs" class="input" inputmode="numeric" aria-label="Absolute episode number">
              <label for="f-abs">Absolute EP #</label>
              <button class="clear-btn" id="clear-abs" aria-label="Clear absolute episode"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
          <div class="row img-row" style="align-items:center">
            <div class="float-group input-wrapper">
              <input id="f-image" class="input" aria-label="Image URL">
              <label for="f-image">Cover URL</label>
              <button class="clear-btn" id="clear-image" aria-label="Clear image URL"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <button class="btn ghost" id="btn-autocover" title="Auto fetch cover by title"><i class="fa-solid fa-wand-magic-sparkles"></i>Auto cover</button>
          </div>
          <div class="row">
            <div class="float-group input-wrapper">
              <input id="f-notes" class="input" aria-label="Notes">
              <label for="f-notes">Notes (optional)</label>
              <button class="clear-btn" id="clear-notes" aria-label="Clear notes"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
          <div class="row">
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn brand" id="btn-save"><i class="fa-solid fa-floppy-disk"></i>Save</button>
              <button class="btn ghost" id="btn-cancel"><i class="fa-solid fa-xmark"></i>Cancel</button>
            </div>
            <div style="margin-left:auto">
              <button class="btn danger" id="btn-delete" style="display:none"><i class="fa-solid fa-trash"></i>Delete</button>
            </div>
          </div>
          <div class="hint">Auto cover uses AniList first and falls back to Jikan. If your DB lacks image_url, we store covers locally.</div>
        </div>
      </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal" id="auth-modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="sheet" role="document" style="max-width:560px">
        <h3 style="display:flex;align-items:center;gap:10px"><i class="fa-solid fa-right-to-bracket"></i>Account</h3>
        <div class="tab-group">
          <button class="tab-btn active" id="tab-signin">Sign In</button>
          <button class="tab-btn" id="tab-signup">Sign Up</button>
        </div>
        <div class="form" id="signin-form">
          <div class="row">
            <div class="float-group input-wrapper">
              <input id="login-identifier" class="input" aria-label="Username or email">
              <label for="login-identifier">Username or email</label>
            </div>
          </div>
          <div class="row">
            <div class="float-group input-wrapper">
              <input id="login-password" class="input" type="password" aria-label="Password">
              <label for="login-password">Password</label>
            </div>
          </div>
          <div class="row"><button class="btn brand" id="login-send"><i class="fa-solid fa-right-to-bracket"></i>Sign in</button><button class="btn ghost" id="auth-cancel"><i class="fa-solid fa-xmark"></i>Close</button></div>
        </div>
        <div class="form hidden" id="signup-form">
          <div class="row">
            <div class="float-group input-wrapper"><input id="signup-username" class="input" aria-label="Username"><label for="signup-username">Username</label></div>
          </div>
          <div class="row">
            <div class="float-group input-wrapper"><input id="signup-email" class="input" type="email" aria-label="Email"><label for="signup-email">Email</label></div>
          </div>
          <div class="row">
            <div class="float-group input-wrapper"><input id="signup-password" class="input" type="password" aria-label="Password"><label for="signup-password">Password</label></div>
          </div>
          <div class="row"><button class="btn brand" id="signup-send"><i class="fa-solid fa-user-plus"></i>Sign up</button><button class="btn ghost" id="auth-cancel"><i class="fa-solid fa-xmark"></i>Cancel</button></div>
        </div>
      </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal" id="confirm-modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="sheet center" style="max-width:520px">
        <div style="width:100%">
          <h3 id="confirm-title"><i class="fa-solid fa-triangle-exclamation"></i>Confirm</h3>
          <p id="confirm-msg" class="muted-small">Are you sure?</p>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button class="btn ghost" id="confirm-cancel"><i class="fa-solid fa-xmark"></i>Cancel</button>
            <button class="btn danger" id="confirm-ok"><i class="fa-solid fa-check"></i>Yes, do it</button>
          </div>
        </div>
      </div>
    </div>

    <div id="toasts" aria-live="polite"></div>
    <div id="loading-spinner" aria-label="Loading"><i class="fa-solid fa-spinner"></i></div>
    <button id="scroll-to-top" aria-label="Scroll to top"><i class="fa-solid fa-arrow-up"></i></button>

    <footer>
      <div class="container foot-wrap">
        <div style="display:flex;align-items:center;gap:10px">
          <i class="fa-solid fa-layer-group" style="opacity:.7"></i>
          <div style="font-family:var(--title-font)">AniMehList</div>
        </div>
        <div class="muted-small">Made with chaos & ramen. © AniMehList</div>
      </div>
    </footer>

    <script type="module">
      // Supabase (unchanged)
      const SUPABASE_URL = 'https://odvbznpmrorgdaaqjkrf.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kdmJ6bnBtcm9yZ2RhYXFqa3JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1OTc5MjgsImV4cCI6MjA3NTE3MzkyOH0.5-fC1TmZTlGwHzsLJSxo0pTIdcbJm0_cOehoILdd31w';
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // State
      const STATUSES = ['WATCHING', 'PLAN', 'REWATCH', 'WAITING', 'COMPLETED'];
      const TABS = [
        { id: 'ALL', label: 'All' },
        { id: 'WATCHING', label: 'Watching' },
        { id: 'PLAN', label: 'Plan to watch' },
        { id: 'REWATCH', label: 'Rewatch' },
        { id: 'WAITING', label: 'Waiting' },
        { id: 'COMPLETED_SERIES', label: 'Completed (Series)' },
        { id: 'COMPLETED_MOVIES', label: 'Completed (Movies)' },
      ];
      let session = null;
      let user = null;
      let data = [];
      let activeTab = 'ALL';
      let q = '';
      let viewMode = 'grid';     // 'grid' | 'compact'
      let sortMode = 'recent';   // 'recent' | 'az' | 'za'
      const IMG_LOCAL_PREFIX = 'anibros_images:';

      // Elements
      const sectionsEl = document.getElementById('sections');
      const gridEl = document.getElementById('grid');
      const tabsEl = document.getElementById('tabs');
      const searchEl = document.getElementById('search');
      const searchClear = document.getElementById('search-clear');
      const btnAdd = document.getElementById('btn-add');
      const authCta = document.getElementById('auth-cta');
      const bannerImage = document.getElementById('banner-image');
      const presenceText = document.getElementById('presence-text');
      const mPresenceText = document.getElementById('m-presence-text');
      const emptyEl = document.getElementById('empty');
      const loadingSpinner = document.getElementById('loading-spinner');
      const btnRefreshCovers = document.getElementById('btn-refresh-covers');

      // View toggle + sort segmented
      const viewBtnGrid = document.getElementById('view-btn-grid');
      const viewBtnCompact = document.getElementById('view-btn-compact');
      const sortToggle = document.getElementById('sort-toggle');

      // Mobile menu
      const menuBtn = document.getElementById('btn-menu');
      const mobileMenu = document.getElementById('mobile-menu');
      const mAdd = document.getElementById('m-add');
      const mViewGrid = document.getElementById('m-view-grid');
      const mViewCompact = document.getElementById('m-view-compact');
      const mLogin = document.getElementById('m-login');
      const mLogout = document.getElementById('m-logout');
      const mUserEmail = document.getElementById('m-user-email');
      const mImport = document.getElementById('m-import');
      const mExport = document.getElementById('m-export');

      // Account panel
      const accountPanel = document.getElementById('account-panel');
      const accountUsername = document.getElementById('account-username');
      const accountEmail = document.getElementById('account-email');
      const accountTotal = document.getElementById('account-total');
      const accountWatching = document.getElementById('account-watching');
      const accountLogout = document.getElementById('account-logout');
      const accountAvatar = document.getElementById('account-avatar');

      // Add/Edit modal
      const modal = document.getElementById('modal');
      const mTitle = document.getElementById('modal-title');
      const fTitle = document.getElementById('f-title');
      const fKind = document.getElementById('f-kind');
      const fStatus = document.getElementById('f-status');
      const fSeason = document.getElementById('f-season');
      const fEpisode = document.getElementById('f-episode');
      const fAbs = document.getElementById('f-abs');
      const fImage = document.getElementById('f-image');
      const fNotes = document.getElementById('f-notes');
      const btnSave = document.getElementById('btn-save');
      const btnCancel = document.getElementById('btn-cancel');
      const btnDelete = document.getElementById('btn-delete');
      const btnAutoCover = document.getElementById('btn-autocover');

      // Auth modal
      const authModal = document.getElementById('auth-modal');
      const tabSignin = document.getElementById('tab-signin');
      const tabSignup = document.getElementById('tab-signup');
      const signinForm = document.getElementById('signin-form');
      const signupForm = document.getElementById('signup-form');
      const loginIdentifier = document.getElementById('login-identifier');
      const loginPassword = document.getElementById('login-password');
      const loginSend = document.getElementById('login-send');
      const signupUsername = document.getElementById('signup-username');
      const signupEmail = document.getElementById('signup-email');
      const signupPassword = document.getElementById('signup-password');
      const signupSend = document.getElementById('signup-send');
      const authCancel = document.getElementById('auth-cancel');

      // Confirm modal
      const confirmModal = document.getElementById('confirm-modal');
      const confirmTitle = document.getElementById('confirm-title');
      const confirmMsg = document.getElementById('confirm-msg');
      const confirmOk = document.getElementById('confirm-ok');
      const confirmCancel = document.getElementById('confirm-cancel');

      const toasts = document.getElementById('toasts');

      // Import/Export
      const btnExport = document.getElementById('btn-export');
      const btnImport = document.getElementById('btn-import');
      const importFile = document.getElementById('import-file');

      // Clear buttons
      const clearTitle = document.getElementById('clear-title');
      const clearSeason = document.getElementById('clear-season');
      const clearEpisode = document.getElementById('clear-episode');
      const clearAbs = document.getElementById('clear-abs');
      const clearImage = document.getElementById('clear-image');
      const clearNotes = document.getElementById('clear-notes');

      // Scroll to top
      const scrollToTop = document.getElementById('scroll-to-top');

      // Preloader
      const appPreloader = document.getElementById('app-preloader');
      const preloaderMsg = document.getElementById('preloader-msg');

      let editingId = null;
      let changesChannel = null;
      let presenceChannel = null;

      // --- Helpers ---
      function showToast(type, msg, ms = 4200) {
        const t = document.createElement('div');
        t.className = 'toast ' + (type || 'info');
        const icon = type === 'success' ? 'fa-circle-check' : type === 'error' ? 'fa-triangle-exclamation' : 'fa-circle-info';
        t.innerHTML = `<i class="fa-solid ${icon}"></i><div class="msg">${escapeHtml(msg)}</div>`;
        toasts.appendChild(t);
        requestAnimationFrame(() => t.classList.add('enter'));
        setTimeout(() => { t.classList.remove('enter'); t.classList.add('exit'); }, Math.max(1200, ms - 260));
        setTimeout(() => { t.remove(); }, ms);
        return t;
      }
      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]);
      }
      function showLoading(show = true) {
        loadingSpinner.classList.toggle('active', show);
      }

      // Preloader control
      function showPreloader(message = '') {
        if (message) preloaderMsg.textContent = message;
        appPreloader.classList.add('active');
        appPreloader.setAttribute('aria-hidden', 'false');
      }
      function updatePreloader(message = '') {
        if (message) preloaderMsg.textContent = message;
      }
      function hidePreloader() {
        appPreloader.classList.remove('active');
        appPreloader.setAttribute('aria-hidden', 'true');
      }

      function openModal(el) {
        el.classList.add('open');
        el.setAttribute('aria-hidden', 'false');
        trapFocus(el);
        document.body.classList.add('modal-open');
      }
      function closeModal(el) {
        el.classList.remove('open');
        el.setAttribute('aria-hidden', 'true');
        releaseFocus();
        if (!document.querySelector('.modal.open')) document.body.classList.remove('modal-open');
      }

      // focus-trap (basic)
      let lastFocused = null;
      function trapFocus(modalEl) {
        lastFocused = document.activeElement;
        const focusable = modalEl.querySelectorAll('button, a, input, select, textarea');
        if (focusable[0]) focusable[0].focus();
        document.addEventListener('keydown', onKeyDownModal);
      }
      function releaseFocus() {
        document.removeEventListener('keydown', onKeyDownModal);
        if (lastFocused) lastFocused.focus();
      }
      function onKeyDownModal(e) {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal.open').forEach(m => closeModal(m));
        }
      }

      // confirmModal callback pattern
      let confirmCallback = null;
      function openConfirm(title, message, onOk) {
        confirmTitle.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ${escapeHtml(title || 'Confirm')}`;
        confirmMsg.textContent = message || 'Are you sure?';
        confirmCallback = onOk;
        openModal(confirmModal);
      }
      confirmOk.onclick = async () => {
        closeModal(confirmModal);
        if (confirmCallback) {
          try { await confirmCallback(); }
          catch (e) { console.error(e); showToast('error', e.message || 'Error'); }
          confirmCallback = null;
        }
      };
      confirmCancel.onclick = () => { confirmCallback = null; closeModal(confirmModal); };

      function setRandomBanner() {
        const n = Math.floor(Math.random() * 10) + 1;
        bannerImage.style.backgroundImage = `url('assets/banner-${n}.png')`;
        bannerImage.style.opacity = '1';
      }

      function chipEl(text) {
        const s = document.createElement('span');
        s.className = 'chip';
        s.textContent = text;
        return s;
      }

      function formatProgress(row) {
        if (row.absolute_episode != null) return `EP ${row.absolute_episode}`;
        const se = [];
        if (row.season != null) se.push('S' + row.season);
        if (row.episode != null) se.push('EP ' + row.episode);
        return se.join(' ') || 'EP 0';
      }
      function progressBadgeText(row) {
        if (row.absolute_episode != null) return `EP ${row.absolute_episode}`;
        if (row.season != null || row.episode != null) return `${row.season ? 'S' + row.season + ' ' : ''}${row.episode ? 'EP ' + row.episode : ''}`.trim();
        return 'EP 0';
      }
      function initials(title) {
        const parts = String(title).trim().toUpperCase().split(/\s+/).slice(0, 2);
        return parts.map(p => p[0]).join('');
      }

      function getLocalImgMap() {
        if (!user) return {};
        try { return JSON.parse(localStorage.getItem(IMG_LOCAL_PREFIX + user.id) || '{}'); }
        catch { return {}; }
      }
      function setLocalImage(id, url) {
        if (!user) return;
        const map = getLocalImgMap();
        map[id] = url || '';
        localStorage.setItem(IMG_LOCAL_PREFIX + user.id, JSON.stringify(map));
      }
      function getLocalImage(id) {
        const map = getLocalImgMap();
        return map[id] || '';
      }
      function attachLocalImages(rows) {
        const map = getLocalImgMap();
        rows.forEach(r => { if (!r.image_url && map[r.id]) r.image_url = map[r.id]; });
        return rows;
      }

      // Tabs
      function renderTabs() {
        tabsEl.innerHTML = '';
        TABS.forEach(t => {
          const b = document.createElement('button');
          b.className = 'tab' + (activeTab === t.id ? ' active' : '');
          b.innerHTML = `${t.label} <span class="count">${countBadge(t.id)}</span>`;
          b.onclick = () => { activeTab = t.id; updateURL(); render(); };
          tabsEl.appendChild(b);
        });
      }
      function countBadge(tabId) {
        if (tabId === 'ALL') return data.length;
        if (tabId === 'COMPLETED_SERIES') return data.filter(d => d.status === 'COMPLETED' && d.kind === 'SERIES').length;
        if (tabId === 'COMPLETED_MOVIES') return data.filter(d => d.status === 'COMPLETED' && d.kind === 'MOVIE').length;
        return data.filter(d => d.status === tabId).length;
      }

      function filtered() {
        let rows = data.slice();
        if (activeTab !== 'ALL') {
          if (activeTab === 'COMPLETED_SERIES') rows = rows.filter(r => r.status === 'COMPLETED' && r.kind === 'SERIES');
          else if (activeTab === 'COMPLETED_MOVIES') rows = rows.filter(r => r.status === 'COMPLETED' && r.kind === 'MOVIE');
          else rows = rows.filter(r => r.status === activeTab);
        }
        if (q) rows = rows.filter(r => r.title.toLowerCase().includes(q));

        // Sorting
        if (sortMode === 'az') rows.sort((a, b) => a.title.localeCompare(b.title));
        else if (sortMode === 'za') rows.sort((a, b) => b.title.localeCompare(a.title));
        else rows.sort((a, b) => (b.created_at?.localeCompare?.(a.created_at)) || 0);

        return rows;
      }

      function makeGridCard(row) {
        const col = document.createElement('div');
        col.className = 'col';

        const card = document.createElement('div');
        card.className = 'card';

        // Cover
        const cover = document.createElement('div');
        cover.className = 'cover';

        const loader = document.createElement('div');
        loader.className = 'cover-loader';
        loader.innerHTML = '<i class="fa-solid fa-spinner"></i>';

        const imgUrl = row.image_url || '';
        const img = document.createElement('img');
        img.alt = `Cover for ${row.title || 'anime'}`;
        img.loading = 'lazy';
        let hasImg = !!imgUrl;
        if (hasImg) img.src = imgUrl;

        const ph = document.createElement('div');
        ph.className = 'ph';
        ph.textContent = initials(row.title || '');
        ph.style.display = hasImg ? 'none' : 'flex';

        img.onload = () => { loader.remove(); ph.style.display = 'none'; };
        img.onerror = () => { ph.style.display = 'flex'; loader.remove(); img.remove(); };

        cover.appendChild(ph);
        cover.appendChild(loader);
        if (hasImg) cover.appendChild(img);

        // Floating actions
        const float = document.createElement('div');
        float.className = 'floating-actions';
        const editBtn = document.createElement('button');
        editBtn.className = 'icon-btn';
        editBtn.title = 'Edit';
        editBtn.setAttribute('aria-label', 'Edit entry');
        editBtn.innerHTML = '<i class="fa-solid fa-gear"></i>';
        editBtn.onclick = () => openModalFor(row);
        float.append(editBtn);
        cover.appendChild(float);

        // bottom progress badge
        const badge = document.createElement('div');
        badge.className = 'badge-bottom';
        badge.innerHTML = `<i class="fa-solid fa-film"></i> ${progressBadgeText(row)}`;
        cover.appendChild(badge);

        // Body
        const body = document.createElement('div');
        body.className = 'card-body';

        const titleRow = document.createElement('div');
        titleRow.className = 'title-row';
        const t = document.createElement('div');
        t.className = 'title';
        t.textContent = row.title;
        titleRow.append(t);

        const chips = document.createElement('div');
        chips.className = 'chips';
        chips.appendChild(chipEl(row.kind === 'MOVIE' ? 'Movie' : 'Series'));
        const fmt = formatProgress(row);
        if (fmt) chips.appendChild(chipEl(fmt));

        const controls = buildControls(row);

        body.append(titleRow, chips, controls);
        card.append(cover, body);
        col.appendChild(card);
        return col;
      }

      function makeCompactCard(row) {
        const col = document.createElement('div');
        col.className = 'col';

        const card = document.createElement('div');
        card.className = 'card row'; // horizontal

        // Cover
        const cover = document.createElement('div');
        cover.className = 'cover';

        const loader = document.createElement('div');
        loader.className = 'cover-loader';
        loader.innerHTML = '<i class="fa-solid fa-spinner"></i>';

        const imgUrl = row.image_url || '';
        const img = document.createElement('img');
        img.alt = `Thumbnail for ${row.title || 'anime'}`;
        img.loading = 'lazy';
        let hasImg = !!imgUrl;
        if (hasImg) img.src = imgUrl;

        const ph = document.createElement('div');
        ph.className = 'ph';
        ph.textContent = initials(row.title || '');
        ph.style.display = hasImg ? 'none' : 'flex';

        img.onload = () => { loader.remove(); ph.style.display = 'none'; };
        img.onerror = () => { ph.style.display = 'flex'; loader.remove(); img.remove(); };

        cover.appendChild(ph);
        cover.appendChild(loader);
        if (hasImg) cover.appendChild(img);

        // Floating actions (now visible)
        const float = document.createElement('div');
        float.className = 'floating-actions';
        const editBtn = document.createElement('button');
        editBtn.className = 'icon-btn';
        editBtn.title = 'Edit';
        editBtn.setAttribute('aria-label', 'Edit entry');
        editBtn.innerHTML = '<i class="fa-solid fa-gear"></i>';
        editBtn.onclick = () => openModalFor(row);
        float.append(editBtn);

        // Body
        const body = document.createElement('div');
        body.className = 'card-body';

        const titleRow = document.createElement('div');
        titleRow.className = 'title-row';
        const t = document.createElement('div');
        t.className = 'title';
        t.textContent = row.title;

        titleRow.append(t);

        const meta = document.createElement('div');
        meta.className = 'chips';
        meta.appendChild(chipEl(row.kind === 'MOVIE' ? 'Movie' : 'Series'));
        meta.appendChild(chipEl(progressBadgeText(row)));

        const controls = buildControls(row);

        body.append(titleRow, meta, controls);
        card.append(cover, body, float);
        col.appendChild(card);
        return col;
      }

      function buildControls(row) {
        const controls = document.createElement('div');
        controls.className = 'controls';

        const dec = document.createElement('button');
        dec.className = 'control-btn';
        dec.title = '-1 episode';
        dec.setAttribute('aria-label', 'Decrease episode');
        dec.innerHTML = '<i class="fa-solid fa-minus"></i>';
        dec.onclick = (e) => adjustEpisode(row, e.shiftKey ? -5 : -1);

        const prog = document.createElement('div');
        prog.className = 'progress-readout';
        prog.innerHTML = `<i class="fa-solid fa-tv"></i> <span>${progressBadgeText(row)}</span>`;

        const inc = document.createElement('button');
        inc.className = 'control-btn';
        inc.title = '+1 episode';
        inc.setAttribute('aria-label', 'Increase episode');
        inc.innerHTML = '<i class="fa-solid fa-plus"></i>';
        inc.onclick = (e) => adjustEpisode(row, e.shiftKey ? +5 : +1);

        const move = document.createElement('select');
        move.className = 'move-select';
        move.setAttribute('aria-label', 'Move to list');
        move.innerHTML = STATUSES.map(s => `<option ${row.status === s ? 'selected' : ''}>${s}</option>`).join('');
        move.onchange = async (e) => {
          try {
            const { error } = await supabase.from('entries').update({ status: e.target.value }).eq('id', row.id);
            if (error) throw error;
            showToast('success', 'Moved to ' + e.target.value);
          } catch (e) {
            showToast('error', e.message || 'Failed');
          }
        };

        controls.append(dec, prog, inc, move);
        return controls;
      }

      function renderSkeletons(count = 6) {
        gridEl.innerHTML = '';
        sectionsEl.innerHTML = '';
        const gridClass = viewMode === 'compact' ? 'grid view-compact' : 'grid view-grid';
        gridEl.className = gridClass;
        for (let i = 0; i < count; i++) {
          const col = document.createElement('div'); col.className = 'col';
          const card = document.createElement('div'); card.className = 'skeleton-card';
          const cover = document.createElement('div'); cover.className = 'skeleton-cover';
          const body = document.createElement('div'); body.className = 'skeleton-body';
          const title = document.createElement('div'); title.className = 'skeleton-title';
          const chip = document.createElement('div'); chip.className = 'skeleton-chip';
          const controls = document.createElement('div'); controls.className = 'skeleton-controls';
          for (let j = 0; j < 3; j++) {
            const btn = document.createElement('div'); btn.className = 'skeleton-btn';
            controls.appendChild(btn);
          }
          body.append(title, chip, controls);
          card.append(cover, body);
          col.append(card);
          gridEl.append(col);
        }
      }

      let renderDebounce = null;
      function render() {
        if (renderDebounce) clearTimeout(renderDebounce);
        renderDebounce = setTimeout(() => {
          renderTabs();
          sectionsEl.innerHTML = '';
          gridEl.innerHTML = '';

          if (!user) {
            emptyEl.style.display = '';
            return;
          } else {
            emptyEl.style.display = 'none';
          }

          const renderItem = viewMode === 'compact' ? makeCompactCard : makeGridCard;
          const gridClass = viewMode === 'compact' ? 'grid view-compact' : 'grid view-grid';

          if (activeTab === 'ALL') {
            const groups = [
              { id: 'WATCHING', label: 'Watching', icon: 'fa-eye' },
              { id: 'PLAN', label: 'Plan to watch', icon: 'fa-list-check' },
              { id: 'REWATCH', label: 'Rewatch', icon: 'fa-rotate-left' },
              { id: 'WAITING', label: 'Waiting', icon: 'fa-hourglass-half' },
              { id: 'COMPLETED', label: 'Completed', icon: 'fa-check-double' },
            ];
            groups.forEach(g => {
              let rows = data.filter(r => r.status === g.id);
              if (q) rows = rows.filter(r => r.title.toLowerCase().includes(q));

              if (sortMode === 'az') rows.sort((a, b) => a.title.localeCompare(b.title));
              else if (sortMode === 'za') rows.sort((a, b) => b.title.localeCompare(a.title));
              else rows.sort((a, b) => (b.created_at?.localeCompare?.(a.created_at)) || 0);

              if (!rows.length) return;

              const section = document.createElement('div');
              section.className = 'section';

              const h = document.createElement('div');
              h.className = 'section-title';
              h.innerHTML = `<i class="fa-solid ${g.icon}"></i> ${g.label} <span class="muted-small">(${rows.length})</span>`;
              section.appendChild(h);

              const grid = document.createElement('div');
              grid.className = gridClass;
              rows.forEach(row => grid.appendChild(renderItem(row)));

              section.appendChild(grid);
              sectionsEl.appendChild(section);

              if (g !== groups[groups.length - 1]) {
                const hr = document.createElement('hr');
                hr.className = 'section-divider';
                sectionsEl.appendChild(hr);
              }
            });
          } else {
            gridEl.className = gridClass;
            filtered().forEach(row => gridEl.appendChild(renderItem(row)));
          }

          updateViewToggleUI();
          updateSortToggleUI();
          updateMobileMenuUI();
          updateAccountUI();
        }, 80);
      }

      async function adjustEpisode(row, delta) {
        const patch = {};
        if (row.absolute_episode != null) {
          const next = Math.max(0, (row.absolute_episode || 0) + delta);
          patch.absolute_episode = next;
        } else {
          const next = Math.max(0, (row.episode || 0) + delta);
          patch.episode = next;
        }
        try {
          const { error } = await supabase.from('entries').update(patch).eq('id', row.id);
          if (error) throw error;
          showToast('success', `${delta > 0 ? `+${delta}` : delta} EP`);
        } catch (e) {
          showToast('error', e.message || 'Failed to update');
        }
      }

      // Auth UI
      function updateAuthUI() {
        authCta.innerHTML = '';
        if (user) {
          const btn = document.createElement('button');
          btn.className = 'btn ghost';
          btn.id = 'btn-account';
          btn.innerHTML = '<i class="fa-solid fa-user"></i> Account';
          btn.onclick = () => {
            if (accountPanel.classList.contains('open')) accountPanel.classList.remove('open');
            else accountPanel.classList.add('open');
          };
          authCta.append(btn);
          updateAccountUI();
        } else {
          const btn = document.createElement('button');
          btn.className = 'btn ghost';
          btn.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i> Sign in';
          btn.onclick = () => openModal(authModal);
          authCta.append(btn);
        }
        updateMobileMenuUI();
      }

      function updateAccountUI() {
        if (user) {
          const name = user.user_metadata?.username || 'Unknown';
          accountUsername.textContent = name;
          accountEmail.textContent = user.email || 'Unknown';
          accountTotal.textContent = data.length;
          accountWatching.textContent = data.filter(d => d.status === 'WATCHING').length;
          accountAvatar.textContent = (name?.[0] || 'U').toString().toUpperCase();
        }
      }

      // Data load
      async function load() {
        if (!user) return;
        renderSkeletons(8);
        showLoading(true);
        updatePreloader('Loading your shelf…');
        try {
          const { data: rows, error } = await supabase.from('entries').select('*').order('created_at', { ascending: false });
          if (error) throw error;
          data = attachLocalImages(rows || []);
          await autoFetchMissingCovers(data);
          render();
        } catch (e) {
          console.error(e);
          showToast('error', e.message || 'Failed to load');
        } finally {
          showLoading(false);
          hidePreloader();
        }
      }

      // Realtime
      function setupRealtime() {
        if (changesChannel) supabase.removeChannel(changesChannel);
        changesChannel = supabase.channel('entries-db').on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'entries', filter: `user_id=eq.${user.id}` },
          (payload) => {
            const { eventType, new: n, old: o } = payload;
            if (eventType === 'INSERT') {
              const row = attachLocalImages([n])[0];
              data.unshift(row);
              autoFetchMissingCovers([row]);
            } else if (eventType === 'UPDATE') {
              const i = data.findIndex(r => r.id === n.id);
              if (i >= 0) data[i] = attachLocalImages([n])[0];
            } else if (eventType === 'DELETE') {
              const i = data.findIndex(r => r.id === o.id);
              if (i >= 0) data.splice(i, 1);
            }
            render();
          }
        ).subscribe();
      }

      // Presence
      function setupPresence() {
        if (presenceChannel) supabase.removeChannel(presenceChannel);
        presenceChannel = supabase.channel('room:lobby', { config: { presence: { key: user.id } } });
        presenceChannel.on('presence', { event: 'sync' }, () => {
          const state = presenceChannel.presenceState();
          const all = new Set();
          Object.values(state).forEach(arr => arr.forEach(v => all.add(v.presence_ref)));
          presenceText.textContent = `${all.size} online`;
          mPresenceText.textContent = `${all.size} online`;
        });
        presenceChannel.subscribe(async status => {
          if (status === 'SUBSCRIBED') { await presenceChannel.track({ at: Date.now() }); }
        });
      }

      // Add / Edit modal wiring
      btnAdd.onclick = () => openModalFor();
      btnCancel.onclick = closeModalMain;
      btnSave.onclick = saveModal;
      btnDelete.onclick = removeModal;

      function setFloatGroupState(el) {
        const input = el.querySelector('input, textarea');
        if (!input) return;
        el.classList.toggle('filled', !!String(input.value ?? '').trim());
      }
      function initFloatingLabels(scope = document) {
        const groups = scope.querySelectorAll('.float-group');
        groups.forEach(g => {
          const input = g.querySelector('input, textarea');
          if (!input) return;
          const update = () => setFloatGroupState(g);
          input.addEventListener('input', update);
          input.addEventListener('blur', update);
          input.addEventListener('focus', () => g.classList.add('filled'));
          update();
        });
      }

      function openModalFor(row) {
        editingId = row?.id || null;
        mTitle.innerHTML = `<i class="fa-solid fa-pen-to-square"></i> ${editingId ? 'Edit item' : 'Add item'}`;
        fTitle.value = row?.title || '';
        fKind.value = row?.kind || '';
        fStatus.value = row?.status || '';
        fSeason.value = row?.season ?? '';
        fEpisode.value = row?.episode ?? '';
        fAbs.value = row?.absolute_episode ?? '';
        fImage.value = row?.image_url || getLocalImage(row?.id) || '';
        fNotes.value = row?.notes || '';
        btnDelete.style.display = editingId ? '' : 'none';
        openModal(modal);
        fTitle.focus();
        toggleClearButtons();
        initFloatingLabels(modal);
      }
      function closeModalMain() { closeModal(modal); }

      async function saveModal() {
        if (!user) return showToast('error', 'Sign in first');
        const row = {
          title: fTitle.value.trim(),
          kind: fKind.value,
          status: fStatus.value,
          season: fSeason.value ? parseInt(fSeason.value) : null,
          episode: fEpisode.value ? parseInt(fEpisode.value) : null,
          absolute_episode: fAbs.value ? parseInt(fAbs.value) : null,
          image_url: fImage.value.trim() || null,
          notes: fNotes.value.trim() || null,
          user_id: user.id
        };
        if (!row.title) return showToast('error', 'Title required');

        try {
          if (editingId) {
            await upsertEntry('update', row, editingId);
            showToast('success', 'Saved');
          } else {
            await upsertEntry('insert', row);
            showToast('success', 'Added');
          }
          closeModal(modal);
        } catch (e) {
          showToast('error', e.message || 'Failed to save');
        }
      }

      async function upsertEntry(mode, row, id) {
        const payload = { ...row };
        if (!payload.image_url) delete payload.image_url;
        try {
          if (mode === 'insert') {
            const { data: ins, error } = await supabase.from('entries').insert(payload).select().single();
            if (error) throw error;
            const newId = ins?.id;
            if (row.image_url && newId) setLocalImage(newId, row.image_url);
            return ins;
          } else {
            const { data: upd, error } = await supabase.from('entries').update(payload).eq('id', id).select().single();
            if (error) throw error;
            if (row.image_url) setLocalImage(id, row.image_url);
            return upd;
          }
        } catch (e) {
          const msg = String(e?.message || '');
          if (msg.includes('image_url') || (msg.toLowerCase().includes('column') && msg.toLowerCase().includes('does not exist'))) {
            const retry = { ...row }; delete retry.image_url;
            if (mode === 'insert') {
              const { data: ins2, error: err2 } = await supabase.from('entries').insert(retry).select().single();
              if (err2) throw err2;
              if (row.image_url && ins2?.id) setLocalImage(ins2.id, row.image_url);
              return ins2;
            } else {
              const { data: upd2, error: err2 } = await supabase.from('entries').update(retry).eq('id', id).select().single();
              if (err2) throw err2;
              if (row.image_url) setLocalImage(id, row.image_url);
              return upd2;
            }
          } else {
            throw e;
          }
        }
      }

      async function removeModal() {
        if (!editingId) return;
        try {
          const { error } = await supabase.from('entries').delete().eq('id', editingId);
          if (error) throw error;
          showToast('success', 'Deleted');
          closeModal(modal);
        } catch (e) {
          showToast('error', e.message || 'Failed to delete');
        }
      }

      // Search (debounced)
      let searchTimer;
      searchEl.oninput = () => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => {
          q = searchEl.value.trim().toLowerCase();
          updateURL();
          render();
          toggleSearchClear();
        }, 120);
      };
      function toggleSearchClear() {
        searchClear.classList.toggle('visible', searchEl.value.trim() !== '');
      }
      searchClear.onclick = () => {
        searchEl.value = '';
        q = '';
        updateURL();
        render();
        toggleSearchClear();
        searchEl.focus();
      };

      // Export
      btnExport.onclick = doExport;
      function doExport() {
        const rows = data.map(({ id, user_id, created_at, updated_at, ...rest }) => rest);
        const blob = new Blob([JSON.stringify(rows, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'anibros-export.json'; a.click();
        URL.revokeObjectURL(url);
        showToast('success', 'Exported');
      }

      // Import
      btnImport.onclick = () => importFile.click();
      importFile.addEventListener('change', handleImport);
      async function handleImport() {
        const file = importFile.files?.[0];
        if (!file) return;
        showLoading(true);
        try {
          const text = await file.text();
          const arr = JSON.parse(text);
          if (!Array.isArray(arr)) throw new Error('Invalid JSON: expected an array');
          if (!user) throw new Error('Sign in first');

          const rows = arr.map(normalizeImport).map(r => ({ ...r, user_id: user.id }));
          const rowsWithoutImage = rows.map(({ image_url, ...rest }) => rest);

          let insertErr = null;
          let inserted = [];
          try {
            const { data: ins, error } = await supabase.from('entries').insert(rows).select();
            if (error) throw error;
            inserted = ins || [];
          } catch (e) {
            const msg = String(e?.message || '');
            if (msg.includes('image_url')) insertErr = e;
            else throw e;
          }

          if (insertErr) {
            const { data: ins2, error: err2 } = await supabase.from('entries').insert(rowsWithoutImage).select();
            if (err2) throw err2;
            inserted = ins2 || [];
            inserted.forEach((it, idx) => {
              const original = rows[idx];
              if (original?.image_url) setLocalImage(it.id, original.image_url);
            });
            showToast('info', 'Imported without cover sync. Add "image_url" column to entries to sync covers.');
          }

          await autoFetchMissingCovers(inserted);
          showToast('success', `Imported ${inserted.length} items`);
          importFile.value = '';
        } catch (e) {
          console.error(e);
          showToast('error', e.message || 'Import failed');
        } finally {
          showLoading(false);
        }
      }
      function normalizeImport(o) {
        const t = (o.title || '').toString().trim();
        const kind = (o.kind || 'SERIES').toUpperCase() === 'MOVIE' ? 'MOVIE' : 'SERIES';
        let status = (o.status || 'PLAN').toUpperCase();
        if (!STATUSES.includes(status)) status = 'PLAN';
        const season = isFinite(o.season) && o.season !== '' ? Number(o.season) : null;
        const episode = isFinite(o.episode) && o.episode !== '' ? Number(o.episode) : null;
        const absolute_episode = isFinite(o.absolute_episode) && o.absolute_episode !== '' ? Number(o.absolute_episode) : null;
        const notes = (o.notes || '').toString().trim() || null;
        const image_url = (o.image_url || '').toString().trim() || null;
        return { title: t, kind, status, season, episode, absolute_episode, notes, image_url };
      }

      // Keyboard helper
      document.addEventListener('keydown', (e) => {
        if (e.key === '/') { e.preventDefault(); searchEl.focus(); }
      });

      // Close things when clicking outside
      document.addEventListener('click', (e) => {
        document.querySelectorAll('.modal.open').forEach(m => { if (e.target === m) closeModal(m); });
        if (mobileMenu.classList.contains('open')) {
          const within = mobileMenu.contains(e.target) || menuBtn.contains(e.target);
          if (!within) closeMenu();
        }
        if (accountPanel.classList.contains('open')) {
          const within = accountPanel.contains(e.target) || document.getElementById('btn-account')?.contains(e.target);
          if (!within) accountPanel.classList.remove('open');
        }
      });

      // Auth tab switching
      tabSignin.onclick = () => {
        tabSignin.classList.add('active');
        tabSignup.classList.remove('active');
        signinForm.classList.remove('hidden');
        signupForm.classList.add('hidden');
      };
      tabSignup.onclick = () => {
        tabSignup.classList.add('active');
        tabSignin.classList.remove('active');
        signupForm.classList.remove('hidden');
        signinForm.classList.add('hidden');
      };
      authCancel.onclick = () => closeModal(authModal);

      // Auth submit on enter
      [loginIdentifier, loginPassword].forEach(input => input.addEventListener('keydown', e => { if (e.key === 'Enter') loginSend.click(); }));
      [signupUsername, signupEmail, signupPassword].forEach(input => input.addEventListener('keydown', e => { if (e.key === 'Enter') signupSend.click(); }));

      // Login with spinner
      loginSend.onclick = async () => {
        loginSend.classList.add('loading');
        loginSend.innerHTML = '';
        const identifier = loginIdentifier.value?.trim();
        const password = loginPassword.value;
        if (!identifier || !password) {
          showToast('error', 'Enter username/email and password');
          loginSend.classList.remove('loading');
          loginSend.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i>Sign in';
          return;
        }
        try {
          const { data: emailData, error: emailError } = await supabase.rpc('email_for_username', { p_identifier: identifier });
          if (emailError) throw emailError;
          const email = emailData?.email;
          if (!email) throw new Error('User not found');

          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          showToast('success', 'Signed in successfully');
          closeModal(authModal);
        } catch (e) {
          console.error(e);
          showToast('error', e.message || 'Sign-in failed');
        } finally {
          loginSend.classList.remove('loading');
          loginSend.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i>Sign in';
        }
      };

      // Signup with spinner
      signupSend.onclick = async () => {
        signupSend.classList.add('loading');
        signupSend.innerHTML = '';
        const username = signupUsername.value?.trim();
        const email = signupEmail.value?.trim();
        const password = signupPassword.value;

        if (!username || !email || !password) {
          showToast('error', 'All fields are required');
          signupSend.classList.remove('loading');
          signupSend.innerHTML = '<i class="fa-solid fa-user-plus"></i>Sign up';
          return;
        }
        if (password.length < 6) {
          showToast('error', 'Password must be at least 6 characters');
          signupSend.classList.remove('loading');
          signupSend.innerHTML = '<i class="fa-solid fa-user-plus"></i>Sign up';
          return;
        }
        try {
          const { data: existingUser } = await supabase.from('profiles').select('id').eq('username', username).single();
          if (existingUser) throw new Error('Username already taken');

          const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { username } } });
          if (error) throw error;
          showToast('success', 'Account created! Please check your email to verify.');
          closeModal(authModal);
        } catch (e) {
          console.error(e);
          showToast('error', e.message || 'Sign-up failed');
        } finally {
          signupSend.classList.remove('loading');
          signupSend.innerHTML = '<i class="fa-solid fa-user-plus"></i>Sign up';
        }
      };

      // Logout from account panel
      accountLogout.onclick = () => openConfirm('Sign out', 'Are you sure you want to sign out?', async () => {
        await supabase.auth.signOut();
        location.reload();
      });

      // URL params sync
      function updateURL() {
        const params = new URLSearchParams(window.location.search);
        params.set('tab', activeTab);
        params.set('view', viewMode);
        params.set('sort', sortMode);
        if (q) params.set('q', q);
        else params.delete('q');
        history.replaceState(null, '', `${location.pathname}?${params.toString()}`);
        localStorage.setItem('anibros:sort', sortMode);
      }
      function readURL() {
        const params = new URLSearchParams(window.location.search);
        const t = params.get('tab');
        const found = TABS.find(x => x.id === t);
        activeTab = found ? found.id : 'ALL';
        const qq = params.get('q') || '';
        q = qq.trim().toLowerCase();
        searchEl.value = qq;
        const v = params.get('view');
        const storedView = localStorage.getItem('anibros:view') || 'grid';
        viewMode = (v === 'compact' || v === 'grid') ? v : storedView;
        const s = params.get('sort');
        const storedSort = localStorage.getItem('anibros:sort') || 'recent';
        sortMode = ['recent', 'az', 'za'].includes(s) ? s : storedSort;
      }

      function updateViewToggleUI() {
        if (viewMode === 'grid') {
          viewBtnGrid.classList.add('active'); viewBtnGrid.setAttribute('aria-pressed', 'true');
          viewBtnCompact.classList.remove('active'); viewBtnCompact.setAttribute('aria-pressed', 'false');
        } else {
          viewBtnCompact.classList.add('active'); viewBtnCompact.setAttribute('aria-pressed', 'true');
          viewBtnGrid.classList.remove('active'); viewBtnGrid.setAttribute('aria-pressed', 'false');
        }
      }
      function updateSortToggleUI() {
        sortToggle.querySelectorAll('.seg').forEach(b => {
          b.classList.toggle('active', b.dataset.sort === sortMode);
        });
      }

      // Sort segmented control
      sortToggle.addEventListener('click', (e) => {
        const btn = e.target.closest('.seg[data-sort]');
        if (!btn) return;
        sortMode = btn.dataset.sort;
        updateURL();
        updateSortToggleUI();
        render();
      });

      // View toggle handlers
      viewBtnGrid.addEventListener('click', () => {
        viewMode = 'grid';
        localStorage.setItem('anibros:view', viewMode);
        updateURL(); render();
      });
      viewBtnCompact.addEventListener('click', () => {
        viewMode = 'compact';
        localStorage.setItem('anibros:view', viewMode);
        updateURL(); render();
      });

      // Mobile menu wiring
      function openMenu() {
        mobileMenu.classList.add('open');
        menuBtn.setAttribute('aria-expanded', 'true');
      }
      function closeMenu() {
        mobileMenu.classList.remove('open');
        menuBtn.setAttribute('aria-expanded', 'false');
      }
      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (mobileMenu.classList.contains('open')) closeMenu();
        else openMenu();
      });
      mAdd.addEventListener('click', () => { closeMenu(); openModalFor(); });
      mViewGrid.addEventListener('click', () => {
        viewMode = 'grid'; localStorage.setItem('anibros:view', viewMode); updateURL(); closeMenu(); render();
      });
      mViewCompact.addEventListener('click', () => {
        viewMode = 'compact'; localStorage.setItem('anibros:view', viewMode); updateURL(); closeMenu(); render();
      });
      mLogin.addEventListener('click', () => { closeMenu(); openModal(authModal); });
      mLogout.addEventListener('click', () => openConfirm('Sign out', 'Are you sure you want to sign out?', async () => {
        await supabase.auth.signOut(); location.reload();
      }));
      mImport.addEventListener('click', () => { closeMenu(); importFile.click(); });
      mExport.addEventListener('click', () => { closeMenu(); doExport(); });

      function updateMobileMenuUI() {
        if (user) {
          mUserEmail.textContent = user.email || user?.user_metadata?.email || 'user';
          mLogin.classList.add('hidden');
          mLogout.classList.remove('hidden');
        } else {
          mUserEmail.textContent = 'Signed out';
          mLogin.classList.remove('hidden');
          mLogout.classList.add('hidden');
        }
      }

      // Auto cover: AniList first, fallback to Jikan
      async function fetchAniListCover(title, wantKind, retry = false) {
        const query = `
          query ($search: String) {
            Page(perPage: 6) {
              media(search: $search, type: ANIME) {
                id
                title { romaji english native }
                synonyms
                format
                popularity
                coverImage { large extraLarge color }
              }
            }
          }
        `;
        try {
          const res = await fetch('https://graphql.anilist.co', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({ query, variables: { search: title } })
          });
          if (!res.ok) throw new Error('AniList search failed');
          const json = await res.json();
          const items = json?.data?.Page?.media || [];
          if (!items.length) throw new Error('No results');
          items.forEach(m => { m._score = scoreCandidate(title, m, wantKind); });
          items.sort((a, b) => b._score - a._score);
          const top = items[0];
          const image = top?.coverImage?.extraLarge || top?.coverImage?.large;
          return { image, match: top };
        } catch (e) {
          if (retry) throw e;
          return fetchAniListCover(title, wantKind, true);
        }
      }
      async function fetchJikanCover(title, retry = false) {
        const url = `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(title)}&limit=3&sfw`;
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error('Jikan search failed');
          const json = await res.json();
          const list = json?.data || [];
          if (!list.length) throw new Error('No results');
          const pick = list[0];
          return { image: pick?.images?.webp?.large_image_url || pick?.images?.jpg?.large_image_url || pick?.images?.webp?.image_url, match: pick };
        } catch (e) {
          if (retry) throw e;
          return fetchJikanCover(title, true);
        }
      }
      function normalizeStr(s) {
        return String(s || '').toLowerCase()
          .replace(/’|‘|“|”/g, '"')
          .replace(/[^a-z0-9\s]/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
      }
      function tokenSet(str) {
        return new Set(normalizeStr(str).split(' ').filter(Boolean).filter(w => !['the','a','an','and','of'].includes(w)));
      }
      function jaccard(aStr, bStr) {
        const a = tokenSet(aStr), b = tokenSet(bStr);
        if (!a.size || !b.size) return 0;
        let inter = 0;
        a.forEach(x => { if (b.has(x)) inter++; });
        const union = a.size + b.size - inter;
        return inter / union;
      }
      function scoreCandidate(query, media, wantKind) {
        const titles = [ media?.title?.romaji, media?.title?.english, media?.title?.native, ...(media?.synonyms || []) ].filter(Boolean);
        let bestTitleScore = 0;
        for (const t of titles) bestTitleScore = Math.max(bestTitleScore, jaccard(query, t));
        let typeBias = 0;
        const type = (media?.format || '').toUpperCase();
        if (wantKind === 'MOVIE') { if (type === 'MOVIE') typeBias = 0.15; else if (type === 'TV') typeBias = -0.05; }
        else { if (type === 'TV') typeBias = 0.10; else if (type === 'MOVIE') typeBias = -0.05; }
        const pop = media?.popularity || 0;
        const popBias = Math.min(0.05, (pop / 1000000) * 0.05);
        return bestTitleScore + typeBias + popBias;
      }
      async function autoFetchCover(title, kind) {
        if (!title) return null;
        try {
          let image = null;
          try {
            const { image: aImage } = await fetchAniListCover(title, kind);
            image = aImage;
          } catch (_) {}
          if (!image) {
            try {
              const { image: jImage } = await fetchJikanCover(title);
              image = jImage;
            } catch (e) {
              console.error(e);
            }
          }
          return image || null;
        } catch (e) {
          console.error(e);
          return null;
        }
      }

      // Auto cover button shows loading spinner
      btnAutoCover.addEventListener('click', async () => {
        const title = fTitle.value?.trim();
        if (!title) return showToast('error', 'Enter title first');
        btnAutoCover.classList.add('loading');
        btnAutoCover.innerHTML = '';
        try {
          const image = await autoFetchCover(title, fKind.value);
          if (image) {
            fImage.value = image;
            showToast('success', 'Cover set');
            initFloatingLabels(modal);
            toggleClearButtons();
          } else {
            showToast('error', 'No cover found');
          }
        } finally {
          btnAutoCover.classList.remove('loading');
          btnAutoCover.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i>Auto cover';
        }
      });

      // Autofetch cover on title blur if none set
      fTitle.addEventListener('blur', async () => {
        if (!fImage.value.trim()) {
          const title = fTitle.value?.trim();
          if (title) {
            const image = await autoFetchCover(title, fKind.value);
            if (image) {
              fImage.value = image;
              initFloatingLabels(modal);
              toggleClearButtons();
            }
          }
        }
      });

      // Auto-fetch missing covers for rows
      async function autoFetchMissingCovers(rows) {
        const missing = rows.filter(r => !r.image_url && r.title);
        if (!missing.length) return;
        showToast('info', `Fetching covers for ${missing.length} items...`);
        const concurrentLimit = 4;
        let active = 0, i = 0;

        async function work(row) {
          const image = await autoFetchCover(row.title, row.kind);
          if (image) {
            try { await upsertEntry('update', { ...row, image_url: image }, row.id); }
            catch (e) { console.error(`Failed to update cover for ${row.title}:`, e); setLocalImage(row.id, image); }
          }
        }
        while (i < missing.length) {
          if (active < concurrentLimit) {
            const row = missing[i++];
            active++;
            work(row).finally(() => { active--; });
          }
          await new Promise(r => setTimeout(r, 120));
        }
      }
      btnRefreshCovers.addEventListener('click', async () => {
        if (!user) return showToast('error', 'Sign in first');
        await autoFetchMissingCovers(data);
        showToast('success', 'Covers refreshed');
        render();
      });

      // Clear buttons logic
      function toggleClearButtons() {
        const toggle = (btn, input) => btn.classList.toggle('visible', String(input.value ?? '').trim() !== '');
        toggle(clearTitle, fTitle);
        toggle(clearSeason, fSeason);
        toggle(clearEpisode, fEpisode);
        toggle(clearAbs, fAbs);
        toggle(clearImage, fImage);
        toggle(clearNotes, fNotes);
        toggleSearchClear();
        initFloatingLabels(modal);
      }
      [fTitle, fSeason, fEpisode, fAbs, fImage, fNotes].forEach(input => { input.addEventListener('input', toggleClearButtons); });
      clearTitle.onclick = () => { fTitle.value = ''; toggleClearButtons(); fTitle.focus(); };
      clearSeason.onclick = () => { fSeason.value = ''; toggleClearButtons(); fSeason.focus(); };
      clearEpisode.onclick = () => { fEpisode.value = ''; toggleClearButtons(); fEpisode.focus(); };
      clearAbs.onclick = () => { fAbs.value = ''; toggleClearButtons(); fAbs.focus(); };
      clearImage.onclick = () => { fImage.value = ''; toggleClearButtons(); fImage.focus(); };
      clearNotes.onclick = () => { fNotes.value = ''; toggleClearButtons(); fNotes.focus(); };

      // Scroll to top (fix visibility logic)
      scrollToTop.onclick = () => { window.scrollTo({ top: 0, behavior: 'smooth' }); };
      window.addEventListener('scroll', () => {
        const y = window.scrollY || document.documentElement.scrollTop || document.body.scrollTop || 0;
        if (y > 200) scrollToTop.classList.add('visible');
        else scrollToTop.classList.remove('visible');
      }, { passive: true });

      // Initialize
      (async function init() {
        showPreloader('Loading AniMehList…');
        setRandomBanner();
        readURL();
        renderTabs();
        updateViewToggleUI();
        updateSortToggleUI();
        toggleSearchClear();

        const { data: { session: s} } = await supabase.auth.getSession();
        session = s;
        user = s?.user ?? null;
        updateAuthUI();

        if (user) {
          await load();
          setupRealtime();
          setupPresence();
        } else {
          hidePreloader();
          render(); // tabs/empty
        }

        initFloatingLabels(document);
      })();

      // Auth state change
      supabase.auth.onAuthStateChange((_evt, s) => {
        session = s;
        user = s?.user ?? null;
        updateAuthUI();
        if (user) {
          load();
          setupRealtime();
          setupPresence();
        }
        render();
      });
    </script>
  </body>
</html>