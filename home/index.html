<!DOCTYPE html>
<html lang="en">
<head>
  <!--
    DriftThreads -- Home (Enhanced)
    - Desktop-only header Info button inserted between Search and Cart
    - Mobile keeps Info bar as-is
    - Info button color uses --accent (no --accent-strong)
    - Added small UX features: product count, keyboard shortcuts, persistent category "Show all", online/offline toast
    - Extensive comments for feature developers
  -->
  <meta charset="utf-8" />
  <title>DriftThreads -- Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="assets/favicon.png" />

  <!-- SEO meta and social -->
  <meta name="description" content="Discover Drift Threads, the ultimate destination for premium streetwear inspired by car culture. Shop our exclusive collection now!">
  <meta name="robots" content="index,follow">
  <link rel="canonical" href="https://driftthreads.store/">

  <meta property="og:title" content="Drift Threads | Premium Streetwear for Car Enthusiasts">
  <meta property="og:description" content="Explore our exclusive collection of streetwear inspired by car culture. Shop now at Drift Threads.">
  <meta property="og:image" content="https://driftthreads.store/assets/logo.png">
  <meta property="og:url" content="https://driftthreads.store/">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Drift Threads">

  <meta name="twitter:title" content="Drift Threads | Premium Streetwear for Car Enthusiasts">
  <meta name="twitter:description" content="Shop the latest streetwear inspired by car culture at Drift Threads.">
  <meta name="twitter:image" content="https://driftthreads.store/assets/logo.png">
  <meta name="twitter:card" content="summary_large_image">

  <!-- UI meta -->
  <meta name="theme-color" content="#161616">
  <meta name="color-scheme" content="dark">

  <!-- Fonts and icons -->
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400&display=swap" rel="stylesheet">
  <!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"> -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">


  <!-- Structured data for SEO -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Drift Threads",
    "url": "https://driftthreads.store/",
    "logo": "https://driftthreads.store/assets/logo.png"
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Drift Threads",
    "url": "https://driftthreads.store/",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://driftthreads.store/?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>

  <style>
  /* ===========================================================
     Theme tokens and global resets
     =========================================================== */
  :root{
    --bg:radial-gradient(circle at center,#2a3a44,#161616 75%);
    --card-bg:radial-gradient(circle at center,#383838,#161616 85%);
    --text:#fff;
    --accent:#0af;            /* Primary accent (used for Info button per request) */
    --accent-strong:#00c2ff;  /* Bright accent (kept for other UI) */
    --muted:#9aa0a6;
    --transition:240ms;
    --ease:cubic-bezier(0.22,0.9,0.27,1);
    --card-radius:12px;
    --badge-font:600 .78rem/1 "Fira+Sans",sans-serif;
  }

  *{box-sizing:border-box}

  html{scroll-behavior:smooth}
  html,body{
    margin:0;padding:0;width:100%;height:100%;
    background:var(--bg);
    background-color:#161616; /* fallback + fixes rare hairline seams */
    color:var(--text);font-family:"Fira+Sans",sans-serif;
    font-weight:400; /* lighter default weight everywhere */
  }

  @media (max-width: 768px) { 
    /* Slightly scale action buttons for better thumb reach on mobile */
    .add-btn, .share-btn, .view-img-btn { transform:scale(0.9) } 
  }

  a{color:inherit}
  ::selection{background:rgba(10,170,255,0.14)}
  ::-webkit-scrollbar{width:0;background:transparent}

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce){
    *{
      animation-duration:0.001ms !important;
      animation-iteration-count:1 !important;
      transition-duration:0.001ms !important;
      scroll-behavior:auto !important
    }
  }

  /* ===========================================================
     Global interactive affordances (buttons)
     =========================================================== */
  button,[role="button"]{
    transition:
      transform 160ms var(--ease),
      box-shadow 180ms var(--ease),
      background-color 160ms ease,
      opacity 160ms ease,
      filter 160ms ease,
      outline-color 120ms ease;
    outline:0;
    -webkit-tap-highlight-color: transparent;
    font-weight:600; /* lighter buttons */
    cursor:pointer;
  }
  button:hover,[role="button"]:hover{transform:translateY(-1px)}
  button:active,[role="button"].pressed{transform:translateY(1px) scale(0.98);filter:brightness(0.96)}
  button:focus-visible,[role="button"]:focus-visible{
    outline:3px solid rgba(0,102,255,0.35);
    outline-offset:3px;
    border-radius:8px;
  }

  /* ===========================================================
     Body scroll lock when a modal is open (cart or lightbox)
     =========================================================== */
  body.modal-open{overflow:hidden; overscroll-behavior:contain}
  @supports (position: fixed){
    body.modal-open{position:fixed; width:100%}
  }

  /* ===========================================================
     Accessibility helpers: skip link
     =========================================================== */
  .skip-link{
    position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;
  }
  .skip-link:focus{
    left:10px; top:10px; width:auto; height:auto; padding:8px 12px;
    background:#fff; color:#111; border-radius:8px; z-index:10000;
  }

  /* ===========================================================
     Scroll to top floating action button
     =========================================================== */
  #scrollToTopBtn i{text-decoration:none;line-height:1;font-size:20px;display:inline-block}
  #scrollToTopBtn{
    position:fixed;width:50px;height:50px;background:#fff;color:#111;bottom:30px;right:30px;border-radius:50%;
    text-decoration:none;display:flex;align-items:center;justify-content:center;line-height:45px;font-size:25px;z-index:9;border:0;
    -webkit-tap-highlight-color:transparent;
    transition:transform 220ms cubic-bezier(0.22,0.9,0.27,1),background 180ms ease,box-shadow 180ms ease,opacity 180ms ease;
    will-change:transform,opacity,box-shadow;transform:translateY(8px) scale(0.98);opacity:0;pointer-events:none;box-shadow:0 12px 30px rgba(0,0,0,0.12)
  }
  #scrollToTopBtn.visible{pointer-events:auto;opacity:.98;transform:translateY(0) scale(1)}
  #scrollToTopBtn.visible:hover,#scrollToTopBtn.visible:focus,#scrollToTopBtn.visible.focused{background:var(--accent);transform:translateY(0) scale(1.1);box-shadow:0 5px 5px rgba(10,170,255,0.16);outline:0}
  #scrollToTopBtn.visible:active,#scrollToTopBtn.visible.pressed{border-radius:50%;transform:translateY(0) scale(0.96);transition:transform 120ms cubic-bezier(0.2,0.8,0.2,1)}
  @keyframes clickPop{0%{transform:scale(1) translateY(0)}40%{transform:scale(0.86) translateY(2px)}100%{transform:scale(1.08) translateY(-2px)}}
  #scrollToTopBtn:active{transform:scale(0.96)!important}
  #scrollToTopBtn:focus,#scrollToTopBtn.focused{outline:3px solid rgba(0,102,255,0.18);outline-offset:4px;border-radius:8px}
  @media(max-width:600px){
    #scrollToTopBtn{height:38px;width:38px;font-size:20px;right:calc(50vw - 19px);bottom:20px}
  }

  /* ===========================================================
     Header (sticky)
     - Desktop enhancement: Info button in header between Search and Cart
     =========================================================== */
  header{
    position:sticky;top:10px;z-index:50;
    background:rgba(0,0,0,0.9);
    padding:12px 16px;box-shadow:0 1px 0 rgba(255,255,255,0.02);margin:10px;border-radius:var(--card-radius);outline:1px solid rgba(255,255,255,0.02);outline-offset:-1px;
    backface-visibility:hidden;
    transform:translateZ(0);will-change:transform;contain:paint;
  
  }
  .top-row{display:flex;gap:12px;align-items:center; }
  .logo img{height:40px;display:block;background:#fff;padding:6px;border-radius:8px}

  /* Header search */
  .search-wrap{flex:1;display:flex;gap:6px; justify-content: center;}
  .search-box{position:relative;flex:1;min-width:0; 
    max-width:750px;
  }
  .search-box input{width:100%;padding:10px 36px 10px 12px;border-radius:25px 5px 5px 25px;background:#2b2b2b;border:0;color:#fff;font-size:14px;outline:0;box-shadow:0 4px 18px rgba(0,0,0,0.45),inset 0 1px 0 rgba(255,255,255,0.02)}
  #clearBtn{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:#888;cursor:pointer;display:none;padding:6px;border-radius:6px}
  #searchBtn{background:#06f;border:0;color:#fff;border-radius:8px;padding:8px 12px;box-shadow:0 8px 18px rgba(0,102,255,0.12)}

  /* Header cart */
  #cartBtn{width:44px;height:44px;border-radius:50%;background:#222;display:inline-flex;align-items:center;justify-content:center;position:relative}
  #cartCount{position:absolute;right:6px;bottom:6px;background:#06f;color:#fff;border-radius:50%;min-width:16px;height:16px;line-height:16px;text-align:center;font-size:11px;padding:0 4px;display:inline-block}
  #cartCount.pop{animation:popBadge 420ms var(--ease)}
  @keyframes popBadge{0%{transform:scale(1)}30%{transform:scale(1.35)}100%{transform:scale(1)}}

  /* Header Info button wrapper (desktop only) */
  .header-info-wrap{position:relative;display:none}
  @media (min-width:901px){
    .header-info-wrap{display:inline-flex}
  }

  /* ===========================================================
     Categories bar (horizontal on small, "Show all" on desktop)
     =========================================================== */
  .cat-bar{
    display:flex;padding-top:10px;overflow-x:auto;white-space:nowrap;margin-left:30px;position:relative;padding-bottom:10px;gap:6px;
  }
  .cat-bar::after{content:none !important}
  .cat-bar.show-all{
    flex-wrap:wrap;white-space:normal;overflow:visible;padding-bottom:8px;gap:8px;
  }
  .cat-btn{
    background:#fff;color:#222;padding:6px 12px;border-radius:10px;border:0;flex-shrink:0;margin-right:0;
    transition:filter 160ms ease, background 160ms ease, transform 160ms var(--ease); font-weight:600
  }
  .cat-btn:hover{filter:brightness(0.92);transform:translateY(-1px)}
  .cat-btn:active,.cat-btn.pressed{transform:translateY(1px) scale(0.98)}
  .cat-btn.active{background:#06f;color:#fff}
  .cat-btn.active:hover{filter:brightness(0.92)}

  /* Subtle mobile scroll hint: edge shadow */
  .cat-scroll-hint{
    position:fixed;right:0;top:0;bottom:0;width:42px;
    background:linear-gradient(to left, rgba(22,22,22,0.95), rgba(22,22,22,0));
    border:0; pointer-events:none; display:none; box-shadow:none; color:transparent;
  }
  .cat-scroll-hint.visible{display:block}
  .cat-scroll-hint i{display:none}

  /* Desktop-only "Show all" button */
  #showAllCatsBtn{
    display:none;margin:6px 30px 0 auto;background:transparent;color:#9bd4ff;border:0;padding:6px 0;font-weight:600;cursor:pointer;
    text-decoration:underline; border-radius:0; box-shadow:none;
  }
  #showAllCatsBtn:hover{transform:none; filter:brightness(1.1)}
  #showAllCatsBtn:active,#showAllCatsBtn.pressed{transform:none}
  @media (max-width: 900px){
    #showAllCatsBtn{display:none !important}
  }

  /* ===========================================================
     Products grid
     =========================================================== */
  main{padding:20px 12px;flex:1}
    footer{margin:20px;color:var(--muted);display:flex;justify-content:space-between;flex-wrap:wrap;gap:12px;font-size:14px; padding-bottom: 40px;}

    hr {
      background: var(--muted);
      width: 90vw;
      border-radius: 3px;
    }

    .footer-img {
      /* width: 32px; */
      height: 32px;
    }

      @media (min-width: 700px){

        footer{margin:20px 40px 40px 40px; padding-bottom: 30px;}

    hr {
      width: 95vw;
    }
  }

  #grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, 220px);
    gap: 20px;
    justify-content: center;
    /* Fixed invalid calc: 220px cards × 5 columns + 20px gaps × 4 = cleaner max width */
    max-width: calc(220px * 5 + 20px*);
    margin: 0 auto;
    padding: 0 18px;
  }
  @media (max-width: 900px) {
    #grid { grid-template-columns: repeat(auto-fill, 200px); }
  }
  @media (max-width: 600px) {
    #grid { grid-template-columns: repeat(2, 1fr); max-width: 100%; }
  }

  /* ===========================================================
     Product cards (front/back flip)
     =========================================================== */
  .card{perspective:1200px;max-width:220px;cursor:pointer;border-radius:var(--card-radius);transition:all .5s ease;will-change:transform;opacity:0}
  .card.pop-in{animation:fadeInUp .36s var(--ease) forwards}
  @keyframes fadeInUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
  .card:hover{transform:translateY(-8px);box-shadow:0 4px 10px rgba(0,0,0,0.6)}
  .card-inner{position:relative;width:100%;height:320px;border-radius:var(--card-radius);transform-style:preserve-3d;transition:transform .5s var(--ease)}
  .card-front,.card-back{
    position:absolute;inset:0;border-radius:var(--card-radius);display:flex;flex-direction:column;overflow:hidden;backface-visibility:hidden;
    background:radial-gradient(circle at top left,#2c2c2c,#161616 80%);transition:opacity .18s linear;pointer-events:none
  }
  .card-front{transform:rotateY(0deg) translateZ(0.1px);z-index:2;pointer-events:auto}
  .card-back{transform:rotateY(180deg) translateZ(0.1px);z-index:1;color:#e6f7ff;padding:14px;font-size:.95rem;gap:8px;justify-content:flex-start}
  .card.flipped .card-inner{transform:rotateY(180deg)}
  .card.flipped .card-front{z-index:1;pointer-events:none}
  .card.flipped .card-back{z-index:2;pointer-events:auto}

  .img-wrap{height:62%;background:#fff;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
  .img-wrap img{width:100%;height:100%;object-fit:cover;transition:transform 420ms var(--ease); background:#fff;}
  .img-wrap img:hover{transform:scale(1.05)}

  /* --- Image skeleton shimmer (cards only; lightbox skips skeleton) --- */
  @property --stop1 {
    syntax: '<percentage>';
    inherits: false;
    initial-value: 25%;
  }
  @property --stop2 {
    syntax: '<percentage>';
    inherits: false;
    initial-value: 37%;
  }
  @property --stop3 {
    syntax: '<percentage>';
    inherits: false;
    initial-value: 63%;
  }
  .img-skeleton {
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: linear-gradient(
      90deg,
      rgba(255,255,255,0.05) var(--stop1),
      rgba(255,255,255,0.12) var(--stop2),
      rgba(255,255,255,0.05) var(--stop3)
    );
    animation: shimmer 1s ease-in-out infinite alternate;
    pointer-events: none;
    z-index: 1;
  }
  @keyframes shimmer {
    0% { --stop1: 20%; --stop2: 30%; --stop3: 60%; }
    100% { --stop1: 40%; --stop2: 50%; --stop3: 80%; }
  }

  .front-body{padding:8px 10px;display:flex;flex-direction:column;gap:6px;flex:1}
  .product-title-front{font-weight:600;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .price-row{display:flex;justify-content:space-between;align-items:center}
  .price{font-weight:600;font-size:1.02rem;color:#e8f8ff}

  /* Primary action buttons */
  .add-btn{
    transition:all .3s ease;background:linear-gradient(180deg,#f9a8d4,#c084fc);border:0;padding:8px 10px 8px 10px;border-radius:10px;color:#000;font-weight:600;cursor:pointer
  }
  .add-btn:hover{transform:translateY(-3px)}
  .add-btn:active,.add-btn.pressed{transform:translateY(1px) scale(0.98)}
  .view-img-btn{
    transition:all .3s ease;background:linear-gradient(90deg,#6ee7ff,#a78bfa);color:#000;border:0;padding:6px 10px;border-radius:8px;font-weight:600
  }
  .view-img-btn:hover{transform:translateY(-2px)}
  .view-img-btn:active,.view-img-btn.pressed{transform:translateY(1px) scale(0.98)}
  .share-btn{
    transition:all .18s var(--ease);background:rgba(255,255,255,0.06);border:0;padding:8px 10px;border-radius:8px;color:var(--text);font-weight:600
  }
  .share-btn i{width:18px;display:inline-block;text-align:center}
  .share-btn:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,0.4)}
  .share-btn:active,.share-btn.pressed{transform:translateY(1px) scale(0.98)}

  /* Back-of-card button tweaks on small screens: icon-only for compact layout */
  @media (max-width: 600px){
    .card-back .btn-label{display:none}
    .card-back { padding:10px; }
    .card-back > div:last-child {
      gap:5px !important;
      flex-wrap:nowrap !important;
      justify-content:center;
    }
    .card-back .view-img-btn,
    .card-back .share-btn,
    .card-back .add-btn{
      padding:7px;width:34px;height:34px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center; 
    }
    .card-back .view-img-btn i,
    .card-back .share-btn i,
    .card-back .add-btn i{ padding:0 !important; font-size:14px; }
    .card-back .share-btn i { width:16px; }
  }

  /* Product badges (discount, hot, etc.) */
  .card-badge{position:absolute;right:8px;bottom:8px;z-index:6;pointer-events:none;padding:6px 10px;border-radius:999px;font:var(--badge-font);color:#021019;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 20px rgba(2,16,25,0.5);transform-origin:100% 100%;transform:translateY(6px) scale(0.98);opacity:0;transition:transform 260ms var(--ease),opacity 220ms var(--ease);white-space:nowrap}
  .card.pop-in .card-badge{transform:translateY(0) scale(1);opacity:1}
  .card-badge .badge-dot{width:8px;height:8px;border-radius:50%;flex:0 0 8px;box-shadow:0 2px 4px rgba(0,0,0,0.25)}
  .card-badge.sale{background:linear-gradient(90deg,#d1fae5,#10b981);color:#012}
  .card-badge.sale .badge-dot{background:#036b4a}
  .card-badge.limited{background:linear-gradient(90deg,#ffebb7,#f59e0b);color:#081214}
  .card-badge.limited .badge-dot{background:#ac5d03}
  .card-badge.neutral{background:linear-gradient(90deg,#e6eef8,#9fb7d8);color:#021019}
  .card-badge.neutral .badge-dot{background:black}
  @media(max-width:500px){.card-badge{padding:5px 8px;font-size:.72rem}}

  .empty-state{grid-column:1/-1;padding:28px;border-radius:10px;background:rgba(255,255,255,0.03);text-align:center;color:#aaa}

  /* Sponsor card visuals */
  .sponsor-card{position:relative}
  .sponsor-label{position:absolute;bottom:8px;right:8px;background-color:var(--accent);color:black;font-size:.85rem;font-weight:600;padding:6px;border-radius:10px;pointer-events:none;z-index:5}
  .sponsor-card-front{outline:3px solid red;outline-offset:2px;border-radius:10px;overflow:hidden;height:100%;min-height:200px;display:flex;flex-direction:column;animation:rainbowJitter 5s steps(1) infinite}
  @keyframes rainbowJitter{0%{outline-color:red}16%{outline-color:orange}33%{outline-color:yellow}50%{outline-color:lime}66%{outline-color:blue}83%{outline-color:#850bdd}100%{outline-color:violet}}
  .card.sponsor{box-shadow:0 6px 22px rgba(0,0,0,0.45);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01))}
  .card.sponsor .img-wrap{height:62%;background:#fff}
  .card.sponsor .front-body{padding:10px;display:flex;flex-direction:column;gap:6px;flex:1}
  .card.sponsor{color:var(--accent-strong);font-weight:600;font-size:.92rem;padding:0;margin:0}
  .card.sponsor .sponsor-title{font-weight:600;font-size:.95rem;margin-top:4px}
  .card.sponsor .sponsor-desc{color:#cbd9ea;margin-top:6px;font-size:.88rem;opacity:.95}

  /* ===========================================================
     Carousel (shared by cards and lightbox)
     =========================================================== */
  .carousel{position:relative;width:100%;height:100%;overflow:hidden;background:#111}
  .carousel-track{display:flex;height:100%;transition:transform 320ms cubic-bezier(0.22,0.9,0.27,1);will-change:transform}
  .carousel-slide{min-width:100%;height:100%;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;background:#111}
  .carousel-slide img{width:100%;height:100%;object-fit:cover;display:block}

  /* Carousel controls */
  .carousel-controls{position:absolute;top:50%;transform:translateY(-50%);width:100%;display:flex;justify-content:space-between;padding:0 8px;pointer-events:none}
  .carousel-btn{pointer-events:auto;background:rgba(0,0,0,0.45);border:0;color:#fff;padding:8px 10px;border-radius:8px;backdrop-filter:blur(2px);transition:background 140ms ease, opacity 200ms var(--ease), transform 160ms var(--ease)}
  .carousel-btn:hover{background:rgba(0,0,0,0.62)}
  .carousel-btn:active,.carousel-btn.pressed{transform:scale(0.96)}

  .carousel-dots{position:absolute;left:50%;transform:translateX(-50%);bottom:8px;display:flex;gap:6px;pointer-events:auto}
  .carousel-dot{
    width:8px;height:8px;border-radius:25%;
    background:rgba(255,255,255,0.2);border:1px solid rgba(0,0,0,0.25);transition:transform 160ms var(--ease)
  }
  .carousel-dot:hover{transform:scale(1.2)}
  .carousel-dot.active{background:#06f}
  .carousel-counter{position:absolute;right:8px;top:8px;background:rgba(0,0,0,0.5);padding:6px 8px;border-radius:8px;font-weight:600;font-size:0.82rem}

  /* Lightbox-specific counter and dots */
  .lightbox .carousel-counter{
    position:fixed;
    left:12px;
    right:auto;
    top:18px;
    z-index:1001;
    pointer-events:none;
  }
  .lightbox .carousel-dot{
    width:10px;height:10px;border-radius:50%;
    background:#b4bcc4;
    border:1px solid rgba(0,0,0,0.7);
    box-shadow:0 1px 2px rgba(0,0,0,0.4);
  }
  .lightbox .carousel-dot.active{
    background:#06f;
    border-color:#001a33;
    box-shadow:0 0 0 2px rgba(0,102,255,0.25);
  }
  @media (max-width:480px){
    .carousel-btn{padding:6px 8px}
  }

  /* ===========================================================
     Transient notifications (add-to-cart and share)
     =========================================================== */
  .add-notif{position:fixed;bottom:20px;left:20px;background:linear-gradient(180deg,rgba(26,26,26,0.98),rgba(18,18,18,0.98));padding:10px;border-radius:10px;display:flex;gap:10px;align-items:center;border:1px solid rgba(10,170,255,0.12);box-shadow:0 12px 36px rgba(0,0,0,0.6);z-index:1200;opacity:0;pointer-events:none;transform:translateY(18px)}
  .add-notif.visible{animation:fadeInUp .28s var(--ease) forwards;pointer-events:auto}
  .add-notif.hiding{animation:fadeOutDown .28s var(--ease) forwards;pointer-events:none}
  .add-notif .product-thumb{width:48px;height:48px;object-fit:cover;border-radius:8px;background:#fff;padding:3px}
  .add-notif .msg{color:#e6f7ff;flex:1}
  .undo-btn,.close-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:8px;color:#fff}
  .undo-btn:hover,.close-btn:hover{transform:translateY(-1px)}
  .undo-btn:active,.close-btn:active,.undo-btn.pressed,.close-btn.pressed{transform:translateY(1px) scale(0.98)}
  .share-notif{position:fixed;bottom:20px;right:20px;background:linear-gradient(180deg,rgba(40,10,80,0.98),rgba(70,20,140,0.96));color:#fff;padding:10px 12px;border-radius:10px;z-index:1300;box-shadow:0 12px 36px rgba(0,0,0,0.6);opacity:0;transform:translateY(14px);transition:opacity 220ms var(--ease),transform 220ms var(--ease);pointer-events:none;display:flex;gap:10px;align-items:center}
  .share-notif.visible{opacity:1;transform:translateY(0);pointer-events:auto}

  /* ===========================================================
     Cart modal and footer
     =========================================================== */
  .cart-modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:100}
  .cart-modal.active{display:flex}
  .cart-content{background:#1a1a1a;border-radius:12px;padding:18px;width:90%;max-width:560px;max-height:80vh;overflow:auto;box-shadow:0 40px 120px rgba(0,0,0,0.7);position:relative}
  #closeCart{position:absolute;right:25px;top:30px;background:#06f;border:0;color:#fff;border-radius:50%;width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(0,102,255,0.12)}
  #closeCart:hover{transform:translateY(-1px)}
  #closeCart:active,#closeCart.pressed{transform:translateY(1px) scale(0.98)}
  .cart-footer{position:sticky;bottom:0;display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;outline:1px solid white;border-top:1px solid #333;border-radius:10px;background:linear-gradient(180deg,rgba(18,18,18),rgba(18,18,18));backdrop-filter:blur(6px);z-index:30}
  .cart-footer .left{display:flex;gap:8px;align-items:center}
  .cart-footer .subtotal{font-weight:600;font-size:1.02rem}
  .wa-btn{background:#25d366;color:#012;border:0;padding:10px 12px;border-radius:10px;font-weight:700;display:inline-flex;align-items:center;gap:8px}
  .wa-btn i{font-size:18px}
  .wa-btn:hover{transform:translateY(-1px)}
  .wa-btn:active,.wa-btn.pressed{transform:translateY(1px) scale(0.98)}
  #clearCartBtn{background:#ff2a2a;color:#fff;border-radius:10px;padding:8px 12px;border:0}

  /* Hide old cart info button (we use global bar or header info) */
  #cartInfoBtn, #cartInfoTooltip{display:none !important}

  /* ===========================================================
     Info/Disclaimer buttons + tooltips
     - .info-btn color changed to --accent (requested)
     - Global bar shown on mobile; header button on desktop
     =========================================================== */
  .info-btn{
    margin-top: 4px;
    background: #ff2a2a;    
    color:#fff;                   /* readable contrast on bright blue */
    border:0;border-radius:10px;padding:8px 10px;font-weight:700;
    display:inline-flex;align-items:center;justify-content:center;gap:6px;
    box-shadow:0 8px 18px rgba(0,0,0,0.25), inset 0 0 0 1px rgba(255,255,255,0.06);
  }
  /* @media (min-width:601px){ 
    .info-btn{ background: #222; color:#fff;} 
  } */

  .info-btn .icon{font-size:14px}
  .info-btn:hover{transform:translateY(-1px)}
  .info-btn:active,.info-btn.pressed{transform:translateY(1px) scale(0.98)}

  .tooltip{
    position:absolute;right:12px;bottom:54px;max-width:320px;min-width:240px;
    background:linear-gradient(180deg,rgba(3,21,30,0.98),rgba(5,40,60,0.96));
    color:#e6f7ff;border:2px solid rgba(0,194,255,0.15);border-radius:12px;padding:12px 14px;z-index:60;
    box-shadow:0 12px 40px rgba(0,0,0,0.6),0 6px 18px rgba(0,194,255,0.06) inset;display:none;
  }

  
  .tooltip.visible{display:block;animation:fadeInUp .22s var(--ease)}
  .tooltip .tt-title{font-weight:700;margin-bottom:6px;color:#9bd4ff}
  .tooltip .tt-body{font-size:.92rem;line-height:1.25;opacity:.95}
  .tooltip .tt-body b{color:#cfe8ff;font-weight:600}
  .tooltip::after{
    content:"";position:absolute;right:18px;bottom:-10px;width:0;height:0;
    border-left:10px solid transparent;border-right:10px solid transparent;border-top:10px solid rgba(3,21,30,0.98);
    filter:drop-shadow(0 -4px 6px rgba(0,0,0,0.25))
  }

  /* Global info bar (mobile) */
  #productInfoBar{
    display:flex; align-items:center; gap:8px; padding:0 18px; margin:6px 0 0 0;
    position:relative; justify-content:space-between; /* left: product count, right: info button */
  }
  /* Mobile-only: show global info bar; Desktop hides it */
  /* @media (min-width:901px){ #productInfoBar{ display:none } } */

  /* Product count label (mobile bar) */
  #productCount{ color: var(--muted); 
    font-weight: 600; 
    padding: 10px 0 0 15px;
  }

  /* Global info tooltip position override (mobile) */
  #globalInfoTooltip.tooltip{
    top:46px; right:0; bottom:auto;
  }
  #globalInfoTooltip.tooltip::after{
    right:18px; bottom:auto; top:-10px;
    border-top:none;
    border-left:10px solid transparent; border-right:10px solid transparent; border-bottom:10px solid rgba(3,21,30,0.98);
  }

  /* Header info tooltip positioning (desktop) */
  #headerInfoTooltip.tooltip{
    top:46px; right:0; bottom:auto; /* drop down from the button */
  }
  #headerInfoTooltip.tooltip::after{
    right:18px; bottom:auto; top:-10px;
    border-top:none;
    border-left:10px solid transparent; border-right:10px solid transparent; border-bottom:10px solid rgba(3,21,30,0.98);
  }

  /* ===========================================================
     Lightbox (full-screen image viewer)
     =========================================================== */
  .lightbox{
    position:fixed;inset:0;
    background:#000;
    display:none;align-items:center;justify-content:center;
    z-index:200;touch-action:none;transition:background 260ms ease;
  }
  .lightbox.active{display:flex}
  .lightbox.opened{background:#000}
  .lightbox.closing{background:rgba(0,0,0,0)!important}
  .lightbox .lb-frame{
    width:95vw;max-width:1100px;height:82vh;max-height:90vh;
    display:flex;align-items:center;justify-content:center;
    opacity:0;transform:translateY(14px) scale(0.96);
    transition:transform 260ms var(--ease),opacity 260ms var(--ease)
  }
  .lightbox.opened .lb-frame{opacity:1;transform:translateY(0) scale(1)}
  .lightbox.closing .lb-frame{opacity:0;transform:translateY(24px) scale(0.96)}
  .lightbox .carousel{width:100%;height:100%;background:#000;border-radius:10px;overflow:hidden}
  .lightbox .carousel-slide{background:#000}
  .lightbox .carousel-btn{background:rgba(0,0,0,0.45)}
  .lightbox .carousel-btn:hover{background:rgba(0,0,0,0.62)}
  .lightbox .carousel-dots{bottom:12px}

  /* Desktop: keep constant image height while preserving fully-black background */
  @media (min-width:721px){
    .lightbox .carousel-slide img.zoom-img{
      width:auto !important;
      height:82vh !important;
      max-height:82vh;
      max-width:96vw;
      object-fit:contain !important;
    }
  }

  /* Zoom container and image */
  .zoom-wrap{width:100%;height:100%;overflow:hidden;touch-action:none;display:flex;align-items:center;justify-content:center;background:#000}
  .zoom-img{
    max-width:100%;
    max-height:100%;
    will-change:transform;
    transform-origin:center center;
    transition:transform 80ms ease-out;
  }
  .lightbox .carousel-slide img.zoom-img{
    width:auto !important; height:auto !important;
    max-width:96vw; max-height:88vh;
    object-fit:contain !important;
  }
  /* Mobile: fix lightbox to viewport for stable reopen positioning */
  @media(max-width:720px){
    .lightbox .lb-frame{width:100vw;height:100vh;border-radius:0}
    .lightbox .carousel{border-radius:0; position:fixed; inset:0; width:100vw; height:100vh}
    .lightbox .carousel-slide img.zoom-img{max-width:100vw;max-height:100vh}
    .lightbox .carousel-controls{transition:opacity 200ms var(--ease)}
    .lightbox.hide-controls .carousel-controls{opacity:0;pointer-events:none}
  }

  /* ===========================================================
     Infinite scroll loading indicator
     =========================================================== */
  #loadingSpinner{text-align:center;padding:18px 0;color:#99bfe8}

  /* ===========================================================
     Focus outlines everywhere
     =========================================================== */
  :focus-visible{outline:3px solid rgba(0,102,255,0.12);outline-offset:3px;border-radius:8px}

  /* ===========================================================
     Modern preloader overlay (initial page boot)
     =========================================================== */
  #preloader{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:#0b0b0b; display:flex; align-items:center; justify-content:center;
    z-index:999999; transition:opacity .45s ease
  }
  .preloader-card{
    width:min(420px,86vw); background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));
    border:1px solid rgba(255,255,255,0.06); border-radius:16px; padding:22px 20px; text-align:center;
    box-shadow:0 30px 100px rgba(0,0,0,0.55), inset 0 0 0 1px rgba(255,255,255,0.02);
  }
  .preloader-head{display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:12px}
  .preloader-logo{
    width:42px;height:42px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;
  }
  .preloader-logo img{width:100%;height:100%;object-fit:contain}
  .preloader-title{font-weight:600; letter-spacing:0.4px}
  .loader{
    width:64px;height:64px;margin:2px auto 14px auto;
    background: url('assets/spinner.png') center/contain no-repeat;
    /* Changed from spin to a subtle pulse */
    animation:pulseLoader 1.4s ease-in-out infinite;
    transform-origin:center;
  }
  @keyframes pulseLoader{
    0%{ transform:scale(0.95); opacity:0.85; filter:drop-shadow(0 0 0 rgba(0,0,0,0.2)); }
    50%{ transform:scale(1.08); opacity:1; filter:drop-shadow(0 0 12px rgba(0,150,255,0.35)); }
    100%{ transform:scale(0.95); opacity:0.85; filter:drop-shadow(0 0 0 rgba(0,0,0,0.2)); }
  }
  #preloaderText{color:#cfe8ff;font-weight:600;letter-spacing:.4px;margin-bottom:8px}
  #preloaderBar{width:100%;height:10px;border-radius:999px;background:#202020;overflow:hidden;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.06); margin:0 auto}
  #preloaderBar>span{
    display:block;height:100%;width:0%;
    background:linear-gradient(90deg,#00b4ff,#6ee7ff,#a78bfa);
    background-size:200% 100%; animation:barShift 1.2s ease-in-out infinite;
    border-radius:999px;
  }
  @keyframes barShift{0%{background-position:0% 50%}100%{background-position:100% 50%}}

  /* ===========================================================
     Hint tooltip (one-time helper)
     =========================================================== */
  #hintTooltip{display:none;position:fixed;bottom:28px;left:28px;z-index:1200;background:linear-gradient(180deg,rgba(3,21,30,0.98),rgba(5,40,60,0.96));border-radius:12px;padding:12px 14px;border:2px solid rgba(0,194,255,0.15);box-shadow:0 12px 40px rgba(0,0,0,0.6),0 6px 18px rgba(0,194,255,0.06) inset;color:#e6f7ff;font-weight:600;font-size:1rem;display:flex;gap:12px;align-items:center;min-width:260px;max-width:360px;transform-origin:center bottom;will-change:transform,opacity,box-shadow;pointer-events:auto;-webkit-tap-highlight-color:transparent;opacity:0;transition:opacity 220ms var(--ease),transform 220ms var(--ease)}
  #hintTooltip .icon{width:44px;height:44px;flex:0 0 44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--accent-strong),var(--accent));box-shadow:0 6px 18px rgba(0,194,255,0.12);color:#012;font-size:18px}
  #hintTooltip::after{content:"";position:absolute;left:22px;bottom:-10px;width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:10px solid rgba(3,21,30,0.98);filter:drop-shadow(0 -4px 6px rgba(0,0,0,0.25))}
  @keyframes subtlePulse{0%{box-shadow:0 6px 18px rgba(0,194,255,0.12),0 0 0 0 rgba(0,194,255,0)}60%{box-shadow:0 10px 26px rgba(0,194,255,0.16),0 0 14px 6px rgba(0,194,255,0.06)}100%{box-shadow:0 6px 18px rgba(0,194,255,0.12),0 0 0 0 rgba(0,194,255,0)}}
  #hintTooltip.visible{display:flex;opacity:1;transform:translateY(0)}
  #hintTooltip .icon.pulse{animation:subtlePulse 1700ms ease-in-out infinite}
  #hintTooltip.glowy{animation:hintGlow 2200ms ease-in-out 1}
  #hintTooltip .text{line-height:1.1;font-size:.98rem}

  @media(max-width:420px){
    .card-inner{height:300px}
    .card .front-body{padding:6px}
    .add-notif{left:12px;right:12px;bottom:18px}
  }

  /* Simple fade-out for add-notif */
  @keyframes fadeOutDown{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(18px)}}

  /* ===========================================================
     Connection status toast (new)
     - Shows brief banner when the browser goes offline/online
     =========================================================== */
  #connectionToast{
    position:fixed; top:14px; right:14px;
    background:linear-gradient(180deg,rgba(3,21,30,0.98),rgba(5,40,60,0.96));
    border:1px solid rgba(0,194,255,0.2);
    color:#e6f7ff; padding:8px 12px; border-radius:8px;
    box-shadow:0 12px 40px rgba(0,0,0,0.6);
    z-index:10000; opacity:0; transform:translateY(-8px);
    pointer-events:none; transition:opacity 200ms var(--ease), transform 200ms var(--ease);
  }
  #connectionToast.visible{opacity:1; transform:translateY(0); pointer-events:auto}
  </style>
 
</head>
<body>

  <!--
    Core carousel utility shared by card carousels and the lightbox.
    Includes lazy loading, looping with clones, swipe/drag, zoom (lightbox),
    and accessible controls (keyboard, ARIA).
  -->
  <script>
  /* Utility: safely ensure an array of images (>=1) per product */
  function ensureImagesArray(p){
    let imgs = p.images || p.img || [];
    if (typeof imgs === 'string') imgs = [imgs];
    if (!Array.isArray(imgs)) imgs = [];
    imgs = imgs.filter(Boolean);
    if (!imgs.length) imgs = ['assets/placeholder.png'];
    return imgs;
  }

  /* Attach a fallback handler to an <img> DOM element to use placeholder on error */
  function attachImageFallback(imgEl){
    if(!imgEl) return;
    imgEl.addEventListener('error', () => {
      if(!imgEl.dataset.fallback){
        imgEl.dataset.fallback = "1";
        imgEl.src = 'assets/placeholder.png';
      }
    }, { once: false });
  }

  /* Lightbox global state (updated by open/close) */
  let lightboxState = {
    active: false,
    api: null, // carousel api for lightbox
    idleTimer: null
  };

  /* little helper */
  function money(n){return `R${Number(n).toFixed(2)}`;}

  /* Debounce utility */
  function debounce(fn, wait = 300){ let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); }}

  /* Preload helper with decode for smoother first paint */
  function preloadImage(src){
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = async () => {
        try { if (img.decode) await img.decode(); } catch(e){}
        resolve({src, ok:true});
      };
      img.onerror = () => resolve({src, ok:false});
      img.src = src;
    });
  }

  /* CAROUSEL helper with smart lazy-loading per slide (cards and lightbox share)
     containerEl: where carousel will be appended (image area)
     images: array of image URLs
     opts: { onImageClick, startIndex, loop, showDots, showButtons, showCounter, className, enableZoom, eagerFirst, getAlt }
     returns object {setIndex, getIndex, destroy, prev, next, refresh}
  */
  function createCarousel(containerEl, images, opts = {}){
    const {
      onImageClick = function(){},
      startIndex = 0,
      loop = true,
      showDots = true,
      showButtons = true,
      showCounter = true,
      className = 'carousel',
      enableZoom = false,
      eagerFirst = false,
      getAlt = (i,total) => `Product image ${i+1} of ${total}`
    } = opts;

    const total = images.length || 1;
    containerEl.innerHTML = '';
    containerEl.classList.add(...className.split(' ').filter(Boolean));

    const track = document.createElement('div');
    track.className = 'carousel-track';

    // Build slides with optional clones for looping
    let slides = [];
    const makeSlide = (src, realIdx, isClone=false) => {
      const slide = document.createElement('div');
      slide.className = 'carousel-slide';
      slide.dataset.realIndex = String(realIdx);
      const altText = getAlt(realIdx, total);

      // Skeleton shimmer overlay for card carousels (not in lightbox)
      let skeleton = null;
      if(!enableZoom){
        skeleton = document.createElement('div');
        skeleton.className = 'img-skeleton';
        skeleton.setAttribute('aria-hidden','true');
        slide.appendChild(skeleton);
      }

      if(enableZoom){
        const zoomWrap = document.createElement('div');
        zoomWrap.className = 'zoom-wrap';
        const img = document.createElement('img');
        img.className = 'zoom-img';
        img.draggable = false;
        img.loading = 'eager';
        img.decoding = 'async';
        img.alt = altText;
        img.dataset.src = src || 'assets/placeholder.png';
        attachImageFallback(img);
        zoomWrap.appendChild(img);
        slide.appendChild(zoomWrap);
      } else {
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.decoding = 'async';
        // We avoid alt on card carousel images to reduce duplicate verbosity; lightbox provides alts
        img.dataset.src = src || 'assets/placeholder.png';
        attachImageFallback(img);
        // Remove the skeleton overlay when image loads
        img.addEventListener('load', () => {
          if(skeleton && skeleton.parentNode){ skeleton.parentNode.removeChild(skeleton); }
        }, { once: true });
        // If image already cached and complete, remove skeleton immediately
        queueMicrotask(() => {
          if(img.complete && img.naturalWidth > 0 && skeleton && skeleton.parentNode){
            skeleton.parentNode.removeChild(skeleton);
          }
        });
        img.addEventListener('click', (e) => {
          e.stopPropagation();
          onImageClick(realIdx, images[realIdx]);
        });
        slide.appendChild(img);
      }
      if(isClone) slide.dataset.clone = '1';
      return slide;
    };

    const useLoop = loop && total > 1;
    if(useLoop){
      slides.push(makeSlide(images[total-1], total-1, true));
    }
    images.forEach((src, i) => slides.push(makeSlide(src, i, false)));
    if(useLoop){
      slides.push(makeSlide(images[0], 0, true));
    }
    slides.forEach(s => track.appendChild(s));
    containerEl.appendChild(track);

    // controls
    let dots = null, prevBtn = null, nextBtn = null, counter = null, ctrlWrap = null;
    if(total > 1){
      if(showButtons){
        ctrlWrap = document.createElement('div');
        ctrlWrap.className = 'carousel-controls';
        prevBtn = document.createElement('button');
        prevBtn.className = 'carousel-btn';
        prevBtn.type = 'button';
        prevBtn.setAttribute('aria-label','Previous image');
        prevBtn.innerHTML = '<i class="fas fa-angle-left" aria-hidden="true"></i>';
        nextBtn = document.createElement('button');
        nextBtn.className = 'carousel-btn';
        nextBtn.type = 'button';
        nextBtn.setAttribute('aria-label','Next image');
        nextBtn.innerHTML = '<i class="fas fa-angle-right" aria-hidden="true"></i>';
        ctrlWrap.appendChild(prevBtn);
        ctrlWrap.appendChild(nextBtn);
        containerEl.appendChild(ctrlWrap);
      }

      if(showDots){
        dots = document.createElement('div');
        dots.className = 'carousel-dots';
        for(let i=0;i<total;i++){
          const d = document.createElement('button');
          d.className = 'carousel-dot';
          d.type = 'button';
          d.setAttribute('aria-label', `Show image ${i+1}`);
          d.addEventListener('click', (e) => { e.stopPropagation(); goTo(i, true); });
          dots.appendChild(d);
        }
        containerEl.appendChild(dots);
      }

      if(showCounter){
        counter = document.createElement('div');
        counter.className = 'carousel-counter';
        counter.setAttribute('aria-hidden','false');
        containerEl.appendChild(counter);
      }
    } else {
      if(!enableZoom){
        track.style.cursor = 'pointer';
      }
    }

    // State
    let realIndex = Math.min(Math.max(0, startIndex|0), total-1);
    let trackIndex = useLoop ? realIndex + 1 : realIndex;
    let isTransitioning = false;

    // Lazy-load helpers: load current and neighbors
    function imagesForRealIndex(idx){
      const arr = [];
      slides.forEach(sl => {
        if(Number(sl.dataset.realIndex) === idx){
          const img = enableZoom ? sl.querySelector('img.zoom-img') : sl.querySelector('img');
          if(img) arr.push(img);
        }
      });
      return arr;
    }
    function ensureLoaded(idx, priority='auto'){
      const imgs = imagesForRealIndex(idx);
      imgs.forEach(img => {
        if(img.dataset.loaded === '1') return;
        const src = img.dataset.src || 'assets/placeholder.png';
        if(!img.src || img.src.endsWith('placeholder.png')) img.src = src;
        img.dataset.loaded = '1';
        if(priority === 'high'){ try{ img.fetchPriority = 'high'; }catch(e){} }
      });
    }
    function ensureLoadedAround(idx, priorityCenter='auto'){
      ensureLoaded(idx, priorityCenter);
      ensureLoaded((idx - 1 + total) % total);
      ensureLoaded((idx + 1) % total);
    }

    function updateUI(noAnim=false){
      const width = containerEl.getBoundingClientRect().width || 1;
      if(noAnim){ track.style.transition = 'none'; }
      const offset = -trackIndex * Math.round(width);
      track.style.transform = `translateX(${offset}px)`;
      if(dots){
        const dotButtons = dots.querySelectorAll('.carousel-dot');
        dotButtons.forEach((d, i) => d.classList.toggle('active', i === realIndex));
      }
      if(counter){
        counter.textContent = `${realIndex + 1}/${total}`;
      }
      if(noAnim){
        void track.offsetWidth;
        track.style.transition = '';
      }
      // Ensure current and neighbors are loaded
      ensureLoadedAround(realIndex);
    }

    function instantWrapIfOnClone(){
      if(!useLoop) return;
      if(trackIndex === 0){
        trackIndex = total;
        realIndex = total - 1;
        updateUI(true);
      } else if(trackIndex === total + 1){
        trackIndex = 1;
        realIndex = 0;
        updateUI(true);
      }
    }

    track.addEventListener('transitionend', () => {
      if(!useLoop) return;
      if(trackIndex === 0){
        isTransitioning = true;
        track.style.transition = 'none';
        trackIndex = total;
        realIndex = total - 1;
        updateUI();
        void track.offsetWidth;
        track.style.transition = '';
        isTransitioning = false;
      } else if(trackIndex === total + 1){
        isTransitioning = true;
        track.style.transition = 'none';
        trackIndex = 1;
        realIndex = 0;
        updateUI();
        void track.offsetWidth;
        track.style.transition = '';
        isTransitioning = false;
      }
    });

    function prev(){
      if(isTransitioning) return;
      instantWrapIfOnClone();
      isTransitioning = true;
      trackIndex -= 1;
      if(!useLoop){
        if(trackIndex < 0){ trackIndex = 0; }
        realIndex = trackIndex;
        updateUI();
        setTimeout(()=> isTransitioning=false, 320);
      } else {
        realIndex = (realIndex - 1 + total) % total;
        updateUI();
        setTimeout(()=> { isTransitioning=false; instantWrapIfOnClone(); }, 320);
      }
    }
    function next(){
      if(isTransitioning) return;
      instantWrapIfOnClone();
      isTransitioning = true;
      trackIndex += 1;
      if(!useLoop){
        if(trackIndex > total - 1){ trackIndex = total - 1; }
        realIndex = trackIndex;
        updateUI();
        setTimeout(()=> isTransitioning=false, 320);
      } else {
        realIndex = (realIndex + 1) % total;
        updateUI();
        setTimeout(()=> { isTransitioning=false; instantWrapIfOnClone(); }, 320);
      }
    }
    function goTo(idx, animate=true){
      idx = Math.min(Math.max(0, idx|0), total-1);
      realIndex = idx;
      trackIndex = useLoop ? realIndex + 1 : realIndex;
      if(!animate){ updateUI(true); } else { updateUI(); }
    }

    // Init
    ensureLoadedAround(realIndex, eagerFirst ? 'high' : 'auto');
    updateUI(true);

    // controls events
    if(prevBtn) prevBtn.addEventListener('click', (e)=> { e.stopPropagation(); prev(); });
    if(nextBtn) nextBtn.addEventListener('click', (e)=> { e.stopPropagation(); next(); });

    // swipe support
    let startX = 0, startY = 0, isDragging = false, moved = false, dragDX = 0;
    const touchStart = (x, y) => {
      isDragging = true; moved = false; dragDX = 0;
      startX = x; startY = y;
      track.style.transition = 'none';
    };
    const touchMove = (x, y, e) => {
      if(!isDragging) return;
      const dx = x - startX;
      const dy = y - startY;
      if(Math.abs(dy) > Math.abs(dx)) { return; }
      moved = true;
      dragDX = dx;
      const width = containerEl.getBoundingClientRect().width || 1;
      const offset = -trackIndex * width + dx;
      track.style.transform = `translateX(${offset}px)`;
      if(e) e.preventDefault();
    };
    const touchEnd = () => {
      if(!isDragging) return;
      isDragging = false;
      track.style.transition = '';
      if(!moved){ updateUI(); return; }
      const width = containerEl.getBoundingClientRect().width || 1;
      const threshold = Math.max(40, width * 0.18);
      if(dragDX > threshold) prev();
      else if(dragDX < -threshold) next();
      else updateUI();
    };

    track.addEventListener('touchstart', (e) => {
      if(e.touches.length !== 1) return;
      touchStart(e.touches[0].clientX, e.touches[0].clientY);
    }, {passive:true});
    track.addEventListener('touchmove', (e) => {
      if(!isDragging) return;
      touchMove(e.touches[0].clientX, e.touches[0].clientY, e);
    }, {passive:false});
    track.addEventListener('touchend', () => touchEnd());

    // mouse drag support (desktop)
    let mouseDown = false, mouseStartX = 0, mouseStartY = 0;
    track.addEventListener('mousedown', (e) => {
      mouseDown = true; mouseStartX = e.clientX; mouseStartY = e.clientY; track.style.transition = 'none'; e.preventDefault();
    });
    window.addEventListener('mousemove', (e) => {
      if(!mouseDown) return;
      const dx = e.clientX - mouseStartX;
      const dy = e.clientY - mouseStartY;
      if(Math.abs(dy) > Math.abs(dx)) return;
      moved = true; dragDX = dx;
      const width = containerEl.getBoundingClientRect().width || 1;
      const offset = -trackIndex * width + dx;
      track.style.transform = `translateX(${offset}px)`;
    });
    window.addEventListener('mouseup', (e) => {
      if(!mouseDown) return;
      mouseDown = false; track.style.transition = '';
      const dx = e.clientX - mouseStartX;
      const width = containerEl.getBoundingClientRect().width || 1;
      const threshold = Math.max(40, width * 0.18);
      if(dx > threshold) prev();
      else if(dx < -threshold) next();
      else updateUI();
    });

    // keyboard navigation
    containerEl.tabIndex = 0;
    containerEl.addEventListener('keydown', (e) => {
      if(e.key === 'ArrowLeft') { e.preventDefault(); prev(); }
      if(e.key === 'ArrowRight') { e.preventDefault(); next(); }
    });

    // resize observer -> keep correct offset
    const ro = new ResizeObserver(()=> updateUI(true));
    ro.observe(containerEl);

    function resetAllZooms(){
      if(!enableZoom) return;
      slides.forEach(sl => { if(typeof sl._resetZoom === 'function') sl._resetZoom(); });
    }

    // If zoom enabled, set it up per slide
    (function setupZoomHandlers(){
      if(!enableZoom) return;
      slides.forEach((sl) => {
        const wrap = sl.querySelector('.zoom-wrap');
        const img = sl.querySelector('img.zoom-img');
        if(!wrap || !img) return;
        let scale = 1;
        let minScale = 1;
        let maxScale = 4;
        let tx = 0, ty = 0;
        let panning = false;
        let lastX = 0, lastY = 0;

        function applyTransform(){
          img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
          if(scale > 1){ wrap.dataset.zoomed = '1'; } else { delete wrap.dataset.zoomed; }
        }
        function clampPan(){
          const rect = wrap.getBoundingClientRect();
          const imgW = rect.width * scale;
          const imgH = rect.height * scale;
          const maxX = Math.max(0, (imgW - rect.width)/2);
          const maxY = Math.max(0, (imgH - rect.height)/2);
          tx = Math.min(maxX, Math.max(-maxX, tx));
          ty = Math.min(maxY, Math.max(-maxY, ty));
        }
        function zoomAt(pointX, pointY, deltaScale){
          const rect = wrap.getBoundingClientRect();
          const prevScale = scale;
          scale = Math.min(maxScale, Math.max(minScale, scale * deltaScale));
          const cx = pointX - rect.left - rect.width/2;
          const cy = pointY - rect.top - rect.height/2;
          tx = (tx - cx) * (scale/prevScale) + cx;
          ty = (ty - cy) * (scale/prevScale) + cy;
          clampPan(); applyTransform();
        }

        // Wheel zoom (desktop)
        wrap.addEventListener('wheel', (e) => {
          e.preventDefault();
          const delta = e.deltaY < 0 ? 1.12 : 0.9;
          zoomAt(e.clientX, e.clientY, delta);
        }, { passive:false });

        // Double click to toggle zoom
        let lastClick = 0;
        wrap.addEventListener('click', (e) => {
          const now = Date.now();
          if(now - lastClick < 280){
            e.stopPropagation();
            if(scale > 1){
              scale = 1; tx = 0; ty = 0; applyTransform();
            } else {
              zoomAt(e.clientX, e.clientY, 2);
            }
          }
          lastClick = now;
        });

        // Pan when zoomed
        wrap.addEventListener('pointerdown', (e) => {
          if(scale === 1) return;
          panning = true; wrap.setPointerCapture(e.pointerId);
          lastX = e.clientX; lastY = e.clientY;
        });
        wrap.addEventListener('pointermove', (e) => {
          if(!panning) return;
          const dx = e.clientX - lastX;
          const dy = e.clientY - lastY;
          lastX = e.clientX; lastY = e.clientY;
          tx += dx; ty += dy; clampPan(); applyTransform();
        });
        wrap.addEventListener('pointerup', (e) => { panning = false; try{wrap.releasePointerCapture(e.pointerId);}catch(_e){} });
        wrap.addEventListener('pointercancel', () => { panning = false; });

        // Pinch-to-zoom (touch)
        let pinch = { active:false, startDist:0, startScale:1, centerX:0, centerY:0 };
        wrap.addEventListener('touchstart', (e) => {
          if(e.touches.length === 2){
            pinch.active = true;
            const [t0,t1] = e.touches;
            pinch.startDist = Math.hypot(t1.clientX - t0.clientX, t1.clientY - t0.clientY);
            pinch.startScale = scale;
            pinch.centerX = (t0.clientX + t1.clientX)/2;
            pinch.centerY = (t0.clientY + t1.clientY)/2;
          }
        }, {passive:true});
        wrap.addEventListener('touchmove', (e) => {
          if(pinch.active && e.touches.length === 2){
            e.preventDefault();
            const [t0,t1] = e.touches;
            const dist = Math.hypot(t1.clientX - t0.clientX, t1.clientY - t0.clientY);
            const delta = dist / (pinch.startDist || 1);
            scale = Math.min(maxScale, Math.max(minScale, pinch.startScale * delta));
            zoomAt(pinch.centerX, pinch.centerY, 1);
          }
        }, {passive:false});
        wrap.addEventListener('touchend', () => { pinch.active = false; }, {passive:true});

        // Reset zoom when slide becomes inactive
        const resetZoom = () => { scale = 1; tx = 0; ty = 0; applyTransform(); };
        sl._resetZoom = resetZoom;
      });
    })();

    // Public API
    return {
      setIndex: (i) => { goTo(i, false); resetAllZooms(); },
      getIndex: () => realIndex,
      prev: () => { prev(); },
      next: () => { next(); },
      refresh: () => { updateUI(true); }, // force realign
      destroy: () => { try{ ro.disconnect(); }catch(e){} containerEl.innerHTML = ''; }
    };
  }
  </script>
  <!-- Skip navigation for screen readers and keyboard users -->
  <a href="#mainContent" class="skip-link">Skip to main content</a>

  <!-- Initial preloader shown while fonts + a couple critical images warm up -->
  <div id="preloader">
    <div class="preloader-card" aria-live="polite" aria-busy="true">
      <div class="preloader-head"></div>
      <div class="loader" aria-hidden="true"></div>
      <div id="preloaderText">Loading…</div>
      <div id="preloaderBar" aria-hidden="true"><span></span></div>
    </div>
  </div>

  <!-- Toast: add-to-cart feedback -->
  <div id="addNotif" class="add-notif" role="status" aria-live="polite" aria-atomic="true">
    <img id="addNotifThumb" class="product-thumb" src="" alt="">
    <div id="addNotifMsg" class="msg">Product added to cart</div>
    <button id="undoAddBtn" class="undo-btn" aria-label="Undo add">Undo</button>
    <button id="closeAddNotif" class="close-btn" aria-label="Dismiss"><i class="fas fa-times" aria-hidden="true"></i></button>
  </div>

  <!-- Toast: share feedback -->
  <div id="shareNotif" class="share-notif" role="status" aria-live="polite" aria-atomic="true">
    <div style="display:flex;align-items:center;gap:10px">
      <i class="fas fa-link" aria-hidden="true" style="font-size:18px"></i>
      <span id="shareNotifMsg" style="font-weight:600">Link copied!</span>
    </div>
  </div>

  <!-- Quick usage hint after first load: cards flip -->
  <div id="hintTooltip" role="note" aria-hidden="true">
    <div class="icon" aria-hidden="true"><i class="fas fa-hand-pointer"></i></div>
    <div class="text">Cards flip -- click to see more!</div>
  </div>

  <!-- Scroll to top floating button -->
  <a id="scrollToTopBtn" href="#" role="button" aria-label="Scroll to top" tabindex="0"><i class="fas fa-angle-up" aria-hidden="true"></i></a>

  <!-- Connection status toast (online/offline) -->
  <div id="connectionToast" role="status" aria-live="polite" aria-atomic="true"></div>

  <!-- Sticky header with logo, search, Info (desktop), and cart -->
  <header>
    <div class="top-row">
      <!-- Brand -->
      <div class="logo"><a href="./"><img src="assets/favicon.png" alt="Drift Threads logo"></a></div>

      <!-- Search -->
      <div class="search-wrap">
        <div class="search-box">
          <input id="searchInput" type="text" placeholder="Search products..." aria-label="Search products" inputmode="search">
          <button id="clearBtn" type="button" aria-label="Clear search" title="Esc clears search"><i class="fas fa-times" aria-hidden="true"></i></button>
        </div>
        <button id="searchBtn" type="button" aria-label="Search" style="border-radius:5px 25px 25px 5px"><i class="fas fa-search" aria-hidden="true"></i></button>
      </div>

      <!-- Desktop-only Info button (requested change) 
      <div id="headerInfoWrap" class="header-info-wrap">
        <button id="headerInfoBtn" class="info-btn" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="headerInfoTooltip" title="Important info">
          <span class="icon" aria-hidden="true">⚠️</span>
          <span class="label" style="font-weight:600">Info <i class="fas fa-angle-down" aria-hidden="true" style="padding-left: 5px;"></i></span>
        </button>
        <div id="headerInfoTooltip" class="tooltip" role="tooltip" aria-live="polite" aria-hidden="true">
          <div class="tt-title">Heads up!</div>
          <div class="tt-body">
  <b>Note:</b> Product images may not fully capture the real look.<br>
  Some visuals are AI-assisted and can appear slightly off.<br>
  Hoodies are printed in high-definition -- they look sharper in real life.<br>
  Expect the actual product to look better than the preview images.
</div>
        </div>
      </div>
-->
      <!-- Cart -->
      <div id="cartBtn" role="button" tabindex="0" aria-label="Shopping cart" style="position:relative">
        <i class="fas fa-shopping-cart" aria-hidden="true"></i>
        <span id="cartCount">0</span>
      </div>
    </div>
  </header>

  <!-- Categories nav -->
  <nav class="cat-bar" role="tablist" aria-label="Product categories" id="catBar">
    <button class="cat-btn active" data-cat="all" type="button" aria-current="true">All</button>
    <button class="cat-btn" data-cat="hoodies" type="button">Hoodies</button>
    <button class="cat-btn" data-cat="mugs" type="button">Mugs</button>
    <button class="cat-btn" data-cat="supplements" type="button">Supplements</button>
    <button class="cat-btn" data-cat="couples" type="button">Couples</button>
    <button class="cat-btn" data-cat="tees" type="button">Tees</button>
    <button class="cat-btn" data-cat="hats" type="button">Hats</button>
    <button class="cat-btn" data-cat="accessories" type="button">Accessories</button>
    <button class="cat-btn" data-cat="stickers" type="button">Stickers</button>
    <button class="cat-btn" data-cat="bags" type="button">Bags</button>
    <button class="cat-btn" data-cat="other" type="button">Other</button>
    <div class="cat-scroll-hint" id="catScrollHint" aria-hidden="true"></div>
  </nav>
  <button id="showAllCatsBtn" type="button" aria-label="Show all categories" style="padding-left: 20px;">Show all</button>

  <!-- Global info bar (mobile). On desktop this is hidden; desktop uses the header Info button. -->
  <div id="productInfoBar" aria-label="Important info">
    <div id="productCount" role="status" aria-live="polite">0 items</div>
    <button id="globalInfoBtn" class="info-btn" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="globalInfoTooltip" title="Important info">
      <span class="icon" aria-hidden="true">⚠️</span><span class="label" style="font-weight:600">Info <i class="fas fa-angle-down" aria-hidden="true" style="padding-left: 5px;"></i></span>
    </button>
    <div id="globalInfoTooltip" class="tooltip" role="tooltip" aria-live="polite" aria-hidden="true">
      <div class="tt-title">Heads up!</div>
      <div class="tt-body">
        <b>Images</b> may appear slightly different from real life.<br>
        Some visuals are digitally enhanced or AI-assisted for presentation.<br>
        Hoodies are printed with high-definition graphics only.<br>
        Actual products may vary due to distortion or scaling during digital processes.
      </div>
    </div>
  </div>

  <!-- Main product grid -->
  <main id="mainContent">
    <section id="grid" aria-live="polite" aria-busy="false"></section>
    <div id="loadingSpinner" style="display:none"><i class="fas fa-spinner fa-pulse fa-2x" aria-hidden="true"></i></div>
  </main>

  <hr>
      <footer>

      <div>
        <img src="assets/wide_logo.png" alt="DriftThreads Logo" class="footer-img" style="border-radius: 10px;"><br>
        © DriftThreads<br>Streetwear built to drift -- Only in Joburg.

        <br><br><a href="..">Main</a> •
        <a href="../blogs">Blogs</a> •  
        <a href="../contact">Contacts</a> 
      </div>
      <div class="muted">
        <br><br>
        <a href="https://www.instagram.com/driftthreads.official/"><i class="fab fa-instagram" style="margin-right:5px;"></i>driftthreads.official</a>
        <br><a href="https://www.tiktok.com/@driftthreads.official/"><i class="fab fa-tiktok" style="margin-right:5px;"></i>driftthreads.official</a>
       
      
        </div>



    </footer>


  <!-- Cart modal -->
  <div id="cartModal" class="cart-modal" aria-hidden="true">
    <div class="cart-content" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
      <button id="closeCart" type="button" aria-label="Close cart"><i class="fas fa-times" aria-hidden="true"></i></button>
      <h2 id="cartTitle" style="font-weight:600; margin-top:0;">Your Cart</h2>
      <div id="cartItems" class="cart-items" style="margin-bottom:12px"></div>
      <div class="cart-footer" aria-hidden="false">
        <div class="left">
          <div style="color:var(--muted)"><strong class="subtotal-label" style="font-weight:600;">Subtotal:</strong> <span id="cartTotal" class="subtotal">R0.00</span></div>
        </div>
        <div class="right" style="display:flex;gap:8px;align-items:center;position:relative">
          <button id="clearCartBtn" type="button">Clear</button>
          <button id="waOrderBtn" class="wa-btn" type="button" aria-label="Order now via WhatsApp"><i class="fab fa-whatsapp" aria-hidden="true"></i> Order</button>
          <!-- Legacy cart info button retained but hidden globally -->
          <button id="cartInfoBtn" class="info-btn" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="cartInfoTooltip" title="Important info">
            <span class="label" style="font-weight:700">⚠️</span>
          </button>
          <div id="cartInfoTooltip" class="tooltip" role="tooltip" aria-live="polite" aria-hidden="true">
            <div class="tt-title">Heads up!</div>
            <div class="tt-body">
              <b>Images</b> may appear slightly different from real life.<br>
              Some visuals are digitally enhanced or AI-assisted for presentation.<br>
              Hoodies are printed with high-definition graphics only.<br>
              Actual products may vary due to distortion or scaling during digital processes.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lightbox (full-screen images) -->
  <div id="imgLightbox" class="lightbox" aria-hidden="true" tabindex="-1">
    <button id="closeLightbox" type="button" aria-label="Close image" style="position:absolute;right:18px;top:18px;background:transparent;border:0;color:#fff;font-size:22px;z-index:2"><i class="fas fa-times" aria-hidden="true"></i></button>
    <div class="lb-frame" id="lbFrame" aria-live="polite"></div>
  </div>

  <!--
    App logic (products, rendering, filtering, cart, lightbox, desktop/mobile info, UX niceties).
    This section is heavily annotated to guide future feature development.
  -->
  <script>
  /* --- Data: products now use arrays of images (one or more) --- */
  const sponsors = [
    {id:'spon-1',title:'DriftThreads Blogs',img:'assets/logo.png',url:'/blogs',description:'Bored? Read some of our blogs! 🙃',badge:'Sponsored'}
  ];

  const products = [
    {
      title: 'Drift Threads™ Hoodie',
      price: 700,
      cat: 'hoodies',
      img: [
        'products/hoodies/driftthreads_hoodie.jpeg',
        'products/hoodies/driftthreads_hoodie(2).jpeg',
        'products/hoodies/driftthreads_hoodie(3).jpeg'
      ],
      description: "Soft inside, tough outside -- the hoodie that rides with you anywhere",
      badge: 'Official'
    },
    {
      title: 'Gua Sha + Face Roller (Jade)',
      price: 150,
      cat: 'other',
      img: [
        'products/other/gua_sha.jpeg',
        'products/other/gua_sha(2).jpeg',
        'products/other/gua_sha(3).jpeg',
        'products/other/gua_sha(4).jpeg',
        'products/other/gua_sha(5).jpeg',
        'products/other/gua_sha(6).jpeg',
        'products/other/gua_sha(7).jpeg',
        'products/other/gua_sha(8).jpeg',
        'products/other/gua_sha(9).jpeg'
      ],
      description: "Traditional Chinese scraping tool -- made from pure Jade Stone",
      badge: 'Hot 🔥'
    },
    {
      title: '"Boss" Couples Hoodie (2)',
      price: 1200,
      cat: 'couples',
      img: [
        'products/couples/boss_couples_hoodie.jpeg',
        'products/couples/boss_couples_hoodie(1).jpeg',
        'products/couples/boss_couples_hoodie(2).jpeg'
      ],
      description: 'Power couple energy -- twin hoodies for maximum flex and matching vibes',
      badge: 'Hot'
    },
    {
      title: 'Tokyo Revengers Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/tokyo_revengers.jpeg'],
      description: "Rep the gang, rep the streets -- Tokyo Revengers style",
      badge: ''
    },
    {
      title: '911 GT3 RS Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/911_gt3_rs.jpeg'],
      description: "Porsche vibes, street-ready fit -- feel the speed in every stitch",
      badge: ''
    },
    {
      title: 'Akatsuki Hoodie',
      price: 750,
      cat: 'hoodies',
      img: ['products/hoodies/akatsuki.jpeg'],
      description:"Naruto’s legendary Akatsuki clouds, now on a hoodie -- menace approved",
      badge:''
    },
    {
      title: 'BMW Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/bmw.jpeg'],
      description:"Roll in style -- 'I need money for BMW' never looked this clean",
      badge:''
    },
    {
      title: 'Kakashi Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/kakashi.jpeg'],
      description:"Stealthy, iconic, and stylish -- Kakashi fanart hoodie for true anime heads",
      badge:''
    },
    {
      title: 'Monkey D. Luffy Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/monkey_d_luffy.jpeg'],
      description:"Set sail with Luffy -- One Piece vibes, maximum hype",
      badge:''
    },
    {
      title: 'Tokyo Ghoul Hoodie',
      price: 520,
      cat: 'hoodies',
      img: ['products/hoodies/tokyo_ghoul.jpeg'],
      description:"Dark, edgy, and savage -- Tokyo Ghoul energy for your streetwear",
      badge:'20% Off'
    },
    {
      title: 'BMW M Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/bmw_m.jpeg'],
      description:"BMW M series inspired hoodie -- engineered for flexing",
      badge:''
    },
    {
      title: 'One Piece Bros Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/one_piece_bros.jpeg'],
      description:"Luffy, Ace & Sabo -- the ultimate brotherhood, ultimate flex",
      badge:''
    },
    {
      title: 'Batman Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/batman.jpeg'],
      description:"Own the night -- Dark Knight vibes in hoodie form",
      badge:''
    },
    {
      title: 'Retrowave BMW M3 E46 Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/retrowave_m3_e46.jpeg'],
      description:"Retro neon meets Bavarian muscle -- E46 M3 reimagined in retrowave drip",
      badge:''
    },
    {
      title: 'Mustang White Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/mustang_white.jpeg'],
      description:"American muscle, timeless legend -- Mustang power stitched into street-ready comfort",
      badge:''
    },
    {
      title: 'Dodge Black Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/dodge_hellcat.jpeg'],
      description:"Hellcat attitude, midnight energy-- Dodge muscle reimagined as everyday drip",
      badge:''
    },
    {
  title: 'Demon Slayer Tee',
  price: 300,
  cat: 'tees',
  img: ['products/tees/demon_slayer.jpeg'],
  description: "Breath of drip -- Demon Slayer design locked onto a clean street tee",
  badge: ''
},
{
  title: 'Satoru Gojo Tee',
  price: 300,
  cat: 'tees',
  img: ['products/tees/satoru_gojo.jpeg'],
  description: "Infinity-level flex -- Gojo reimagined for casual streetwear",
  badge: ''
},
{
  title: 'Ultra Instinct Hoodie',
  price: 650,
  cat: 'hoodies',
  img: ['products/hoodies/ultra_instinct.jpeg'],
  description: "Goku’s ultimate form -- Ultra Instinct energy stitched into hoodie perfection",
  badge: ''
},
{
  title: 'Naruto Tee',
  price: 300,
  cat: 'tees',
  img: ['products/tees/naruto.jpeg'],
  description: "The legendary orange logo itself -- Naruto drip in tee form",
  badge: ''
},
{
  title: 'Sukuna Tee',
  price: 400,
  cat: 'tees',
  img: ['products/tees/sukuna.jpeg'],
  description: "The King of Curses, printed with menace -- Sukuna energy unleashed",
  badge: ''
},
    {
      title: 'McLaren Brown Hoodie',
      price: 700,
      cat: 'hoodies',
      img: ['products/hoodies/mclaren_brown.jpeg', 'products/hoodies/mclaren_brown(2).jpeg'],
      description:"Track-bred precision, street-certified flex -- McLaren speed in hoodie form",
      badge:''
    },
    /* {
      title: 'McLaren Blue Hoodie',
      price: 700,
      cat: 'hoodies',
      img: ['products/hoodies/mclaren_blue.jpeg','products/hoodies/mclaren_blue(2).jpeg'],
      description:"Exotic curves, raw performance -- McLaren vibes for those who live fast",
      badge:''
    }, */
    {
      title: 'Gojo Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/gojo.jpeg'],
      description:"Gojo style, endless charm -- Jujutsu Kaisen energy unlocked",
      badge:''
    },
    {
      title: 'Satoru Gojo Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/satoru_gojo.jpeg'],
      description:"For the real Gojo stans -- keep your style untouchable",
      badge:''
    },
    {
      title: 'Hellcat Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/hellcat_hoodie.jpeg'],
      description:'Supercharged swagger -- Hellcat muscle meets streetwear drip',
      badge:''
    },
    {
      title: 'Primitive Hellcat Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/prmtv_hellcat_hoodie.jpeg'],
      description:'Aggressive style, street-ready edge -- Hellcat vibes turned hoodie perfection',
      badge:''
    },
    {
      title: 'Straw Hats Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/straw_hats.jpeg'],
      description:"One Piece Straw Hats logo hoodie -- ride the Grand Line in style",
      badge:''
    },
    {
  title: 'F1 Aston Martin Hoodie',
  price: 700,
  cat: 'hoodies',
  img: ['products/hoodies/f1_aston_martin.jpeg'],
  description: "Silver Arrows speed, stitched for the streets -- Mercedes AMG energy in hoodie form",
  badge: ''
},
{
  title: 'Gear 5 Nike Hoodie',
  price: 750,
  cat: 'hoodies',
  img: ['products/hoodies/gear5_nike.jpeg'],
  description: "Luffy Gear 5 meets Nike swagger -- anime drip fused with street legend style",
  badge: ''
},
{
  title: 'Porsche 911 Purple Hoodie',
  price: 700,
  cat: 'hoodies',
  img: ['products/hoodies/porsche_911_purple.jpeg'],
  description: "Royal vibes on a Stuttgart icon -- Porsche 911 flex in purple haze",
  badge: ''
},
{
  title: 'BMW M4 Hoodie',
  price: 700,
  cat: 'hoodies',
  img: ['products/hoodies/bmw_m4.webp'],
  description: "Bavarian beast, redefined -- M4 aggression printed for everyday drip",
  badge: ''
},
{
  title: 'GTR Nismo Hoodie',
  price: 750,
  cat: 'hoodies',
  img: ['products/hoodies/gtr_nismo.jpeg'],
  description: "Godzilla unleashed -- Nismo energy stitched for true JDM fans",
  badge: ''
},
{
  title: 'Skyline R34 Hoodie',
  price: 700,
  cat: 'hoodies',
  img: ['products/hoodies/skyline_r34.jpeg'],
  description: "R34 legend, timeless flex -- Skyline dreams turned into wearable drip",
  badge: ''
},
{
  title: 'BMW Pink Haze Hoodie',
  price: 680,
  cat: 'hoodies',
  img: ['products/hoodies/bmw_pink.jpeg'],
  description: "Bold color, Bavarian power -- BMW vibes with pink heat",
  badge: ''
},
{
  title: 'GTRS Red Beam Hoodie',
  price: 720,
  cat: 'hoodies',
  img: ['products/hoodies/gtrs_red_beam.jpeg'],
  description: "Twin turbo legend lit in crimson energy -- GTRS meet red beam chaos",
  badge: ''
},
{
  title: 'Supra Japan Hoodie',
  price: 700,
  cat: 'hoodies',
  img: ['products/hoodies/supra_japan.jpeg'],
  description: "Toyota’s icon repping the homeland -- JDM Supra hoodie with raw heritage",
  badge: ''
},
{
  title: 'Dodge Charger Hoodie',
  price: 680,
  cat: 'hoodies',
  img: ['products/hoodies/dodge_charger.jpeg'],
  description: "American muscle dominance -- Charger attitude built for the streets",
  badge: ''
},
{
  title: 'Lamborghini Huracan Hoodie',
  price: 750,
  cat: 'hoodies',
  img: ['products/hoodies/lambo_huracan.jpeg'],
  description: "Exotic fury, raging bull vibes -- Huracan spirit stitched into a hoodie",
  badge: ''
},
{
  title: 'The Speed Community Hoodie',
  price: 650,
  cat: 'hoodies',
  img: ['products/hoodies/the_speed_community.jpeg'],
  description: "For the car culture family -- speed, unity, and drip stitched as one",
  badge: ''
},
{
  title: 'F1 Red Bull Hoodie',
  price: 720,
  cat: 'hoodies',
  img: ['products/hoodies/f1_redbull.jpeg'],
  description: "Max power, team Red Bull vibes -- Formula 1 energy reimagined in streetwear",
  badge: ''
},
{
  title: 'Porsche 911 Petals Hoodie',
  price: 700,
  cat: 'hoodies',
  img: ['products/hoodies/porsche_911_petals.jpeg'],
  description: "Performance and elegance collide -- Porsche 911 wrapped in floral drip",
  badge: ''
},
    {
  title: 'Nasty Hoodie',
  price: 650,
  cat: 'hoodies',
  img: ['products/hoodies/nasty_hoodie.jpeg'],
  description: 'Bold, unapologetic streetwear energy -- drip hard with \'choeff\' vibes',
  badge: ''
},
{
  title: 'Nasty Juice Hoodie',
  price: 650,
  cat: 'hoodies',
  img: ['products/hoodies/nasty_juice_hoodie.jpeg'],
  description: 'Fresh flavors, fresh fit -- channel Nasty Juice energy on the streets',
  badge: ''
},
    {
      title: 'Drift Threads™ Mug',
      price: 150,
      cat: 'mugs',
      img: ['products/mugs/driftthreads_mug.jpeg'],
      description:"Morning coffee, leveled up -- Drift Threads™ approved",
      badge:'Official'
    },
    {
      title: 'Drift Threads™ Mug (White)',
      price: 150,
      cat: 'mugs',
      img: ['products/mugs/driftthreads_mug_white.jpeg'],
      description:"Sleek, clean, and fully Drift Threads™ certified -- sip in style",
      badge:'Official'
    },
    {
      title: 'Liquid Gold™ Honey (1kg)',
      price: 220,
      cat: 'supplements',
      img: ['products/supplements/honey_1kg.jpeg'],
      description:"Pure, golden, unstoppable -- Liquid Gold™ by Drift Threads™",
      badge:'Limited'
    }
  ];

  /* Guarantee each product has an images array and a stable id */
  products.forEach((p, i) => {
    p.images = ensureImagesArray(p);
    if(!p.id) p.id = `prod-${i}`;
  });
  sponsors.forEach((s, i) => { if(!s.id) s.id = `spon-${i}`; });

  /* DOM references used across features */
  const grid = document.getElementById('grid');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const clearBtn = document.getElementById('clearBtn');
  const cartBtn = document.getElementById('cartBtn');
  const cartCount = document.getElementById('cartCount');
  const cartModal = document.getElementById('cartModal');
  const cartItems = document.getElementById('cartItems');
  const cartTotal = document.getElementById('cartTotal');
  const closeCart = document.getElementById('closeCart');
  const clearCartBtn = document.getElementById('clearCartBtn');
  const waOrderBtn = document.getElementById('waOrderBtn');
  const imgLightbox = document.getElementById('imgLightbox');
  const lbFrame = document.getElementById('lbFrame');
  const closeLightboxBtn = document.getElementById('closeLightbox');
  const catBar = document.getElementById('catBar');
  const catScrollHint = document.getElementById('catScrollHint');
  const showAllCatsBtn = document.getElementById('showAllCatsBtn');
  const cartInfoBtn = document.getElementById('cartInfoBtn');
  const cartInfoTooltip = document.getElementById('cartInfoTooltip');
  const productInfoBar = document.getElementById('productInfoBar');
  const globalInfoBtn = document.getElementById('globalInfoBtn');
  const globalInfoTooltip = document.getElementById('globalInfoTooltip');
  const productCountEl = document.getElementById('productCount');
  const headerInfoBtn = document.getElementById('headerInfoBtn');
  const headerInfoTooltip = document.getElementById('headerInfoTooltip');
  const connectionToast = document.getElementById('connectionToast');

  /* State */
  let cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const batchSize = 6;
  let filteredProducts = products.slice();
  let currentIndex = 0;
  let loading = false;
  let lastAdded = null;
  let notifTimer = null;

  /* Infinite scroll observer */
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if(entry.isIntersecting && !loading){
        observer.unobserve(entry.target);
        renderNextBatch();
      }
    });
  }, { root: null, rootMargin: '300px', threshold: 0.1 });

  /* Sponsor placement cadence (after N normal cards) */
  let displayedNormalCount = 0;
  let sponsorIndex = 0;
  const SPONSOR_AFTER = 6;

  /* LocalStorage key for "Show all" categories (desktop) */
  const CATS_SHOW_ALL_KEY = 'catsShowAll';

  /* Gate for enabling infinite scroll only after two initial batches */
  let allowInfiniteScroll = false;

  /* Persist cart */
  function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); }

  /* Update cart UI and totals */
  function updateCartDisplay(){
    const totalQty = cart.reduce((a, c) => a + (c.qty || 0), 0);
    cartCount.textContent = totalQty;
    if(totalQty === 0){
      cartCount.style.display = 'none';
      cartCount.setAttribute('aria-hidden','true');
    } else {
      cartCount.style.display = '';
      cartCount.removeAttribute('aria-hidden');
    }
    cartItems.innerHTML = '';
    if(!cart.length){
      cartItems.innerHTML = '<p style="color:#aaa; font-weight: 600; padding: 10px 0 20px 10px; margin:0">Cart is empty</p>';
    } else {
      cart.forEach(item => {
        const row = document.createElement('div');
        row.className = 'cart-item';
        row.style.display = 'flex';
        row.style.gap = '12px';
        row.style.alignItems = 'center';
        row.style.background = '#222';
        row.style.padding = '8px';
        row.style.borderRadius = '8px';
        row.style.marginBottom = '8px';
        row.innerHTML = `
          <img src="${(item.images && item.images[0]) || item.img || 'assets/placeholder.png'}" alt="${item.title} thumbnail" style="width:60px;height:60px;object-fit:cover;border-radius:6px">
          <div style="flex:1"><div style="font-weight:600">${item.title}</div><div style="color:#aaa">${money(item.price)} <span style="opacity:0.9">×${item.qty}</span></div></div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <button class="remove-btn" aria-label="Remove ${item.title}" style="background:#ff2a2a;color:#fff;border:0;padding:6px 8px;border-radius:8px;"><i class="fas fa-trash" aria-hidden="true"></i></button>
          </div>
        `;
        const removeBtn = row.querySelector('.remove-btn');
        removeBtn && removeBtn.addEventListener('click', () => {
          cart = cart.filter(p => p.id !== item.id);
          saveCart(); updateCartDisplay();
        });
        cartItems.appendChild(row);
      });
    }
    cartTotal.textContent = money(cart.reduce((a,c) => a + (c.price * (c.qty || 0)), 0));
  }

  /* --- Add-to-cart toast --- */
  const addNotif = document.getElementById('addNotif');
  const addNotifMsg = document.getElementById('addNotifMsg');
  const addNotifThumb = document.getElementById('addNotifThumb');
  const undoAddBtn = document.getElementById('undoAddBtn');
  const closeAddNotifBtn = document.getElementById('closeAddNotif');

  function showAddNotification(p){
    addNotifThumb.src = (p.images && p.images[0]) || p.img || 'assets/placeholder.png';
    addNotifThumb.alt = p.title || "Product added";
    const ex = cart.find(i => i.id === p.id);
    const qty = ex ? ex.qty : 1;
    addNotifMsg.textContent = qty > 1 ? `${p.title} x${qty} added to cart` : `${p.title} added to cart`;
    addNotif.classList.remove('hiding');
    addNotif.classList.add('visible');
    cartCount.classList.remove('pop'); void cartCount.offsetWidth; cartCount.classList.add('pop');
    lastAdded = { id: p.id, when: Date.now() };
    if(notifTimer) clearTimeout(notifTimer);
    notifTimer = setTimeout(()=> {
      addNotif.classList.remove('visible'); addNotif.classList.add('hiding');
      setTimeout(()=> { addNotif.classList.remove('hiding'); }, 320);
      lastAdded = null;
      notifTimer = null;
    }, 2000);
  }

  function addToCart(p){
    if(!p.id) p.id = `prod-${Math.random().toString(36).slice(2,9)}`;
    const ex = cart.find(i => i.id === p.id);
    if(ex) ex.qty = (ex.qty || 1) + 1;
    else cart.push({...p, qty:1});
    saveCart(); updateCartDisplay(); showAddNotification(p);
  }

  addNotif.addEventListener('click', (e) => {
    if(e.target.closest('#undoAddBtn') || e.target.closest('#closeAddNotif')) return;
    openCartModal();
  });
  undoAddBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if(!lastAdded) return;
    const idx = cart.findIndex(i => i.id === lastAdded.id);
    if(idx > -1){
      if(cart[idx].qty > 1) cart[idx].qty--;
      else cart.splice(idx, 1);
      saveCart(); updateCartDisplay();
    }
    if(notifTimer){ clearTimeout(notifTimer); notifTimer = null; }
    lastAdded = null;
    addNotif.classList.remove('visible'); addNotif.classList.add('hiding');
    setTimeout(()=> addNotif.classList.remove('hiding'), 320);
  });
  closeAddNotifBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if(notifTimer){ clearTimeout(notifTimer); notifTimer = null; }
    lastAdded = null;
    addNotif.classList.remove('visible'); addNotif.classList.add('hiding');
    setTimeout(()=> addNotif.classList.remove('hiding'), 320);
  });

  /* --- Share helpers --- */
  function productShareUrl(p){ const base = `${window.location.origin}${window.location.pathname}`; const params = new URLSearchParams(window.location.search); params.set('q', p.title); return `${base}?${params.toString()}`; }
  function showShareNotification(msg='Link copied!'){ try { document.getElementById('shareNotifMsg').textContent = msg; document.getElementById('shareNotif').classList.add('visible'); setTimeout(()=> document.getElementById('shareNotif').classList.remove('visible'), 2000); } catch(e){} }
  async function shareProduct(p){
    const url = productShareUrl(p);
    const shareData = { title: p.title, text: `${p.title} -- ${money(p.price)}\n\n${(p.description||'').replace(/<[^>]*>?/gm,'')}`, url };
    if(navigator.share){
      try{ await navigator.share(shareData); showShareNotification('Shared!'); return; } catch(err){}
    }
    if(navigator.clipboard && navigator.clipboard.writeText){
      try{ await navigator.clipboard.writeText(url); showShareNotification('Link copied to clipboard!'); return; } catch(err){}
    }
    try { window.prompt('Copy this link:', url); showShareNotification('Link ready -- copied?'); } catch(err){ showShareNotification('Could not copy link'); }
  }

  /* Construct a product card (with carousel + back face actions) */
  function createCard(p, {eager=false} = {}){
    const card = document.createElement('article');
    card.className = 'card';
    card.tabIndex = 0;

    const inner = document.createElement('div');
    inner.className = 'card-inner';

    // FRONT
    const front = document.createElement('div');
    front.className = 'card-front';

    // Image carousel
    const imgWrap = document.createElement('div');
    imgWrap.className = 'img-wrap';
    const images = p.images || ensureImagesArray(p);
    const carouselContainer = document.createElement('div');
    carouselContainer.style.width = '100%';
    carouselContainer.style.height = '100%';

    const carouselAPI = createCarousel(carouselContainer, images, {
      onImageClick: (index, url) => { openLightbox(p.images, index, p.title); },
      startIndex: 0,
      loop: true,
      showDots: false,
      showButtons: true,
      showCounter: true,
      className: 'carousel',
      enableZoom: false,
      eagerFirst: eager,
      getAlt: (i, total) => `${p.title} -- image ${i+1} of ${total}`
    });

    imgWrap.appendChild(carouselContainer);

    // Front body
    const frontBody = document.createElement('div');
    frontBody.className = 'front-body';
    frontBody.innerHTML = `<div class="product-title-front" style="margin-bottom:5px">${p.title}</div>
      <div class="price-row"><div class="price">${money(p.price)}</div>
      <div style="display:flex;gap:8px;align-items:center"><button class="add-btn" type="button" aria-label="Add ${p.title}"><i class="fas fa-plus" aria-hidden="true"></i></button></div></div>`;

    front.appendChild(imgWrap);
    front.appendChild(frontBody);

    // BACK
    const back = document.createElement('div');
    back.className = 'card-back';
    back.innerHTML = `<h3 style="margin:0;font-weight:600">${p.title}</h3>
      <p style="margin:0;color:#bcd9f2;">${p.description}</p>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="view-img-btn" type="button" aria-label="View ${p.title} images"><i class="fas fa-image" aria-hidden="true" style="padding-right:3px;"></i><span class="btn-label">View</span></button>
        <button class="share-btn" type="button" aria-label="Share ${p.title}"><i class="fas fa-share-alt" aria-hidden="true" style="padding-right:3px;"></i><span class="btn-label">Share</span></button>
        <button class="add-btn" type="button" aria-label="Add ${p.title}"><i class="fas fa-plus" aria-hidden="true" style="padding-right:3px;"></i><span class="btn-label">Add</span></button>
      </div>`;

    const innerWrap = inner;
    innerWrap.appendChild(front);
    innerWrap.appendChild(back);
    card.appendChild(inner);

    // Badge injection on front image if present (fixed duplicate variable declaration)
    try {
      const imgWrapForBadge = front.querySelector('.img-wrap');
      if(imgWrapForBadge && p.badge && String(p.badge).trim()){
        const badgeText = String(p.badge).trim();
        const lower = badgeText.toLowerCase();
        let styleClass = 'neutral';
        if(/\d+\s*%/.test(badgeText) || /off/i.test(badgeText) || /\d+\s*percent/.test(lower)) styleClass = 'sale';
        else if(/limited|exclusive|new|drop|hot/i.test(lower)) styleClass = 'limited';
        const badgeEl = document.createElement('div');
        badgeEl.className = `card-badge ${styleClass}`;
        badgeEl.setAttribute('role','status');
        badgeEl.setAttribute('aria-label', badgeText);
        badgeEl.innerHTML = `<span class="badge-dot" aria-hidden="true"></span><span class="badge-text">${badgeText}</span>`;
        badgeEl.style.pointerEvents = 'none';
        imgWrapForBadge.appendChild(badgeEl);
      }
    } catch(err){ console.error('Badge injection', err); }

    // Prevent flipping when interacting with controls/buttons
    function isControlTarget(el){
      return el.closest('.carousel-btn') || el.closest('.carousel-dots') || el.closest('.view-img-btn') || el.closest('.add-btn') || el.closest('.share-btn') || el.closest('.carousel');
    }

    // Flip card on click (outside controls)
    card.addEventListener('click', (e) => {
      if(isControlTarget(e.target)) return;
      const other = document.querySelector('.card.flipped');
      if(other && other !== card) other.classList.remove('flipped');
      card.classList.toggle('flipped');
    });

    // Add to cart (front/back)
    const frontAdd = front.querySelector('.add-btn');
    if(frontAdd) frontAdd.addEventListener('click', (e) => { e.stopPropagation(); addToCart(p); });
    back.querySelectorAll('.add-btn').forEach(b => {
      b.addEventListener('click', e => { e.stopPropagation(); addToCart(p); });
    });

    // Share (back)
    back.querySelectorAll('.share-btn').forEach(b => {
      b.addEventListener('click', e => { e.stopPropagation(); shareProduct(p); });
    });

    // View images (back) -> lightbox starting from current carousel index
    const viewBtn = back.querySelector('.view-img-btn');
    if(viewBtn){
      viewBtn.addEventListener('click', e => {
        e.stopPropagation();
        let idx = 0;
        try { idx = carouselAPI.getIndex(); } catch(err){}
        openLightbox(p.images, idx, p.title);
      });
    }

    // Keyboard flip (Enter/Space)
    card.addEventListener('keydown', e => {
      const isSpace = e.key === ' ' || e.key === 'Spacebar' || e.code === 'Space';
      if(e.key === 'Enter' || isSpace){
        e.preventDefault();
        const other = document.querySelector('.card.flipped');
        if(other && other !== card) other.classList.remove('flipped');
        card.classList.toggle('flipped');
      }
    });

    return card;
  }

  /* Sponsor card creation */
  function createSponsorCard(s){
    const card = document.createElement('article');
    card.className = 'card sponsor';
    const inner = document.createElement('div');
    inner.className = 'card-inner';
    const front = document.createElement('div');
    front.className = 'sponsor-card-front';
    front.innerHTML = `<div class="img-wrap sponsor-card"><img loading="lazy" decoding="async" src="${s.img}" alt="${s.title} logo"><div class="sponsor-label">Sponsored</div></div>
      <div class="front-body" role="link" aria-label="${s.title} -- Sponsored" tabindex="-1"><div class="sponsor-title">${s.title}</div><div class="sponsor-desc">${s.description || ''}</div></div>`;
    inner.appendChild(front); card.appendChild(inner);
    const imgEl = front.querySelector('img'); attachImageFallback(imgEl);
    card.addEventListener('click', () => { const url = s.url || '#'; if(url && url !== '#') window.open(url, '_blank', 'noopener'); });
    card.tabIndex = 0;
    card.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); const url = s.url || '#'; if(url && url !== '#') window.open(url, '_blank', 'noopener'); } });
    return card;
  }

  /* Spinner helpers */
  function showSpinner(){ document.getElementById('loadingSpinner').style.display = 'block'; }
  function hideSpinner(){ document.getElementById('loadingSpinner').style.display = 'none'; }

  /* Intersection observer helper: observe last card for infinite loading */
  function observeLastCard(){
    const cards = grid.querySelectorAll('.card');
    const last = cards[cards.length - 1];
    if(last) observer.observe(last);
  }

  /* Rendering + infinite scroll logic */
  function renderNextBatch(){
    return new Promise((resolve) => {
      if(loading){ resolve(); return; }
      if(currentIndex >= filteredProducts.length){ observer.disconnect(); resolve(); return; }
      loading = true; showSpinner();
      setTimeout(() => {
        const slice = filteredProducts.slice(currentIndex, currentIndex + batchSize);
        slice.forEach((p, i) => {
          const eager = (currentIndex === 0); // eager-load first batch for snappier first paint
          const c = createCard(p, {eager});
          c.classList.add('pop-in');
          c.style.animationDelay = `${i * 60}ms`;
          c.style.opacity = '1';
          grid.appendChild(c);
          displayedNormalCount++;
          if(displayedNormalCount % SPONSOR_AFTER === 0 && sponsors && sponsors.length){
            const s = sponsors[sponsorIndex % sponsors.length]; sponsorIndex++;
            const sc = createSponsorCard(s);
            sc.classList.add('pop-in'); sc.style.animationDelay = `${i * 60 + 80}ms`;
            grid.appendChild(sc);
          }
        });
        currentIndex += slice.length;
        loading = false; hideSpinner();

        // Only start observing for infinite scroll after initial two batches are done
        if(allowInfiniteScroll){
          if(currentIndex >= filteredProducts.length) observer.disconnect();
          else observeLastCard();
        } else {
          observer.disconnect();
        }

        setTimeout(()=> resolve(), 120);
      }, 60);
    });
  }

  /* Update mobile product count (shows how many results after search/filter) */
  function updateProductCount(){
    if(!productCountEl) return;
    const n = filteredProducts.length;
    productCountEl.textContent = `${n} item${n === 1 ? '' : 's'}`;
  }

  /* Filtering (by q and category) */
  function filterAndRender(){
    const q = (searchInput.value || '').trim().toLowerCase();
    const cat = document.querySelector('.cat-btn.active').dataset.cat;
    filteredProducts = products.filter(p => {
      const matchCat = (cat === 'all') || p.cat === cat;
      const matchQ = !q || p.title.toLowerCase().includes(q);
      return matchCat && matchQ;
    });

    // Reset grid/infinite state and URL
    currentIndex = 0;
    grid.innerHTML = '';
    displayedNormalCount = 0;
    sponsorIndex = 0;

    updateURL({ q: searchInput.value.trim(), cat }, { replace: true });
    updateProductCount();

    if(!filteredProducts.length){
      grid.innerHTML = '<div class="empty-state">No products found</div>';
      hideSpinner();
      observer.disconnect();
      return Promise.resolve();
    }
    return renderNextBatch();
  }

  /* URL state helpers */
  function updateURL(state = {}, opts = { replace:false }){
    const params = new URLSearchParams(window.location.search);
    if(state.q !== undefined && state.q !== null && String(state.q).trim() !== '') params.set('q', String(state.q).trim()); else params.delete('q');
    if(state.cat !== undefined && state.cat !== null && String(state.cat).trim() !== '' && String(state.cat).trim() !== 'all') params.set('cat', String(state.cat).trim()); else params.delete('cat');
    const newPath = window.location.pathname + (params.toString()?`?${params.toString()}` : '');
    if(opts.replace) history.replaceState({ q: state.q||'', cat: state.cat||'' }, '', newPath);
    else history.pushState({ q: state.q||'', cat: state.cat||'' }, '', newPath);
  }
  function readStateFromURL(){
    const params = new URLSearchParams(window.location.search);
    return { q: params.get('q') || '', cat: params.get('cat') || '' };
  }
  function applyStateToUI(state){
    if(typeof state.q === 'string'){ searchInput.value = state.q; clearBtn.style.display = state.q ? 'flex' : 'none'; }
    const cat = (state.cat && state.cat.trim()) ? state.cat.trim() : 'all';
    document.querySelectorAll('.cat-btn').forEach(b => { b.classList.remove('active'); b.removeAttribute('aria-current'); });
    const match = document.querySelector(`.cat-btn[data-cat="${cat}"]`);
    if(match){ match.classList.add('active'); match.setAttribute('aria-current','true'); setTimeout(()=> match.scrollIntoView({ inline:'center', behavior:'smooth' }), 80); }
    else { const first = document.querySelector('.cat-btn[data-cat="all"]') || document.querySelector('.cat-btn'); if(first){ first.classList.add('active'); first.setAttribute('aria-current','true'); } }
  }
  function applyStateFromURL(){ const st = readStateFromURL(); applyStateToUI(st); }

  /* Modal interaction helpers (for lightbox & cart) */
  (function(){
    function isInsideAny(target, list){ return list.some(el => el && (el === target || el.contains(target))); }
    function modalKeyHandler(e){
      if(e.key !== 'Tab') return;
      const activeModal = document.querySelector('.cart-modal.active, .lightbox.active');
      if(!activeModal) return;
      const focusables = Array.from(activeModal.querySelectorAll('a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])')).filter(el => !el.disabled && el.offsetParent !== null);
      if(!focusables.length){ e.preventDefault(); return; }
      const first = focusables[0], last = focusables[focusables.length-1];
      if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
    window.disableBackgroundInteraction = function(allowedElements = []){
      // lock scroll position
      const scrollY = window.scrollY || document.documentElement.scrollTop || 0;
      document.body.dataset.scrollY = String(scrollY);
      document.body.classList.add('modal-open');
      document.body.style.top = `-${scrollY}px`;

      document.querySelectorAll('header, main, #productInfoBar').forEach(el => {
        el.setAttribute('aria-hidden','true');
        try{ el.inert = true; }catch(e){}
        el.style.pointerEvents = 'none';
      });
      const prevent = function(e){ const tgt = e.target; if(isInsideAny(tgt, allowedElements)) return; e.preventDefault(); };
      document._modalPrevent = prevent;
      document.addEventListener('touchmove', prevent, { passive:false });
      document.addEventListener('wheel', prevent, { passive:false });
      document.addEventListener('keydown', modalKeyHandler, true);
    };
    window.enableBackgroundInteraction = function(){
      const savedY = parseInt(document.body.dataset.scrollY || '0', 10);
      document.body.classList.remove('modal-open');
      document.body.style.top = '';
      window.scrollTo(0, savedY);

      document.querySelectorAll('header, main, #productInfoBar').forEach(el => {
        el.removeAttribute('aria-hidden');
        try{ el.inert = false; }catch(e){}
        el.style.pointerEvents = '';
      });
      if(document._modalPrevent){
        document.removeEventListener('touchmove', document._modalPrevent, { passive:false });
        document.removeEventListener('wheel', document._modalPrevent, { passive:false });
        document._modalPrevent = null;
      }
      document.removeEventListener('keydown', modalKeyHandler, true);
    };
    window._isInsideAny = isInsideAny;
  })();

  /* Cart modal handlers */
  function openCartModal(){ cartModal.classList.add('active'); cartModal.setAttribute('aria-hidden','false'); disableBackgroundInteraction([cartModal.querySelector('.cart-content')]); setTimeout(()=>{ try{ waOrderBtn.focus(); }catch(e){} }, 50); }
  cartBtn.addEventListener('click', ()=> openCartModal());
  closeCart.addEventListener('click', ()=>{ cartModal.classList.remove('active'); cartModal.setAttribute('aria-hidden','true'); enableBackgroundInteraction(); cartBtn.focus(); });
  cartModal.addEventListener('click', e => { if(e.target === cartModal) closeCart.click(); });
  clearCartBtn.addEventListener('click', ()=> { if(cart.length && confirm('Clear cart?')){ cart = []; saveCart(); updateCartDisplay(); } });

  /* WhatsApp integration + Google Sheets webhook */
  const WA_NUMBER = '27713468567';

  /* Fill this with your Apps Script Web App URL, e.g. 'https://script.google.com/macros/s/XXXXX/exec' */
  const ORDER_WEBHOOK_URL = ''; // TODO: paste your Web App URL here

  function genOrderId(){
    const t = new Date();
    const pad = n => String(n).padStart(2,'0');
    const date = `${t.getFullYear()}${pad(t.getMonth()+1)}${pad(t.getDate())}`;
    const time = `${pad(t.getHours())}${pad(t.getMinutes())}${pad(t.getSeconds())}`;
    const rand = Math.random().toString(36).slice(2,6).toUpperCase();
    return `DT-${date}-${time}-${rand}`;
  }

  function buildWhatsAppMessage(orderId){
    if(!cart || !cart.length) return encodeURIComponent("🛒 Hey -- ordering from the site:\n\nNo items in cart. (bruh)");
    let lines = [];
    lines.push("🛒 Hey -- ordering from the site:");
    if(orderId){ lines.push(`Order ID: ${orderId}`); }
    lines.push("");
    cart.forEach(item => {
      const line = `- ${item.title} (${money(item.price)}) x${item.qty}`;
      lines.push(line);
    });
    lines.push("");
    const subtotal = money(cart.reduce((a,c) => a + c.price*c.qty, 0));
    lines.push(`*Subtotal: ${subtotal}*`);
    lines.push("");
    lines.push(`Link: ${window.location.href}`);
    return encodeURIComponent(lines.join("\n"));
  }

  function getWhatsAppLink(orderId){
    const base = `https://wa.me/${WA_NUMBER}`;
    const msg = buildWhatsAppMessage(orderId);
    return `${base}?text=${msg}`;
  }

  async function sendOrderToSheet(channel='whatsapp', orderId=null){
    try {
      if(!ORDER_WEBHOOK_URL) return;
      const payload = {
        orderId: orderId || genOrderId(),
        channel,
        items: cart.map(({ id, title, price, qty }) => ({ id, title, price, qty })),
        subtotal: cart.reduce((a,c) => a + c.price * (c.qty||0), 0),
        currency: 'ZAR',
        pageUrl: window.location.href,
        referrer: document.referrer || '',
        userAgent: navigator.userAgent || ''
      };
      const body = JSON.stringify(payload);
      if(navigator.sendBeacon){
        const blob = new Blob([body], { type: 'text/plain' });
        navigator.sendBeacon(ORDER_WEBHOOK_URL, blob);
      } else {
        fetch(ORDER_WEBHOOK_URL, {
          method:'POST',
          mode:'no-cors',
          headers:{ 'Content-Type':'text/plain' },
          body
        }).catch(()=>{});
      }
    } catch(e){}
  }

  waOrderBtn.addEventListener('click', () => {
    const orderId = genOrderId();
    sendOrderToSheet('whatsapp', orderId);
    const link = getWhatsAppLink(orderId);
    window.open(link, '_blank', 'noopener');
  });

  /* LIGHTBOX with looping carousel + pinch/wheel zoom + open/close animations */
  function openLightbox(imgs, startIndex = 0, titleText = 'Image'){
    if(!Array.isArray(imgs) || !imgs.length) imgs = ['assets/placeholder.png'];
    lbFrame.innerHTML = ''; // clear previous
    const carouselHolder = document.createElement('div');
    carouselHolder.style.width = '100%';
    carouselHolder.style.height = '100%';

    const api = createCarousel(carouselHolder, imgs, {
      onImageClick: () => {},
      startIndex: startIndex,
      loop: true,
      showDots: true,
      showButtons: true,
      showCounter: true,
      className: 'carousel',
      enableZoom: true,
      eagerFirst: true,
      getAlt: (i, total) => `${titleText} -- large view ${i+1} of ${total}`
    });
    lightboxState.api = api;

    lbFrame.appendChild(carouselHolder);

    // Show lightbox with animation
    imgLightbox.classList.add('active');
    imgLightbox.setAttribute('aria-hidden','false');

    // Ensure proper sizing and index after lightbox is visible (fix rare offset)
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        try {
          api.setIndex(startIndex);
          if(api.refresh) api.refresh();
        } catch(e){}
        imgLightbox.classList.add('opened');
        setTimeout(()=> { try{ api.refresh && api.refresh(); }catch(e){} }, 60);
      });
    });

    disableBackgroundInteraction([imgLightbox, lbFrame]);
    lightboxState.active = true;

    // focus close button for a11y
    setTimeout(()=>{ try{ closeLightboxBtn.focus(); }catch(e){} }, 50);

    // Mobile-specific control auto-hide after 1s idle
    const isMobile = window.matchMedia('(max-width: 720px)').matches;
    if(isMobile){
      const resetIdle = () => {
        imgLightbox.classList.remove('hide-controls');
        if(lightboxState.idleTimer) clearTimeout(lightboxState.idleTimer);
        lightboxState.idleTimer = setTimeout(() => {
          imgLightbox.classList.add('hide-controls');
        }, 1000);
      };
      ['touchstart','pointermove','mousemove','keydown'].forEach(ev => imgLightbox.addEventListener(ev, resetIdle, {passive:true}));
      resetIdle(); // start timer
    }

    // Keep alignment correct on resize/orientation changes
    const onWinResize = debounce(()=> { try{ api.refresh && api.refresh(); }catch(e){} }, 80);
    window.addEventListener('resize', onWinResize);
    imgLightbox._onResize = onWinResize;
  }
  function lightboxClose(withAnim=true){
    if(lightboxState.idleTimer){ clearTimeout(lightboxState.idleTimer); lightboxState.idleTimer = null; }
    if(withAnim){
      imgLightbox.classList.add('closing');
      setTimeout(()=>{
        try{ if(lightboxState.api && typeof lightboxState.api.destroy === 'function') lightboxState.api.destroy(); }catch(e){}
        lightboxState.api = null;

        if(imgLightbox._onResize){ window.removeEventListener('resize', imgLightbox._onResize); imgLightbox._onResize = null; }

        imgLightbox.classList.remove('active','opened','closing','hide-controls');
        imgLightbox.setAttribute('aria-hidden','true');
        lbFrame.innerHTML = '';
        enableBackgroundInteraction();
        lightboxState.active = false;
      }, 260);
    } else {
      try{ if(lightboxState.api && typeof lightboxState.api.destroy === 'function') lightboxState.api.destroy(); }catch(e){}
      lightboxState.api = null;
      if(imgLightbox._onResize){ window.removeEventListener('resize', imgLightbox._onResize); imgLightbox._onResize = null; }

      imgLightbox.classList.remove('active','opened','closing','hide-controls');
      imgLightbox.setAttribute('aria-hidden','true');
      lbFrame.innerHTML = '';
      enableBackgroundInteraction();
      lightboxState.active = false;
    }
  }
  document.getElementById('closeLightbox').addEventListener('click', ()=> lightboxClose(true));

  // Close when clicking overlay or outside content (desktop)
  imgLightbox.addEventListener('click', function(e){
    const isMobile = window.matchMedia('(max-width: 720px)').matches;
    if(e.target === imgLightbox){ lightboxClose(true); return; }
    if(!isMobile){
      const insideImage = e.target.closest('.zoom-wrap');
      const insideControls = e.target.closest('.carousel-controls');
      const insideDots = e.target.closest('.carousel-dots');
      const isCloseBtn = e.target.closest('#closeLightbox');
      if(!insideImage && !insideControls && !insideDots && !isCloseBtn){
        lightboxClose(true);
      }
    }
  });

  /* ESC closes both modals if open */
  window.addEventListener('keydown', (e) => {
    if(e.key === 'Escape'){
      if(cartModal.classList.contains('active')){ closeCart.click(); }
      if(imgLightbox.classList.contains('active')){ lightboxClose(true); }
      // Also hide any open info tooltips
      hideHeaderInfoTooltip();
      hideGlobalInfoTooltip();
    }
  });

  /* Preloader: prepare assets but do not hide until first two batches are rendered */
  async function preloadCriticalAssets(){
    const pre = document.getElementById('preloader');
    const txt = document.getElementById('preloaderText');
    const bar = document.querySelector('#preloaderBar>span');

    let progress = 0;
    const setProgress = (p) => {
      progress = Math.max(progress, Math.min(100, Math.round(p)));
      if(txt) txt.textContent = `Loading ${progress}%`;
      if(bar) bar.style.width = `${progress}%`;
    };
    setProgress(5);

    // Fonts: cap wait time to 1200ms
    try {
      const fontsReady = document.fonts ? document.fonts.ready : Promise.resolve();
      await Promise.race([fontsReady, new Promise(r=>setTimeout(r, 1200))]);
    } catch(e){}
    setProgress(20);

    // Determine first visible product given current state
    const st = readStateFromURL();
    const cat = (st.cat && st.cat.trim()) ? st.cat.trim() : 'all';
    const q = (st.q || '').trim().toLowerCase();
    const list = products.filter(p => ((cat === 'all') || p.cat === cat) && (!q || p.title.toLowerCase().includes(q)));

    const first = list[0] || products[0];
    const critImgs = [
      'assets/favicon.png',
      'assets/logo.png',
      (first && first.images && first.images[0]) ? first.images[0] : null
    ].filter(Boolean);

    // Preload critical in sequence to update progress smoothly
    const step = Math.floor(70 / Math.max(1, critImgs.length)); // up to ~90%
    const safety = new Promise(r => setTimeout(r, 2500)); // 2.5s safety cap
    const doLoad = (async () => {
      for(const src of critImgs){
        try { await preloadImage(src); } catch(e){}
        setProgress(progress + step);
      }
      setProgress(90);
    })();

    await Promise.race([doLoad, safety]);

    // Expose an API to hide the preloader when ready (after initial render)
    const hide = () => new Promise((resolve) => {
      setProgress(100);
      setTimeout(()=> {
        if(pre){
          pre.style.opacity = '0';
          setTimeout(()=> { try{ pre.remove(); }catch(e){} resolve(); }, 450);
        } else {
          resolve();
        }
      }, 120);
    });

    return { setProgress, hide };
  }

  /* Initial hint tooltip -- show for 3s AFTER preloader unloads */
  function showHintTooltip(){
    try {
      const tip = document.getElementById('hintTooltip');
      if(!tip) return;
      const icon = tip.querySelector('.icon');
      tip.style.display = '';
      requestAnimationFrame(()=> {
        tip.classList.add('visible','glowy');
        tip.setAttribute('aria-hidden', 'false');
        if(icon) icon.classList.add('pulse');
      });
      setTimeout(()=> {
        tip.classList.remove('glowy');
        tip.style.transition = 'opacity 220ms var(--ease), transform 220ms var(--ease)';
        tip.style.opacity = '0';
        tip.setAttribute('aria-hidden', 'true');
        if(icon) icon.classList.remove('pulse');
        setTimeout(()=> { tip.classList.remove('visible'); tip.style.display = 'none'; tip.style.transition = ''; tip.style.opacity = ''; }, 260);
      }, 3000);
    } catch(e){}
  }

  /* Search + categories binding */
  const debouncedSearch = debounce(()=> {
    const cat = document.querySelector('.cat-btn.active').dataset.cat;
    updateURL({ q: searchInput.value.trim(), cat }, { replace:false });
    filterAndRender();
  }, 320);

  searchInput.addEventListener('input', ()=> { clearBtn.style.display = searchInput.value ? 'flex' : 'none'; debouncedSearch(); });
  searchBtn.addEventListener('click', ()=> { filterAndRender(); searchInput.focus(); });
  clearBtn.addEventListener('click', ()=> { searchInput.value = ''; filterAndRender(); clearBtn.style.display = 'none'; searchInput.focus(); });

  // Keyboard shortcut: '/' focuses search (if not typing in another input)
  document.addEventListener('keydown', (e) => {
    if(e.key === '/' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey){
      const tag = (document.activeElement && document.activeElement.tagName) || '';
      if(!/INPUT|TEXTAREA|SELECT/.test(tag)){
        e.preventDefault();
        searchInput.focus();
      }
    }
  });
  // Esc clears search fast
  searchInput.addEventListener('keydown', (e) => {
    if(e.key === 'Escape'){
      e.preventDefault();
      clearBtn.click();
    }
  });

  // Category buttons (click + keyboard) + aria-current
  document.querySelectorAll('.cat-btn').forEach(btn => {
    btn.addEventListener('click', ()=> {
      document.querySelectorAll('.cat-btn').forEach(b => { b.classList.remove('active'); b.removeAttribute('aria-current'); });
      btn.classList.add('active');
      btn.setAttribute('aria-current','true');
      const cat = btn.dataset.cat;
      updateURL({ q: searchInput.value.trim(), cat }, { replace:false });
      filterAndRender(); setTimeout(()=> updateCatBarUI(), 90);
    });
    btn.addEventListener('keydown', e => { if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); btn.click(); }});
  });

  /* Categories bar UI: scroll shadow on mobile; "Show all" toggle on desktop */
  function updateCatShadow(){
    if(!catBar) return;
    const maxScroll = catBar.scrollWidth - catBar.clientWidth;
    if(maxScroll > 2 && window.matchMedia('(max-width: 900px)').matches){
      // show shadow if not scrolled all the way to the end
      if(catBar.scrollLeft < maxScroll - 1){
        catScrollHint.classList.add('visible');
      } else {
        catScrollHint.classList.remove('visible');
      }
    } else {
      catScrollHint.classList.remove('visible');
    }
  }
  function updateCatBarUI(){
    if(!catBar) return;
    const canScroll = catBar.scrollWidth > catBar.clientWidth + 2;
    const isDesktop = window.matchMedia('(min-width: 901px)').matches;

    // Mobile scroll shadow hint
    updateCatShadow();

    /* // Desktop: Show All button only if overflowing */
    if(isDesktop && canScroll){
      showAllCatsBtn.style.display = 'inline-flex';
      // Apply persisted "show all" state
      const wantShowAll = localStorage.getItem(CATS_SHOW_ALL_KEY) === '1';
      catBar.classList.toggle('show-all', wantShowAll);
      showAllCatsBtn.textContent = wantShowAll ? 'Collapse' : 'Show all';
    } else {
      showAllCatsBtn.style.display = 'none';
      catBar.classList.remove('show-all');
      showAllCatsBtn.textContent = 'Show all';
    }
  }
  catBar && catBar.addEventListener('scroll', debounce(updateCatShadow, 60), { passive:true });
  window.addEventListener('resize', debounce(updateCatBarUI, 150));
  showAllCatsBtn.addEventListener('click', () => {
    const isDesktop = window.matchMedia('(min-width: 901px)').matches;
    if(!isDesktop) return; // guard: never toggle on mobile/tablet
    const on = catBar.classList.toggle('show-all');
    showAllCatsBtn.textContent = on ? 'Collapse' : 'Show all';
    localStorage.setItem(CATS_SHOW_ALL_KEY, on ? '1' : '0');
  });

  /* Scroll to top button */
  (function(){
    const btn = document.getElementById('scrollToTopBtn');
    if(!btn) return;
    function updateVisibility(){ if(window.scrollY > 240) btn.classList.add('visible'); else btn.classList.remove('visible'); }
    updateVisibility();
    window.addEventListener('scroll', updateVisibility, { passive:true });
    function scrollTopHandler(e){ e.preventDefault(); btn.classList.add('click-anim'); setTimeout(()=> btn.classList.remove('click-anim'), 300); window.scrollTo({ top:0, behavior:'smooth' }); btn.blur(); }
    btn.addEventListener('click', scrollTopHandler);
    btn.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); scrollTopHandler(e); }});
    btn.addEventListener('focus', ()=> btn.classList.add('focused'));
    btn.addEventListener('blur', ()=> btn.classList.remove('focused'));
  })();

  /* Keyboard "pressed" class for buttons when using Space/Enter */
  (function(){
    function isButtonLike(el){
      return el && (el.tagName === 'BUTTON' || el.getAttribute('role') === 'button');
    }
    document.addEventListener('keydown', (e) => {
      const target = e.target;
      if(!isButtonLike(target)) return;
      const key = e.key || e.code;
      if(key === 'Enter' || key === ' ' || key === 'Spacebar'){
        target.classList.add('pressed');
      }
    });
    document.addEventListener('keyup', (e) => {
      const target = e.target;
      if(!isButtonLike(target)) return;
      target.classList.remove('pressed');
    });
    document.addEventListener('blur', (e) => {
      const target = e.target;
      if(isButtonLike(target)) target.classList.remove('pressed');
    }, true);
  })();

  /* Legacy cart info tooltip handlers (kept hidden) */
  (function(){
    function hideTooltip(){
      if(!cartInfoTooltip) return;
      cartInfoTooltip.classList.remove('visible');
      cartInfoTooltip.setAttribute('aria-hidden','true');
      if(cartInfoBtn) cartInfoBtn.setAttribute('aria-expanded','false');
    }
    function toggleTooltip(){
      if(!cartInfoTooltip || !cartInfoBtn) return;
      const showing = cartInfoTooltip.classList.toggle('visible');
      cartInfoTooltip.setAttribute('aria-hidden', showing ? 'false' : 'true');
      cartInfoBtn.setAttribute('aria-expanded', showing ? 'true' : 'false');
    }
    if(cartInfoBtn){
      cartInfoBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleTooltip(); });
      cartInfoBtn.addEventListener('mouseenter', () => { if(!/Mobi|Android/i.test(navigator.userAgent)){ cartInfoTooltip.classList.add('visible'); cartInfoTooltip.setAttribute('aria-hidden','false'); cartInfoBtn.setAttribute('aria-expanded','true'); }});
      cartInfoBtn.addEventListener('mouseleave', () => { if(!/Mobi|Android/i.test(navigator.userAgent)){ hideTooltip(); }});
    }
    document.addEventListener('click', (e) => {
      if(!cartInfoBtn || !cartInfoTooltip) return;
      if(e.target === cartInfoBtn || cartInfoTooltip.contains(e.target)) return;
      hideTooltip();
    });
    closeCart && closeCart.addEventListener('click', hideTooltip);
  })();

  /* Global/mobile info tooltip handlers */
  function hideGlobalInfoTooltip(){
    if(!globalInfoTooltip) return;
    globalInfoTooltip.classList.remove('visible');
    globalInfoTooltip.setAttribute('aria-hidden','true');
    if(globalInfoBtn) globalInfoBtn.setAttribute('aria-expanded','false');
  }
  (function(){
    function toggleTooltip(){
      const showing = globalInfoTooltip.classList.toggle('visible');
      globalInfoTooltip.setAttribute('aria-hidden', showing ? 'false' : 'true');
      globalInfoBtn.setAttribute('aria-expanded', showing ? 'true' : 'false');
      if(showing){ hideHeaderInfoTooltip(); }
    }
    globalInfoBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleTooltip(); });
    document.addEventListener('click', (e) => {
      if(e.target === globalInfoBtn || globalInfoTooltip.contains(e.target)) return;
      hideGlobalInfoTooltip();
    });
  })();

  /* Header/desktop info tooltip handlers (NEW) */
  function hideHeaderInfoTooltip(){
    if(!headerInfoTooltip) return;
    headerInfoTooltip.classList.remove('visible');
    headerInfoTooltip.setAttribute('aria-hidden','true');
    if(headerInfoBtn) headerInfoBtn.setAttribute('aria-expanded','false');
  }
  (function(){
    if(!headerInfoBtn) return;
    function toggleHeaderTooltip(){
      const showing = headerInfoTooltip.classList.toggle('visible');
      headerInfoTooltip.setAttribute('aria-hidden', showing ? 'false' : 'true');
      headerInfoBtn.setAttribute('aria-expanded', showing ? 'true' : 'false');
      if(showing){ hideGlobalInfoTooltip(); }
    }
    headerInfoBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleHeaderTooltip(); });
    document.addEventListener('click', (e) => {
      if(e.target === headerInfoBtn || (headerInfoTooltip && headerInfoTooltip.contains(e.target))) return;
      hideHeaderInfoTooltip();
    });
    // On resize, if switching to mobile, ensure header tooltip is closed
    window.addEventListener('resize', debounce(() => {
      if(window.matchMedia('(max-width: 900px)').matches){
        hideHeaderInfoTooltip();
      }
    }, 120));
  })();

  /* Responsive search placeholder: mobile uses "Search..." */
  function updateSearchPlaceholder(){
    try{
      const isMobile = window.matchMedia('(max-width: 600px)').matches;
      if(searchInput) searchInput.placeholder = isMobile ? 'Search...' : 'Search products...';
    } catch(e){}
  }
  window.addEventListener('resize', debounce(updateSearchPlaceholder, 120));

  /* Connection toast helpers (online/offline) */
  function showConnectionToast(msg){
    if(!connectionToast) return;
    connectionToast.textContent = msg;
    connectionToast.classList.add('visible');
    setTimeout(()=> connectionToast.classList.remove('visible'), 1800);
  }
  window.addEventListener('offline', () => showConnectionToast('You are offline'));
  window.addEventListener('online', () => showConnectionToast('Back online'));

  /* Initialize: preload assets, render two batches with preloader shown, then enable infinite scroll */
  window.addEventListener('DOMContentLoaded', async () => {
    updateCartDisplay();
    applyStateFromURL();
    updateCatBarUI();
    updateSearchPlaceholder();

    const pre = await preloadCriticalAssets(); // warm up fonts + 1-2 critical images

    // First batch
    await filterAndRender();
    // Second batch (explicit)
    await renderNextBatch();

    // Hide preloader now that first two batches are visible
    await pre.hide();

    // Enable infinite scroll for batch 3+
    allowInfiniteScroll = true;
    observeLastCard();

    showHintTooltip();
  });

  /* Dev helper: send a dummy row to your sheet to verify webhook quickly */
  window.__testOrderPing = () => {
    const backup = cart.slice();
    cart = [{ id:'test-1', title:'Test Item', price:123, qty:2 }];
    const id = genOrderId();
    sendOrderToSheet('test', id);
    cart = backup;
    console.log('Sent test order to sheet with ID:', id);
  };
  </script>
</body>
</html>