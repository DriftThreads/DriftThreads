<!DOCTYPE html>
<html lang="en">
<head>
  <!--
    DriftThreads -- Home (Enhanced)
    - Sponsored label moved into card body (above title/desc), not over the image
    - Tags system added (product tags shown after description, muted style)
    - Tag filter bar added (multi-select, AND filtering) + URL sync
    - Categories generated from JSON
    - Small code cleanup to avoid IDE syntax-highlighting quirks (kept your intentional "20px *" quirk intact)
  -->
  <meta charset="utf-8" />
  <title>DriftThreads -- Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="assets/favicon.png" />

  <!-- SEO meta and social -->
  <meta name="description" content="Discover Drift Threads, the ultimate destination for premium streetwear inspired by car culture. Shop our exclusive collection now!">
  <meta name="robots" content="index,follow">
  <link rel="canonical" href="https://driftthreads.store/">

  <meta property="og:title" content="Drift Threads | Premium Streetwear for Car Enthusiasts">
  <meta property="og:description" content="Explore our exclusive collection of streetwear inspired by car culture. Shop now at Drift Threads.">
  <meta property="og:image" content="https://driftthreads.store/assets/logo.png">
  <meta property="og:url" content="https://driftthreads.store/">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Drift Threads">

  <meta name="twitter:title" content="Drift Threads | Premium Streetwear for Car Enthusiasts">
  <meta name="twitter:description" content="Shop the latest streetwear inspired by car culture at Drift Threads.">
  <meta name="twitter:image" content="https://driftthreads.store/assets/logo.png">
  <meta name="twitter:card" content="summary_large_image">

  <!-- UI meta -->
  <meta name="theme-color" content="#161616">
  <meta name="color-scheme" content="dark">

  <!-- Fonts and icons -->
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"> -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <!-- Structured data for SEO -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Drift Threads",
    "url": "https://driftthreads.store/",
    "logo": "https://driftthreads.store/assets/logo.png"
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Drift Threads",
    "url": "https://driftthreads.store/",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://driftthreads.store/?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>

  <style>
  /* ===========================================================
     Theme tokens and global resets
     =========================================================== */
  :root{
    --bg:radial-gradient(circle at center,#2a3a44,#161616 75%);
    --card-bg:radial-gradient(circle at center,#383838,#161616 85%);
    --text:#fff;
    --accent:#0af;            /* Primary accent */
    --accent-strong:#00c2ff;  /* Bright accent (kept for other UI) */
    --muted:#9aa0a6;
    --transition:240ms;
    --ease:cubic-bezier(0.22,0.9,0.27,1);
    --card-radius:12px;
    --badge-font:600 .78rem/1 "Fira Sans",sans-serif;
  }

  *{box-sizing:border-box}

  html{scroll-behavior:smooth}
  html,body{
    margin:0;padding:0;width:100%;height:100%;
    background:var(--bg);
    background-color:#161616; /* fallback + fixes rare hairline seams */
    color:var(--text);font-family:"Fira Sans",sans-serif;
    font-weight:400; /* lighter default weight everywhere */
  }

  @media (max-width: 768px) { 
    .add-btn, .share-btn, .view-img-btn { transform:scale(0.9) } 
  }

  a{color:inherit}
  ::selection{background:rgba(10,170,255,0.14)}
  ::-webkit-scrollbar{width:0;background:transparent}

  @media (prefers-reduced-motion: reduce){
    *{
      animation-duration:0.001ms !important;
      animation-iteration-count:1 !important;
      transition-duration:0.001ms !important;
      scroll-behavior:auto !important
    }
  }

  /* ===========================================================
     Global interactive affordances (buttons)
     =========================================================== */
  button,[role="button"]{
    transition:
      transform 160ms var(--ease),
      box-shadow 180ms var(--ease),
      background-color 160ms ease,
      opacity 160ms ease,
      filter 160ms ease,
      outline-color 120ms ease;
    outline:0;
    -webkit-tap-highlight-color: transparent;
    font-weight:600;
    cursor:pointer;
  }
  button:hover,[role="button"]{transform:translateY(-1px)}
  button:active,[role="button"].pressed{transform:translateY(1px) scale(0.98);filter:brightness(0.96)}
  button:focus-visible,[role="button"]:focus-visible{
    outline:3px solid rgba(0,102,255,0.35);
    outline-offset:3px;
    border-radius:8px;
  }

  /* ===========================================================
     Body scroll lock when a modal is open (cart or lightbox)
     =========================================================== */
  body.modal-open{overflow:hidden; overscroll-behavior:contain}
  @supports (position: fixed){
    body.modal-open{position:fixed; width:100%}
  }

  /* ===========================================================
     Accessibility helpers: skip link
     =========================================================== */
  .skip-link{
    position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;
  }
  .skip-link:focus{
    left:10px; top:10px; width:auto; height:auto; padding:8px 12px;
    background:#fff; color:#111; border-radius:8px; z-index:10000;
  }

  /* ===========================================================
     Scroll to top floating action button
     =========================================================== */
  #scrollToTopBtn i{text-decoration:none;line-height:1;font-size:20px;display:inline-block}
  #scrollToTopBtn{
    position:fixed;width:50px;height:50px;background:#fff;color:#111;bottom:30px;right:30px;border-radius:50%;
    text-decoration:none;display:flex;align-items:center;justify-content:center;line-height:45px;font-size:25px;z-index:9;border:0;
    -webkit-tap-highlight-color:transparent;
    transition:transform 220ms cubic-bezier(0.22,0.9,0.27,1),background 180ms ease,box-shadow 180ms ease,opacity 180ms ease;
    will-change:transform,opacity,box-shadow;transform:translateY(8px) scale(0.98);opacity:0;pointer-events:none;box-shadow:0 12px 30px rgba(0,0,0,0.12)
  }
  #scrollToTopBtn.visible{pointer-events:auto;opacity:.98;transform:translateY(0) scale(1)}
  #scrollToTopBtn.visible:hover,#scrollToTopBtn.visible:focus,#scrollToTopBtn.visible.focused{background:var(--accent);transform:translateY(0) scale(1.1);box-shadow:0 5px 5px rgba(10,170,255,0.16);outline:0}
  #scrollToTopBtn.visible:active,#scrollToTopBtn.visible.pressed{border-radius:50%;transform:translateY(0) scale(0.96);transition:transform 120ms cubic-bezier(0.2,0.8,0.2,1)}
  @keyframes clickPop{0%{transform:scale(1) translateY(0)}40%{transform:scale(0.86) translateY(2px)}100%{transform:scale(1.08) translateY(-2px)}}
  #scrollToTopBtn:active{transform:scale(0.96)!important}
  #scrollToTopBtn:focus,#scrollToTopBtn.focused{outline:3px solid rgba(0,102,255,0.18);outline-offset:4px;border-radius:8px}
  @media(max-width:600px){
    #scrollToTopBtn{height:38px;width:38px;font-size:20px;right:calc(50vw - 19px);bottom:20px}
  }

  /* ===========================================================
     Header (sticky)
     =========================================================== */
  header{
    position:sticky;top:10px;z-index:50;
    background:rgba(0,0,0,0.9);
    padding:12px 16px;box-shadow:0 1px 0 rgba(255,255,255,0.02);margin:10px;border-radius:var(--card-radius);outline:1px solid rgba(255,255,255,0.02);outline-offset:-1px;
    backface-visibility:hidden;
    transform:translateZ(0);will-change:transform;contain:paint;
  }
  .top-row{display:flex;gap:12px;align-items:center;}
  .logo img{height:40px;display:block;background:#fff;padding:6px;border-radius:8px}

  /* Header search */
  .search-wrap{flex:1;display:flex;gap:6px;justify-content:center;}
  .search-box{position:relative;flex:1;min-width:0;max-width:750px;}
  .search-box input{width:100%;padding:10px 36px 10px 12px;border-radius:25px 5px 5px 25px;background:#2b2b2b;border:0;color:#fff;font-size:14px;outline:0;box-shadow:0 4px 18px rgba(0,0,0,0.45),inset 0 1px 0 rgba(255,255,255,0.02)}
  #clearBtn{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:#888;cursor:pointer;display:none;padding:6px;border-radius:6px}
  #searchBtn{background:#06f;border:0;color:#fff;border-radius:8px;padding:8px 12px;box-shadow:0 8px 18px rgba(0,102,255,0.12)}

  /* Header cart */
  #cartBtn{width:44px;height:44px;border-radius:50%;background:#222;display:inline-flex;align-items:center;justify-content:center;position:relative}
  #cartCount{position:absolute;right:6px;bottom:6px;background:#06f;color:#fff;border-radius:50%;min-width:16px;height:16px;line-height:16px;text-align:center;font-size:11px;padding:0 4px;display:inline-block}
  #cartCount.pop{animation:popBadge 420ms var(--ease)}
  @keyframes popBadge{0%{transform:scale(1)}30%{transform:scale(1.35)}100%{transform:scale(1)}}

  /* Header Info button wrapper (desktop only) */
  .header-info-wrap{position:relative;display:none}
  @media (min-width:901px){
    .header-info-wrap{display:inline-flex}
  }

  /* ===========================================================
     Categories bar
     =========================================================== */
  .cat-bar{
    display:flex;padding-top:10px;overflow-x:auto;white-space:nowrap;margin-left:30px;position:relative;padding-bottom:10px;gap:6px;
  }
  .cat-bar::after{content:none !important}
  .cat-bar.show-all{
    flex-wrap:wrap;white-space:normal;overflow:visible;padding-bottom:8px;gap:8px;
  }
  .cat-btn{
    background:#fff;color:#222;padding:6px 12px;border-radius:10px;border:0;flex-shrink:0;margin-right:0;
    transition:filter 160ms ease, background 160ms ease, transform 160ms var(--ease); font-weight:600
  }
  .cat-btn:hover{filter:brightness(0.92);transform:translateY(-1px)}
  .cat-btn:active,.cat-btn.pressed{transform:translateY(1px) scale(0.98)}
  .cat-btn.active{background:#06f;color:#fff}
  .cat-btn.active:hover{filter:brightness(0.92)}

  .cat-scroll-hint{
    position:fixed;right:0;top:0;bottom:0;width:42px;
    background:linear-gradient(to left, rgba(22,22,22,0.95), rgba(22,22,22,0));
    border:0; pointer-events:none; display:none; box-shadow:none; color:transparent;
  }
  .cat-scroll-hint.visible{display:block}
  .cat-scroll-hint i{display:none}

  /* Desktop-only "Show all" button */
  #showAllCatsBtn{
    display:none;margin:6px 30px 0 auto;background:transparent;color:#9bd4ff;border:0;padding:6px 0;font-weight:600;cursor:pointer;
    text-decoration:underline; border-radius:0; box-shadow:none;
  }
  #showAllCatsBtn:hover{transform:none; filter:brightness(1.1)}
  #showAllCatsBtn:active,#showAllCatsBtn.pressed{transform:none}
  @media (max-width: 900px){
    #showAllCatsBtn{display:none !important}
  }

  /* ===========================================================
     Tag filter bar (new)
     =========================================================== */
  .tag-bar{
    display:flex;gap:6px;align-items:center;overflow-x:auto;white-space:nowrap;
    margin:2px 30px 8px 30px;padding-bottom:4px;
    position: relative;
  }
  .tag-chip{
    background:transparent;
    border:1px solid rgba(255,255,255,0.12);
    color:var(--muted);
    border-radius:999px;
    padding:6px 10px;
    font-size:.82rem;
    flex:0 0 auto;
  }
  .tag-chip:hover{filter:brightness(1.1);transform:translateY(-1px)}
  .tag-chip:active,.tag-chip.pressed{transform:translateY(1px) scale(0.98)}
  .tag-chip.active{background:#06f;border-color:transparent;color:#fff}
  #clearTagsBtn{
    position: sticky; left: 0; z-index: 2;
    background: rgba(16,16,16,0.75);
    border:1px solid rgba(155,212,255,0.25);
    color:#9bd4ff;
    padding:6px 10px;
    border-radius:999px;
    font-weight:700;
    text-decoration:none;
    flex:0 0 auto;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  }
  #clearTagsBtn:hover{filter:brightness(1.1)}
  #clearTagsBtn[disabled]{opacity:.5; cursor:not-allowed}
  #clearTagsBtn .count{opacity:.85}

  /* ===========================================================
     Products grid
     =========================================================== */
  main{padding:20px 12px;flex:1}
  footer{margin:20px;color:var(--muted);display:flex;justify-content:space-between;flex-wrap:wrap;gap:12px;font-size:14px; padding-bottom: 40px;}
  hr {
    background: var(--muted);
    width: 90vw;
    border-radius: 3px;
  }
  .footer-img { height: 32px; }
  @media (min-width: 700px){
    footer{margin:20px 40px 40px 40px; padding-bottom: 30px;}
    hr { width: 95vw; }
  }

  #grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, 220px);
    gap: 20px;
    justify-content: center;
    /* 220px cards × 5 columns + 20px gaps × 4 between columns */
    max-width: calc(220px * 5 + 20px * );
    margin: 0 auto;
    padding: 0 18px;
  }
  @media (max-width: 900px) { #grid { grid-template-columns: repeat(auto-fill, 200px); } }
  @media (max-width: 600px) { #grid { grid-template-columns: repeat(2, 1fr); max-width: 100%; } }

  /* ===========================================================
     Product cards (front/back flip)
     =========================================================== */
  .card{perspective:1200px;max-width:220px;cursor:pointer;border-radius:var(--card-radius);transition:all .5s ease;will-change:transform;opacity:0}
  .card.pop-in{animation:fadeInUp .36s var(--ease) forwards}
  @keyframes fadeInUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
  .card:hover{transform:translateY(-8px);box-shadow:0 4px 10px rgba(0,0,0,0.6)}
  .card-inner{position:relative;width:100%;height:320px;border-radius:var(--card-radius);transform-style:preserve-3d;transition:transform .5s var(--ease)}
  .card-front,.card-back{
    position:absolute;inset:0;border-radius:var(--card-radius);display:flex;flex-direction:column;overflow:hidden;backface-visibility:hidden;
    background:radial-gradient(circle at top left,#2c2c2c,#161616 80%);transition:opacity .18s linear;pointer-events:none
  }
  .card-front{transform:rotateY(0deg) translateZ(0.1px);z-index:2;pointer-events:auto}
  .card-back{transform:rotateY(180deg) translateZ(0.1px);z-index:1;color:#e6f7ff;padding:14px;font-size:.90rem;gap:8px;justify-content:flex-start}
  .card.flipped .card-inner{transform:rotateY(180deg)}
  .card.flipped .card-front{z-index:1;pointer-events:none}
  .card.flipped .card-back{z-index:2;pointer-events:auto}

  .img-wrap{height:62%;background:#fff;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
  .img-wrap img{width:100%;height:100%;object-fit:cover;transition:transform 420ms var(--ease); background:#fff;}
  .img-wrap img:hover{transform:scale(1.05)}

  /* --- Image skeleton shimmer (cards only; lightbox skips skeleton) --- */
  @property --stop1 {
    syntax: '<percentage>';
    inherits: false;
    initial-value: 25%;
  }
  @property --stop2 {
    syntax: '<percentage>';
    inherits: false;
    initial-value: 37%;
  }
  @property --stop3 {
    syntax: '<percentage>';
    inherits: false;
    initial-value: 63%;
  }
  .img-skeleton {
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: linear-gradient(
      90deg,
      rgba(255,255,255,0.05) var(--stop1),
      rgba(255,255,255,0.12) var(--stop2),
      rgba(255,255,255,0.05) var(--stop3)
    );
    animation: shimmer 1s ease-in-out infinite alternate;
    pointer-events: none;
    z-index: 1;
  }
  @keyframes shimmer {
    0% { --stop1: 20%; --stop2: 30%; --stop3: 60%; }
    100% { --stop1: 40%; --stop2: 50%; --stop3: 80%; }
  }

  .front-body{padding:8px 10px;display:flex;flex-direction:column;gap:6px;flex:1;position:relative}
  .product-title-front{font-weight:600;font-size:.90rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .price-row{display:flex;justify-content:space-between;align-items:center}
  .price{font-weight:600;font-size:.96rem;color:#e8f8ff}

  /* Primary action buttons */
  .add-btn{
    transition:all .3s ease;background:linear-gradient(180deg,#f9a8d4,#c084fc);border:0;padding:8px 10px 8px 10px;border-radius:10px;color:#000;font-weight:600;cursor:pointer
  }
  .add-btn:hover{transform:translateY(-3px)}
  .add-btn:active,.add-btn.pressed{transform:translateY(1px) scale(0.98)}
  .view-img-btn{
    transition:all .3s ease;background:linear-gradient(90deg,#6ee7ff,#a78bfa);color:#000;border:0;padding:6px 10px;border-radius:8px;font-weight:600
  }
  .view-img-btn:hover{transform:translateY(-2px)}
  .view-img-btn:active,.view-img-btn.pressed{transform:translateY(1px) scale(0.98)}
  .share-btn{
    transition:all .18s var(--ease);background:rgba(255,255,255,0.06);border:0;padding:8px 10px;border-radius:8px;color:var(--text);font-weight:600
  }
  .share-btn i{width:18px;display:inline-block;text-align:center}
  .share-btn:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(0,0,0,0.4)}
  .share-btn:active,.share-btn.pressed{transform:translateY(1px) scale(0.98)}

  /* Back-of-card button tweaks on small screens: icon-only for compact layout */
  @media (max-width: 600px){
    .card-back .btn-label{display:none}
    .card-back { padding:10px; }
    .card-back > div:last-child {
      gap:5px !important;
      flex-wrap:nowrap !important;
      justify-content:center;
    }
    .card-back .view-img-btn,
    .card-back .share-btn,
    .card-back .add-btn{
      padding:7px;width:34px;height:34px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center; 
    }
    .card-back .view-img-btn i,
    .card-back .share-btn i,
    .card-back .add-btn i{ padding:0 !important; font-size:14px; }
    .card-back .share-btn i { width:16px; }
  }

  /* Product badges (discount, hot, etc.) */
  .card-badge{position:absolute;right:8px;bottom:8px;z-index:6;pointer-events:none;padding:6px 10px;border-radius:999px;font:var(--badge-font);color:#021019;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 20px rgba(2,16,25,0.5);transform-origin:100% 100%;transform:translateY(6px) scale(0.98);opacity:0;transition:transform 260ms var(--ease),opacity 220ms var(--ease);white-space:nowrap}
  .card.pop-in .card-badge{transform:translateY(0) scale(1);opacity:1}
  .card-badge .badge-dot{width:8px;height:8px;border-radius:50%;flex:0 0 8px;box-shadow:0 2px 4px rgba(0,0,0,0.25)}
  .card-badge.sale{background:linear-gradient(90deg,#d1fae5,#10b981);color:#012}
  .card-badge.sale .badge-dot{background:#036b4a}
  .card-badge.limited{background:linear-gradient(90deg,#ffebb7,#f59e0b);color:#081214}
  .card-badge.limited .badge-dot{background:#ac5d03}
  .card-badge.neutral{background:linear-gradient(90deg,#e6eef8,#9fb7d8);color:#021019}
  .card-badge.neutral .badge-dot{background:black}
  @media(max-width:500px){.card-badge{padding:5px 8px;font-size:.72rem}}

  .empty-state{grid-column:1/-1;padding:28px;border-radius:10px;background:rgba(255,255,255,0.03);text-align:center;color:#aaa}

  /* Sponsor card visuals (overlay moved into body area) */
  .sponsor-card{position:relative;}
  .sponsor-badge{
    align-self:flex-start;
    font-size:.72rem;
    color:#9bd4ff;
    border:1px solid rgba(155,212,255,0.3);
    background:linear-gradient(180deg, rgba(0,0,0,0.1), rgba(0,0,0,0.25));
    padding:3px 8px;
    border-radius:999px;
    margin-bottom:4px;
    text-transform:uppercase;
    letter-spacing:.3px;
  }
  .sponsor-card-front{outline:3px solid red;outline-offset:2px;border-radius:10px;overflow:hidden;height:100%;min-height:200px;display:flex;flex-direction:column;animation:rainbowJitter 5s steps(1) infinite;}
  @keyframes rainbowJitter{0%{outline-color:red}16%{outline-color:orange}33%{outline-color:yellow}50%{outline-color:lime}66%{outline-color:blue}83%{outline-color:#850bdd}100%{outline-color:violet}}
  .card.sponsor{box-shadow:0 6px 22px rgba(0,0,0,0.45);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01))}
  .card.sponsor .img-wrap{height:62%;background:#fff}
  .card.sponsor .front-body{padding:10px;display:flex;flex-direction:column;gap:6px;flex:1}
  .card.sponsor{color:var(--accent-strong);font-weight:600;font-size:.92rem;padding:0;margin:0}
  .card.sponsor .sponsor-title{font-weight:600;font-size:.95rem;margin-top:2px}
  .card.sponsor .sponsor-desc{color:#cbd9ea;margin-top:6px;font-size:.88rem;opacity:.95}
  /* Legacy sponsor overlay styles left for reference but unused now */
  .sponsor-overlay{display:none}

  /* ===========================================================
     Carousel (shared by cards and lightbox)
     =========================================================== */
  .carousel{position:relative;width:100%;height:100%;overflow:hidden;background:#111}
  .carousel-track{display:flex;height:100%;transition:transform 320ms cubic-bezier(0.22,0.9,0.27,1);will-change:transform}
  .carousel-slide{min-width:100%;height:100%;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;background:#111}
  .carousel-slide img{width:100%;height:100%;object-fit:cover;display:block}

  .carousel-controls{position:absolute;top:50%;transform:translateY(-50%);width:100%;display:flex;justify-content:space-between;padding:0 8px;pointer-events:none}
  .carousel-btn{pointer-events:auto;background:rgba(0,0,0,0.45);border:0;color:#fff;padding:8px 10px;border-radius:8px;backdrop-filter:blur(2px);transition:background 140ms ease, opacity 200ms var(--ease), transform 160ms var(--ease)}
  .carousel-btn:hover{background:rgba(0,0,0,0.62)}
  .carousel-btn:active,.carousel-btn.pressed{transform:scale(0.96)}

  .carousel-dots{position:absolute;left:50%;transform:translateX(-50%);bottom:8px;display:flex;gap:6px;pointer-events:auto}
  .carousel-dot{
    width:8px;height:8px;border-radius:25%;
    background:rgba(255,255,255,0.2);border:1px solid rgba(0,0,0,0.25);transition:transform 160ms var(--ease)
  }
  .carousel-dot:hover{transform:scale(1.2)}
  .carousel-dot.active{background:#06f}
  .carousel-counter{position:absolute;right:8px;top:8px;background:rgba(0,0,0,0.5);padding:6px 8px;border-radius:8px;font-weight:600;font-size:0.82rem}

  .lightbox .carousel-counter{
    position:fixed;
    left:12px;
    right:auto;
    top:18px;
    z-index:1001;
    pointer-events:none;
  }
  .lightbox .carousel-dot{
    width:10px;height:10px;border-radius:50%;
    background:#b4bcc4;
    border:1px solid rgba(0,0,0,0.7);
    box-shadow:0 1px 2px rgba(0,0,0,0.4);
  }
  .lightbox .carousel-dot.active{
    background:#06f;
    border-color:#001a33;
    box-shadow:0 0 0 2px rgba(0,102,255,0.25);
  }
  @media (max-width:480px){
    .carousel-btn{padding:6px 8px}
  }

  /* ===========================================================
     Transient notifications (add-to-cart and share)
     =========================================================== */
  .add-notif{position:fixed;bottom:20px;left:20px;background:linear-gradient(180deg,rgba(26,26,26,0.98),rgba(18,18,18,0.98));padding:10px;border-radius:10px;display:flex;gap:10px;align-items:center;border:1px solid rgba(10,170,255,0.12);box-shadow:0 12px 36px rgba(0,0,0,0.6);z-index:1200;opacity:0;pointer-events:none;transform:translateY(18px)}
  .add-notif.visible{animation:fadeInUp .28s var(--ease) forwards;pointer-events:auto}
  .add-notif.hiding{animation:fadeOutDown .28s var(--ease) forwards;pointer-events:none}
  .add-notif .product-thumb{width:48px;height:48px;object-fit:cover;border-radius:8px;background:#fff;padding:3px}
  .add-notif .msg{color:#e6f7ff;flex:1}
  .undo-btn,.close-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:8px;color:#fff}
  .undo-btn:hover,.close-btn:hover{transform:translateY(-1px)}
  .undo-btn:active,.close-btn:active,.undo-btn.pressed,.close-btn.pressed{transform:translateY(1px) scale(0.98)}
  .share-notif{position:fixed;bottom:20px;right:20px;background:linear-gradient(180deg,rgba(40,10,80,0.98),rgba(70,20,140,0.96));color:#fff;padding:10px 12px;border-radius:10px;z-index:1300;box-shadow:0 12px 36px rgba(0,0,0,0.6);opacity:0;transform:translateY(14px);transition:opacity 220ms var(--ease),transform 220ms var(--ease);pointer-events:none;display:flex;gap:10px;align-items:center}
  .share-notif.visible{opacity:1;transform:translateY(0);pointer-events:auto}

  /* ===========================================================
     Cart modal and footer
     =========================================================== */
  .cart-modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:100}
  .cart-modal.active{display:flex}
  .cart-content{background:#1a1a1a;border-radius:12px;padding:18px;width:90%;max-width:560px;max-height:80vh;overflow:auto;box-shadow:0 40px 120px rgba(0,0,0,0.7);position:relative}
  #closeCart{position:absolute;right:25px;top:30px;background:#06f;border:0;color:#fff;border-radius:50%;width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(0,102,255,0.12)}
  #closeCart:hover{transform:translateY(-1px)}
  #closeCart:active,#closeCart.pressed{transform:translateY(1px) scale(0.98)}
  .cart-footer{position:sticky;bottom:0;display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;outline:1px solid white;border-top:1px solid #333;border-radius:10px;background:linear-gradient(180deg,rgba(18,18,18),rgba(18,18,18));backdrop-filter:blur(6px);z-index:30}
  .cart-footer .left{display:flex;gap:8px;align-items:center}
  .cart-footer .subtotal{font-weight:600;font-size:1.02rem}
  .wa-btn{background:#25d366;color:#012;border:0;padding:10px 12px;border-radius:10px;font-weight:700;display:inline-flex;align-items:center;gap:8px}
  .wa-btn i{font-size:18px}
  .wa-btn:hover{transform:translateY(-1px)}
  .wa-btn:active,.wa-btn.pressed{transform:translateY(1px) scale(0.98)}
  #clearCartBtn{background:#ff2a2a;color:#fff;border-radius:10px;padding:8px 12px;border:0}

  /* Hide old cart info button (we use global bar or header info) */
  #cartInfoBtn, #cartInfoTooltip{display:none !important}

  /* ===========================================================
     Info/Disclaimer buttons + tooltips
     =========================================================== */
  .info-btn{
    margin-top: 4px;
    background: linear-gradient(90deg, #00b4ff, #6ee7ff);
    color:#012;
    border:0;border-radius:10px;padding:8px 10px;font-weight:700;
    display:inline-flex;align-items:center;justify-content:center;gap:6px;
    box-shadow:0 8px 18px rgba(0,0,0,0.25), inset 0 0 0 1px rgba(255,255,255,0.06);
  }
  .info-btn .icon{font-size:14px}
  .info-btn .label .chev{ margin-left:6px; transition: transform 180ms var(--ease); }
  .info-btn[aria-expanded="true"] .label .chev{ transform: rotate(180deg); }
  .info-btn:hover{transform:translateY(-1px)}
  .info-btn:active,.info-btn.pressed{transform:translateY(1px) scale(0.98)}

  .tooltip{
    position:absolute;right:12px;bottom:54px;max-width:320px;min-width:240px;
    background:linear-gradient(180deg,rgba(3,21,30,0.98),rgba(5,40,60,0.96));
    color:#e6f7ff;border:2px solid rgba(0,194,255,0.15);border-radius:12px;padding:12px 14px;z-index:60;
    box-shadow:0 12px 40px rgba(0,0,0,0.6),0 6px 18px rgba(0,194,255,0.06) inset;display:none;
  }
  .tooltip.visible{display:block;animation:fadeInUp .22s var(--ease)}
  .tooltip .tt-title{font-weight:700;margin-bottom:6px;color:#9bd4ff}
  .tooltip .tt-body{font-size:.92rem;line-height:1.25;opacity:.95}
  .tooltip .tt-body b{color:#cfe8ff;font-weight:600}
  .tooltip::after{
    content:"";position:absolute;right:18px;bottom:-10px;width:0;height:0;
    border-left:10px solid transparent;border-right:10px solid transparent;border-top:10px solid rgba(3,21,30,0.98);
    filter:drop-shadow(0 -4px 6px rgba(0,0,0,0.25))
  }

  #productInfoBar{
    display:flex; align-items:center; gap:8px; padding:0 18px; margin:6px 0 0 0;
    position:relative; justify-content:space-between;
  }
  #productCount{ color: var(--muted); font-weight: 600; padding: 10px 0 0 15px; }

  #globalInfoTooltip.tooltip{
    top:46px; right:0; bottom:auto;
  }
  #globalInfoTooltip.tooltip::after{
    right:18px; bottom:auto; top:-10px;
    border-top:none;
    border-left:10px solid transparent; border-right:10px solid transparent; border-bottom:10px solid rgba(3,21,30,0.98);
  }

  #headerInfoTooltip.tooltip{
    top:46px; right:0; bottom:auto;
  }
  #headerInfoTooltip.tooltip::after{
    right:18px; bottom:auto; top:-10px;
    border-top:none;
    border-left:10px solid transparent; border-right:10px solid transparent; border-bottom:10px solid rgba(3,21,30,0.98);
  }

  /* ===========================================================
     Lightbox
     =========================================================== */
  .lightbox{
    position:fixed;inset:0;background:#000;display:none;align-items:center;justify-content:center;z-index:200;touch-action:none;transition:background 260ms ease;
  }
  .lightbox.active{display:flex}
  .lightbox.opened{background:#000}
  .lightbox.closing{background:rgba(0,0,0,0)!important}
  .lightbox .lb-frame{
    width:95vw;max-width:1100px;height:82vh;max-height:90vh;display:flex;align-items:center;justify-content:center;
    opacity:0;transform:translateY(14px) scale(0.96);
    transition:transform 260ms var(--ease),opacity 260ms var(--ease)
  }
  .lightbox.opened .lb-frame{opacity:1;transform:translateY(0) scale(1)}
  .lightbox.closing .lb-frame{opacity:0;transform:translateY(24px) scale(0.96)}
  .lightbox .carousel{width:100%;height:100%;background:#000;border-radius:10px;overflow:hidden}
  .lightbox .carousel-slide{background:#000}
  .lightbox .carousel-btn{background:rgba(0,0,0,0.45)}
  .lightbox .carousel-btn:hover{background:rgba(0,0,0,0.62)}
  .lightbox .carousel-dots{bottom:12px}

  @media (min-width:721px){
    .lightbox .carousel-slide img.zoom-img{
      width:auto !important;height:82vh !important;max-height:82vh;max-width:96vw;object-fit:contain !important;
    }
  }

  .zoom-wrap{width:100%;height:100%;overflow:hidden;touch-action:none;display:flex;align-items:center;justify-content:center;background:#000}
  .zoom-img{max-width:100%;max-height:100%;will-change:transform;transform-origin:center center;transition:transform 80ms ease-out;}
  .lightbox .carousel-slide img.zoom-img{width:auto !important;height:auto !important;max-width:96vw;max-height:88vh;object-fit:contain !important}

  @media(max-width:720px){
    .lightbox .lb-frame{width:100vw;height:100vh;border-radius:0}
    .lightbox .carousel{border-radius:0; position:fixed; inset:0; width:100vw; height:100vh}
    .lightbox .carousel-slide img.zoom-img{max-width:100vw;max-height:100vh}
    .lightbox .carousel-controls{transition:opacity 200ms var(--ease)}
    .lightbox.hide-controls .carousel-controls{opacity:0;pointer-events:none}
  }

  /* ===========================================================
     Infinite scroll loading indicator
     =========================================================== */
  #loadingSpinner{text-align:center;padding:18px 0;color:#99bfe8}

  /* ===========================================================
     Focus outlines everywhere
     =========================================================== */
  :focus-visible{outline:3px solid rgba(0,102,255,0.12);outline-offset:3px;border-radius:8px}

  /* ===========================================================
     Modern preloader overlay
     =========================================================== */
  #preloader{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:#0b0b0b; display:flex; align-items:center; justify-content:center;
    z-index:999999; transition:opacity .45s ease
  }
  .preloader-card{
    width:min(420px,86vw); background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));
    border:1px solid rgba(255,255,255,0.06); border-radius:16px; padding:22px 20px; text-align:center;
    box-shadow:0 30px 100px rgba(0,0,0,0.55), inset 0 0 0 1px rgba(255,255,255,0.02);
  }
  .preloader-head{display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:12px}
  .preloader-logo{width:42px;height:42px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;}
  .preloader-logo img{width:100%;height:100%;object-fit:contain}
  .preloader-title{font-weight:600; letter-spacing:0.4px}
  .loader{height:64px;margin:2px auto 14px auto;background: url('assets/wide_logo.svg') center/contain no-repeat;animation:pulseLoader 1.4s ease-in-out infinite;transform-origin:center;}
  @keyframes pulseLoader { 0%, 100% { transform: scale(0.96); opacity: 0.8; } 50% { transform: scale(1.03); opacity: 1; } }
  #preloaderText{color:#cfe8ff;font-weight:600;letter-spacing:.4px;margin-bottom:8px}
  #preloaderBar{width:100%;height:10px;border-radius:999px;background:#202020;overflow:hidden;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.06); margin:0 auto}
  #preloaderBar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#00b4ff,#6ee7ff,#a78bfa);background-size:200% 100%; animation:barShift 1.2s ease-in-out infinite;border-radius:999px;}
  @keyframes barShift{0%{background-position:0% 50%}100%{background-position:100% 50%}}

  /* ===========================================================
     Hint tooltip (one-time helper)
     =========================================================== */
  #hintTooltip{display:none;position:fixed;bottom:28px;left:28px;z-index:1200;background:linear-gradient(180deg,rgba(3,21,30,0.98),rgba(5,40,60,0.96));border-radius:12px;padding:12px 14px;border:2px solid rgba(0,194,255,0.15);box-shadow:0 12px 40px rgba(0,0,0,0.6),0 6px 18px rgba(0,194,255,0.06) inset;color:#e6f7ff;font-weight:600;font-size:1rem;display:flex;gap:12px;align-items:center;min-width:260px;max-width:360px;transform-origin:center bottom;will-change:transform,opacity,box-shadow;pointer-events:auto;-webkit-tap-highlight-color:transparent;opacity:0;transition:opacity 220ms var(--ease),transform 220ms var(--ease)}
  #hintTooltip .icon{width:44px;height:44px;flex:0 0 44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--accent-strong),var(--accent));box-shadow:0 6px 18px rgba(0,194,255,0.12);color:#012;font-size:18px}
  #hintTooltip::after{content:"";position:absolute;left:22px;bottom:-10px;width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:10px solid rgba(3,21,30,0.98);filter:drop-shadow(0 -4px 6px rgba(0,0,0,0.25))}
  @keyframes subtlePulse{0%{box-shadow:0 6px 18px rgba(0,194,255,0.12),0 0 0 0 rgba(0,194,255,0)}60%{box-shadow:0 10px 26px rgba(0,194,255,0.16),0 0 14px 6px rgba(0,194,255,0.06)}100%{box-shadow:0 6px 18px rgba(0,194,255,0.12),0 0 0 0 rgba(0,194,255,0)}}
  #hintTooltip.visible{display:flex;opacity:1;transform:translateY(0)}
  #hintTooltip .icon.pulse{animation:subtlePulse 1700ms ease-in-out infinite}
  #hintTooltip.glowy{animation:hintGlow 2200ms ease-in-out 1}
  #hintTooltip .text{line-height:1.1;font-size:.98rem}

  @media(max-width:420px){
    .card-inner{height:300px}
    .card .front-body{padding:6px}
    .add-notif{left:12px;right:12px;bottom:18px}
  }

  @keyframes fadeOutDown{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(18px)}}

  /* ===========================================================
     Connection status toast (new)
     =========================================================== */
  #connectionToast{
    position:fixed; top:14px; right:14px;
    background:linear-gradient(180deg,rgba(3,21,30,0.98),rgba(5,40,60,0.96));
    border:1px solid rgba(0,194,255,0.2);
    color:#e6f7ff; padding:8px 12px; border-radius:8px;
    box-shadow:0 12px 40px rgba(0,0,0,0.6);
    z-index:10000; opacity:0; transform:translateY(-8px);
    pointer-events:none; transition:opacity 200ms var(--ease), transform 200ms var(--ease);
  }
  #connectionToast.visible{opacity:1; transform:translateY(0); pointer-events:auto}

  /* ===========================================================
     Footer policy links (rendered as buttons styled like links)
     =========================================================== */
  .footer-link{
    background:transparent;border:0;padding:0;color:var(--muted);text-decoration:underline;cursor:pointer;font:inherit;
  }
  .footer-link:hover{ filter:brightness(1.1) }
  .footer-link:focus-visible{ outline:3px solid rgba(0,102,255,0.35); outline-offset:3px; border-radius:6px }

  /* ===========================================================
     Policy modal (Terms, Privacy, Shipping)
     =========================================================== */
  .info-modal{
    position:fixed; inset:0; background:rgba(0,0,0,0.6);
    display:none; align-items:center; justify-content:center; z-index:100;
  }
  .info-modal.active{ display:flex }
  .info-content{
    background:#1a1a1a; border-radius:12px; padding:18px;
    width:90%; max-width:680px; max-height:80vh; overflow:auto;
    box-shadow:0 40px 120px rgba(0,0,0,0.7); position:relative;
  }
  #closePolicy{position:absolute; right:18px; top:18px; background:#06f; border:0; color:#fff; border-radius:50%; width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(0,102,255,0.12)}
  #closePolicy:hover{ transform:translateY(-1px) }
  #closePolicy:active,#closePolicy.pressed{ transform:translateY(1px) scale(0.98) }

  /* ===========================================================
     Card tag list (muted chips under description)
     =========================================================== */
  .tag-list{
    display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;
  }
  .tag-chip-sm{
    /* border:1px dashed rgba(255,255,255,0.15); */
    color:var(--muted);
    border: none;
    background:transparent;
    padding:4px 8px;
    /* border-radius:999px; */
    font-size:.7rem;
  }
  .tag-chip-sm:hover{filter:brightness(1.05);transform:translateY(-1px)}
  .tag-chip-sm:active,.tag-chip-sm.pressed{transform:translateY(1px) scale(0.98)}

  /* ===========================================================
     Mobile: keep actions visible, clip long desc/tags on card back
     =========================================================== */
  .card-back .card-actions{
    display:flex; gap:8px; flex-wrap:wrap; margin-top:auto;
  }
  @media (max-width: 600px){
    .card-back{
      display:grid;
      grid-template-rows: auto minmax(0,1fr) auto;
    }
    .card-back .card-desc p{
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .card-back .tag-list{
      overflow:hidden;
      -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 80%, rgba(0,0,0,0));
      mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 80%, rgba(0,0,0,0));
      padding-right:2px;
    }
    .card-back .card-actions{ margin-top:0 !important; }
  }
  </style>
 
</head>
<body>
  <script>
  /* Utility: safely ensure an array of images (>=1) per product */
  function ensureImagesArray(p){
    let imgs = p.images || p.img || [];
    if (typeof imgs === 'string') imgs = [imgs];
    if (!Array.isArray(imgs)) imgs = [];
    imgs = imgs.filter(Boolean);
    if (!imgs.length) imgs = ['assets/placeholder.png'];
    return imgs;
  }

  function attachImageFallback(imgEl){
    if(!imgEl) return;
    imgEl.addEventListener('error', () => {
      if(!imgEl.dataset.fallback){
        imgEl.dataset.fallback = "1";
        imgEl.src = 'assets/placeholder.png';
      }
    }, { once: false });
  }

  let lightboxState = { active: false, api: null, idleTimer: null };

  function money(n){return `R${Number(n).toFixed(2)}`;}
  function debounce(fn, wait = 300){ let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); }}

  function preloadImage(src){
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = async () => {
        try { if (img.decode) await img.decode(); } catch(e){}
        resolve({src, ok:true});
      };
      img.onerror = () => resolve({src, ok:false});
      img.src = src;
    });
  }

  /* CAROUSEL (cards + lightbox) */
  function createCarousel(containerEl, images, opts = {}){
    const {
      onImageClick = function(){},
      startIndex = 0,
      loop = true,
      showDots = true,
      showButtons = true,
      showCounter = true,
      className = 'carousel',
      enableZoom = false,
      eagerFirst = false,
      getAlt = (i,total) => `Product image ${i+1} of ${total}`
    } = opts;

    const total = images.length || 1;
    containerEl.innerHTML = '';
    containerEl.classList.add(...className.split(' ').filter(Boolean));

    const track = document.createElement('div');
    track.className = 'carousel-track';

    let slides = [];
    const makeSlide = (src, realIdx, isClone=false) => {
      const slide = document.createElement('div');
      slide.className = 'carousel-slide';
      slide.dataset.realIndex = String(realIdx);
      const altText = getAlt(realIdx, total);

      let skeleton = null;
      if(!enableZoom){
        skeleton = document.createElement('div');
        skeleton.className = 'img-skeleton';
        skeleton.setAttribute('aria-hidden','true');
        slide.appendChild(skeleton);
      }

      if(enableZoom){
        const zoomWrap = document.createElement('div');
        zoomWrap.className = 'zoom-wrap';
        const img = document.createElement('img');
        img.className = 'zoom-img';
        img.draggable = false;
        img.loading = 'eager';
        img.decoding = 'async';
        img.alt = altText;
        img.dataset.src = src || 'assets/placeholder.png';
        attachImageFallback(img);
        zoomWrap.appendChild(img);
        slide.appendChild(zoomWrap);
      } else {
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.decoding = 'async';
        img.dataset.src = src || 'assets/placeholder.png';
        attachImageFallback(img);
        img.addEventListener('load', () => {
          if(skeleton && skeleton.parentNode){ skeleton.parentNode.removeChild(skeleton); }
        }, { once: true });
        queueMicrotask(() => {
          if(img.complete && img.naturalWidth > 0 && skeleton && skeleton.parentNode){
            skeleton.parentNode.removeChild(skeleton);
          }
        });
        img.addEventListener('click', (e) => {
          e.stopPropagation();
          onImageClick(realIdx, images[realIdx]);
        });
        slide.appendChild(img);
      }
      if(isClone) slide.dataset.clone = '1';
      return slide;
    };

    const useLoop = loop && total > 1;
    if(useLoop){ slides.push(makeSlide(images[total-1], total-1, true)); }
    images.forEach((src, i) => slides.push(makeSlide(src, i, false)));
    if(useLoop){ slides.push(makeSlide(images[0], 0, true)); }
    slides.forEach(s => track.appendChild(s));
    containerEl.appendChild(track);

    let dots = null, prevBtn = null, nextBtn = null, counter = null, ctrlWrap = null;
    if(total > 1){
      if(showButtons){
        ctrlWrap = document.createElement('div');
        ctrlWrap.className = 'carousel-controls';
        prevBtn = document.createElement('button');
        prevBtn.className = 'carousel-btn';
        prevBtn.type = 'button';
        prevBtn.setAttribute('aria-label','Previous image');
        prevBtn.innerHTML = '<i class="fas fa-angle-left" aria-hidden="true"></i>';
        nextBtn = document.createElement('button');
        nextBtn.className = 'carousel-btn';
        nextBtn.type = 'button';
        nextBtn.setAttribute('aria-label','Next image');
        nextBtn.innerHTML = '<i class="fas fa-angle-right" aria-hidden="true"></i>';
        ctrlWrap.appendChild(prevBtn);
        ctrlWrap.appendChild(nextBtn);
        containerEl.appendChild(ctrlWrap);
      }

      if(showDots){
        dots = document.createElement('div');
        dots.className = 'carousel-dots';
        for(let i=0;i<total;i++){
          const d = document.createElement('button');
          d.className = 'carousel-dot';
          d.type = 'button';
          d.setAttribute('aria-label', `Show image ${i+1}`);
          d.addEventListener('click', (e) => { e.stopPropagation(); goTo(i, true); });
          dots.appendChild(d);
        }
        containerEl.appendChild(dots);
      }

      if(showCounter){
        counter = document.createElement('div');
        counter.className = 'carousel-counter';
        counter.setAttribute('aria-hidden','false');
        containerEl.appendChild(counter);
      }
    } else {
      if(!enableZoom){
        track.style.cursor = 'pointer';
      }
    }

    let realIndex = Math.min(Math.max(0, startIndex|0), total-1);
    let trackIndex = useLoop ? realIndex + 1 : realIndex;
    let isTransitioning = false;

    function imagesForRealIndex(idx){
      const arr = [];
      slides.forEach(sl => {
        if(Number(sl.dataset.realIndex) === idx){
          const img = enableZoom ? sl.querySelector('img.zoom-img') : sl.querySelector('img');
          if(img) arr.push(img);
        }
      });
      return arr;
    }
    function ensureLoaded(idx, priority='auto'){
      const imgs = imagesForRealIndex(idx);
      imgs.forEach(img => {
        if(img.dataset.loaded === '1') return;
        const src = img.dataset.src || 'assets/placeholder.png';
        if(!img.src || img.src.endsWith('placeholder.png')) img.src = src;
        img.dataset.loaded = '1';
        if(priority === 'high'){ try{ img.fetchPriority = 'high'; }catch(e){} }
      });
    }
    function ensureLoadedAround(idx, priorityCenter='auto'){
      ensureLoaded(idx, priorityCenter);
      ensureLoaded((idx - 1 + total) % total);
      ensureLoaded((idx + 1) % total);
    }

    function updateUI(noAnim=false){
      const width = containerEl.getBoundingClientRect().width || 1;
      if(noAnim){ track.style.transition = 'none'; }
      const offset = -trackIndex * Math.round(width);
      track.style.transform = `translateX(${offset}px)`;
      if(dots){
        const dotButtons = dots.querySelectorAll('.carousel-dot');
        dotButtons.forEach((d, i) => d.classList.toggle('active', i === realIndex));
      }
      if(counter){
        counter.textContent = `${realIndex + 1}/${total}`;
      }
      if(noAnim){
        void track.offsetWidth;
        track.style.transition = '';
      }
      ensureLoadedAround(realIndex);
    }

    function instantWrapIfOnClone(){
      if(!useLoop) return;
      if(trackIndex === 0){
        trackIndex = total;
        realIndex = total - 1;
        updateUI(true);
      } else if(trackIndex === total + 1){
        trackIndex = 1;
        realIndex = 0;
        updateUI(true);
      }
    }

    track.addEventListener('transitionend', () => {
      if(!useLoop) return;
      if(trackIndex === 0){
        isTransitioning = true; track.style.transition = 'none';
        trackIndex = total; realIndex = total - 1; updateUI();
        void track.offsetWidth; track.style.transition = ''; isTransitioning = false;
      } else if(trackIndex === total + 1){
        isTransitioning = true; track.style.transition = 'none';
        trackIndex = 1; realIndex = 0; updateUI();
        void track.offsetWidth; track.style.transition = ''; isTransitioning = false;
      }
    });

    function prev(){
      if(isTransitioning) return;
      instantWrapIfOnClone();
      isTransitioning = true; trackIndex -= 1;
      if(!useLoop){
        if(trackIndex < 0){ trackIndex = 0; }
        realIndex = trackIndex; updateUI(); setTimeout(()=> isTransitioning=false, 320);
      } else {
        realIndex = (realIndex - 1 + total) % total; updateUI();
        setTimeout(()=> { isTransitioning=false; instantWrapIfOnClone(); }, 320);
      }
    }
    function next(){
      if(isTransitioning) return;
      instantWrapIfOnClone();
      isTransitioning = true; trackIndex += 1;
      if(!useLoop){
        if(trackIndex > total - 1){ trackIndex = total - 1; }
        realIndex = trackIndex; updateUI(); setTimeout(()=> isTransitioning=false, 320);
      } else {
        realIndex = (realIndex + 1) % total; updateUI();
        setTimeout(()=> { isTransitioning=false; instantWrapIfOnClone(); }, 320);
      }
    }
    function goTo(idx, animate=true){
      idx = Math.min(Math.max(0, idx|0), total-1);
      realIndex = idx;
      trackIndex = useLoop ? realIndex + 1 : realIndex;
      if(!animate){ updateUI(true); } else { updateUI(); }
    }

    ensureLoadedAround(realIndex, eagerFirst ? 'high' : 'auto');
    updateUI(true);

    if(prevBtn) prevBtn.addEventListener('click', (e)=> { e.stopPropagation(); prev(); });
    if(nextBtn) nextBtn.addEventListener('click', (e)=> { e.stopPropagation(); next(); });

    let startX = 0, startY = 0, isDragging = false, moved = false, dragDX = 0;
    const touchStart = (x, y) => {
      isDragging = true; moved = false; dragDX = 0; startX = x; startY = y; track.style.transition = 'none';
    };
    const touchMove = (x, y, e) => {
      if(!isDragging) return;
      const dx = x - startX;
      const dy = y - startY;
      if(Math.abs(dy) > Math.abs(dx)) { return; }
      moved = true; dragDX = dx;
      const width = containerEl.getBoundingClientRect().width || 1;
      const offset = -trackIndex * width + dx;
      track.style.transform = `translateX(${offset}px)`;
      if(e) e.preventDefault();
    };
    const touchEnd = () => {
      if(!isDragging) return;
      isDragging = false; track.style.transition = '';
      if(!moved){ updateUI(); return; }
      const width = containerEl.getBoundingClientRect().width || 1;
      const threshold = Math.max(40, width * 0.18);
      if(dragDX > threshold) prev();
      else if(dragDX < -threshold) next();
      else updateUI();
    };

    track.addEventListener('touchstart', (e) => {
      if(e.touches.length !== 1) return;
      touchStart(e.touches[0].clientX, e.touches[0].clientY);
    }, {passive:true});
    track.addEventListener('touchmove', (e) => {
      if(!isDragging) return;
      touchMove(e.touches[0].clientX, e.touches[0].clientY, e);
    }, {passive:false});
    track.addEventListener('touchend', () => touchEnd());

    let mouseDown = false, mouseStartX = 0, mouseStartY = 0;
    track.addEventListener('mousedown', (e) => {
      mouseDown = true; mouseStartX = e.clientX; mouseStartY = e.clientY; track.style.transition = 'none'; e.preventDefault();
    });
    window.addEventListener('mousemove', (e) => {
      if(!mouseDown) return;
      const dx = e.clientX - mouseStartX;
      const dy = e.clientY - mouseStartY;
      if(Math.abs(dy) > Math.abs(dx)) return;
      moved = true; dragDX = dx;
      const width = containerEl.getBoundingClientRect().width || 1;
      const offset = -trackIndex * width + dx;
      track.style.transform = `translateX(${offset}px)`;
    });
    window.addEventListener('mouseup', (e) => {
      if(!mouseDown) return;
      mouseDown = false; track.style.transition = '';
      const dx = e.clientX - mouseStartX;
      const width = containerEl.getBoundingClientRect().width || 1;
      const threshold = Math.max(40, width * 0.18);
      if(dx > threshold) prev();
      else if(dx < -threshold) next();
      else updateUI();
    });

    containerEl.tabIndex = 0;
    containerEl.addEventListener('keydown', (e) => {
      if(e.key === 'ArrowLeft') { e.preventDefault(); prev(); }
      if(e.key === 'ArrowRight') { e.preventDefault(); next(); }
    });

    const ro = new ResizeObserver(()=> updateUI(true));
    ro.observe(containerEl);

    function resetAllZooms(){
      if(!enableZoom) return;
      slides.forEach(sl => { if(typeof sl._resetZoom === 'function') sl._resetZoom(); });
    }

    (function setupZoomHandlers(){
      if(!enableZoom) return;
      slides.forEach((sl) => {
        const wrap = sl.querySelector('.zoom-wrap');
        const img = sl.querySelector('img.zoom-img');
        if(!wrap || !img) return;
        let scale = 1;
        let minScale = 1;
        let maxScale = 4;
        let tx = 0, ty = 0;

        function applyTransform(){
          img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
          if(scale > 1){ wrap.dataset.zoomed = '1'; } else { delete wrap.dataset.zoomed; }
        }
        function clampPan(){
          const rect = wrap.getBoundingClientRect();
          const imgW = rect.width * scale;
          const imgH = rect.height * scale;
          const maxX = Math.max(0, (imgW - rect.width)/2);
          const maxY = Math.max(0, (imgH - rect.height)/2);
          tx = Math.min(maxX, Math.max(-maxX, tx));
          ty = Math.min(maxY, Math.max(-maxY, ty));
        }
        function zoomAt(pointX, pointY, deltaScale){
          const rect = wrap.getBoundingClientRect();
          const prevScale = scale;
          scale = Math.min(maxScale, Math.max(minScale, scale * deltaScale));
          const cx = pointX - rect.left - rect.width/2;
          const cy = pointY - rect.top - rect.height/2;
          tx = (tx - cx) * (scale/prevScale) + cx;
          ty = (ty - cy) * (scale/prevScale) + cy;
          clampPan(); applyTransform();
        }

        wrap.addEventListener('wheel', (e) => {
          e.preventDefault();
          const delta = e.deltaY < 0 ? 1.12 : 0.9;
          zoomAt(e.clientX, e.clientY, delta);
        }, { passive:false });

        let lastClick = 0;
        wrap.addEventListener('click', (e) => {
          const now = Date.now();
          if(now - lastClick < 280){
            e.stopPropagation();
            if(scale > 1){
              scale = 1; tx = 0; ty = 0; applyTransform();
            } else {
              zoomAt(e.clientX, e.clientY, 2);
            }
          }
          lastClick = now;
        });

        let panningActive = false, lastPX = 0, lastPY = 0;
        wrap.addEventListener('pointerdown', (e) => {
          if(scale === 1) return;
          panningActive = true; wrap.setPointerCapture(e.pointerId);
          lastPX = e.clientX; lastPY = e.clientY;
        });
        wrap.addEventListener('pointermove', (e) => {
          if(!panningActive) return;
          const dx = e.clientX - lastPX;
          const dy = e.clientY - lastPY;
          lastPX = e.clientX; lastPY = e.clientY;
          tx += dx; ty += dy; clampPan(); applyTransform();
        });
        wrap.addEventListener('pointerup', (e) => { panningActive = false; try{wrap.releasePointerCapture(e.pointerId);}catch(_e){} });
        wrap.addEventListener('pointercancel', () => { panningActive = false; });

        let pinch = { active:false, startDist:0, startScale:1, centerX:0, centerY:0 };
        wrap.addEventListener('touchstart', (e) => {
          if(e.touches.length === 2){
            pinch.active = true;
            const [t0,t1] = e.touches;
            pinch.startDist = Math.hypot(t1.clientX - t0.clientX, t1.clientY - t0.clientY);
            pinch.startScale = scale;
            pinch.centerX = (t0.clientX + t1.clientX)/2;
            pinch.centerY = (t0.clientY + t1.clientY)/2;
          }
        }, {passive:true});
        wrap.addEventListener('touchmove', (e) => {
          if(pinch.active && e.touches.length === 2){
            e.preventDefault();
            const [t0,t1] = e.touches;
            const dist = Math.hypot(t1.clientX - t0.clientX, t1.clientY - t0.clientY);
            const delta = dist / (pinch.startDist || 1);
            scale = Math.min(maxScale, Math.max(minScale, pinch.startScale * delta));
            zoomAt(pinch.centerX, pinch.centerY, 1);
          }
        }, {passive:false});
        wrap.addEventListener('touchend', () => { pinch.active = false; }, {passive:true});

        const resetZoom = () => { scale = 1; tx = 0; ty = 0; applyTransform(); };
        sl._resetZoom = resetZoom;
      });
    })();

    return {
      setIndex: (i) => { goTo(i, false); resetAllZooms(); },
      getIndex: () => realIndex,
      prev: () => { prev(); },
      next: () => { next(); },
      refresh: () => { updateUI(true); },
      destroy: () => { try{ ro.disconnect(); }catch(e){} containerEl.innerHTML = ''; }
    };
  }
  </script>

  <a href="#mainContent" class="skip-link">Skip to main content</a>

  <div id="preloader">
    <div class="preloader-card" aria-live="polite" aria-busy="true">
      <div class="preloader-head"></div>
      <div class="loader" aria-hidden="true"></div>
      <div id="preloaderText">Loading…</div>
      <div id="preloaderBar" aria-hidden="true"><span></span></div>
    </div>
  </div>

  <div id="addNotif" class="add-notif" role="status" aria-live="polite" aria-atomic="true">
    <img id="addNotifThumb" class="product-thumb" src="" alt="">
    <div id="addNotifMsg" class="msg">Product added to cart</div>
    <button id="undoAddBtn" class="undo-btn" aria-label="Undo add">Undo</button>
    <button id="closeAddNotif" class="close-btn" aria-label="Dismiss"><i class="fas fa-times" aria-hidden="true"></i></button>
  </div>

  <div id="shareNotif" class="share-notif" role="status" aria-live="polite" aria-atomic="true">
    <div style="display:flex;align-items:center;gap:10px">
      <i class="fas fa-link" aria-hidden="true" style="font-size:18px"></i>
      <span id="shareNotifMsg" style="font-weight:600">Link copied!</span>
    </div>
  </div>

  <div id="hintTooltip" role="note" aria-hidden="true">
    <div class="icon" aria-hidden="true"><i class="fas fa-hand-pointer"></i></div>
    <div class="text">Cards flip -- click to see more!</div>
  </div>

  <a id="scrollToTopBtn" href="#" role="button" aria-label="Scroll to top" tabindex="0"><i class="fas fa-angle-up" aria-hidden="true"></i></a>

  <div id="connectionToast" role="status" aria-live="polite" aria-atomic="true"></div>

  <header>
    <div class="top-row">
      <div class="logo"><a href="./"><img src="assets/favicon.png" alt="Drift Threads logo"></a></div>

      <div class="search-wrap">
        <div class="search-box">
          <input id="searchInput" type="text" placeholder="Search products..." aria-label="Search products" inputmode="search">
          <button id="clearBtn" type="button" aria-label="Clear search" title="Esc clears search"><i class="fas fa-times" aria-hidden="true"></i></button>
        </div>
        <button id="searchBtn" type="button" aria-label="Search" style="border-radius:5px 25px 25px 5px"><i class="fas fa-search" aria-hidden="true"></i></button>
      </div>

      <!-- Desktop-only Info button (optional)
      <div id="headerInfoWrap" class="header-info-wrap">
        <button id="headerInfoBtn" class="info-btn" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="headerInfoTooltip" title="Important info">
          <span class="icon" aria-hidden="true">⚠️</span>
          <span class="label" style="font-weight:600">Info <i class="fas fa-angle-down chev" aria-hidden="true"></i></span>
        </button>
        <div id="headerInfoTooltip" class="tooltip" role="tooltip" aria-live="polite" aria-hidden="true">
          <div class="tt-title">Heads up!</div>
          <div class="tt-body">
  <b>Note:</b> Product images may not fully capture the real look.<br>
  Some visuals are AI-assisted and can appear slightly off.<br>
  Hoodies are printed in high-definition — they look sharper in real life.<br>
  Expect the actual product to look better than the preview images.
</div>
        </div>
      </div>
      -->
      <div id="cartBtn" role="button" tabindex="0" aria-label="Shopping cart" style="position:relative">
        <i class="fas fa-shopping-cart" aria-hidden="true"></i>
        <span id="cartCount">0</span>
      </div>
    </div>
  </header>

  <!-- Categories generated via JS (from CATEGORIES JSON) -->
  <nav class="cat-bar" role="tablist" aria-label="Product categories" id="catBar">
    <div class="cat-scroll-hint" id="catScrollHint" aria-hidden="true"></div>
  </nav>
  <button id="showAllCatsBtn" type="button" aria-label="Show all categories" style="padding-left: 20px;">Show all</button>

  <!-- New Tag filter bar -->
  <nav class="tag-bar" id="tagBar" aria-label="Filter by tags"></nav>

  <div id="productInfoBar" aria-label="Important info">
    <div id="productCount" role="status" aria-live="polite">0 items</div>
    <button id="globalInfoBtn" class="info-btn" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="globalInfoTooltip" title="Important info">
      <span class="icon" aria-hidden="true">⚠️</span><span class="label" style="font-weight:600">Info <i class="fas fa-angle-down chev" aria-hidden="true"></i></span>
    </button>
    <div id="globalInfoTooltip" class="tooltip" role="tooltip" aria-live="polite" aria-hidden="true">
      <div class="tt-title">Heads up!</div>
      <div class="tt-body">
        <b>Note:</b> Product images may not fully capture the real look.<br>
        Some visuals are AI-assisted and can appear slightly off.<br>
        Hoodies are printed in high-definition -- they look sharper in real life.<br>
        Expect the actual product to look better than the preview images.
      </div>
    </div>
  </div>

  <main id="mainContent">
    <section id="grid" aria-live="polite" aria-busy="false"></section>
    <div id="loadingSpinner" style="display:none"><i class="fas fa-spinner fa-pulse fa-2x" aria-hidden="true"></i></div>
  </main>

  <hr>
  <footer>
    <div>
      <img src="assets/wide_logo.png" alt="DriftThreads Logo" class="footer-img" style="border-radius: 10px;"><br>
      © DriftThreads<br>Streetwear built to drift -- Only in Joburg.
      <br><br>
      <a href="..">Main</a> •
      <a href="../blogs">Blogs</a> •  
      <a href="../contact">Contacts</a>
      <br><br>
      <button type="button" class="footer-link" id="terms-link">Terms & Conditions</button> •  
      <button type="button" class="footer-link" id="privacy-link">Privacy Policy</button> •  
      <button type="button" class="footer-link" id="shipping-link">Shipping Info</button>
    </div>
    <div class="muted">
      <br><br>
      <a href="https://www.instagram.com/driftthreads.official/"><i class="fab fa-instagram" style="margin-right:5px;"></i>driftthreads.official</a>
      <br><a href="https://www.tiktok.com/@driftthreads.official/"><i class="fab fa-tiktok" style="margin-right:5px;"></i>driftthreads.official</a>
    </div>
  </footer>

  <div id="cartModal" class="cart-modal" aria-hidden="true">
    <div class="cart-content" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
      <button id="closeCart" type="button" aria-label="Close cart"><i class="fas fa-times" aria-hidden="true"></i></button>
      <br>
      <h2 id="cartTitle" style="font-weight:600; margin-top:0;">Your Cart</h2>
      <div id="cartItems" class="cart-items" style="margin-bottom:12px"></div>
      <div class="cart-footer" aria-hidden="false">
        <div class="left">
          <div style="color:var(--muted)"><strong class="subtotal-label" style="font-weight:600;">Subtotal:</strong> <span id="cartTotal" class="subtotal">R0.00</span></div>
        </div>
        <div class="right" style="display:flex;gap:8px;align-items:center;position:relative">
          <button id="clearCartBtn" type="button">Clear</button>
          <button id="waOrderBtn" class="wa-btn" type="button" aria-label="Order now via WhatsApp"><i class="fab fa-whatsapp" aria-hidden="true"></i> Order</button>
          <button id="cartInfoBtn" class="info-btn" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="cartInfoTooltip" title="Important info">
            <span class="label" style="font-weight:700">⚠️</span>
          </button>
          <div id="cartInfoTooltip" class="tooltip" role="tooltip" aria-live="polite" aria-hidden="true">
            <div class="tt-title">Heads up!</div>
            <div class="tt-body">
              <b>Note:</b> Product images may not fully capture the real look.<br>
              Some visuals are AI-assisted and can appear slightly off.<br>
              Hoodies are printed in high-definition -- they look sharper in real life.<br>
              Expect the actual product to look better than the preview images.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="policyModal" class="info-modal" aria-hidden="true">
    <div class="info-content" role="dialog" aria-modal="true" aria-labelledby="policyTitle">
      <button id="closePolicy" type="button" aria-label="Close policy"><i class="fas fa-times" aria-hidden="true"></i></button>
      <h2 id="policyTitle" style="font-weight:600; margin-top:0;">Policy</h2>
      <div id="policyBody" style="color:#cfe8ff; line-height:1.35; font-size:0.98rem"></div>
    </div>
  </div>

  <div id="imgLightbox" class="lightbox" aria-hidden="true" tabindex="-1">
    <button id="closeLightbox" type="button" aria-label="Close image" style="position:absolute;right:18px;top:18px;background:transparent;border:0;color:#fff;font-size:22px;z-index:2"><i class="fas fa-times" aria-hidden="true"></i></button>
    <div class="lb-frame" id="lbFrame" aria-live="polite"></div>
  </div>

  <script>
  /* CATEGORIES (bar now generated from JSON) */
  const CATEGORIES = [
    { id: 'all', label: 'All' },
    { id: 'hoodies', label: 'Hoodies' },
    { id: 'mugs', label: 'Mugs' },
    { id: 'supplements', label: 'Supplements' },
    { id: 'couples', label: 'Couples' },
    { id: 'tees', label: 'Tees' },
    { id: 'hats', label: 'Hats' },
    { id: 'accessories', label: 'Accessories' },
    { id: 'stickers', label: 'Stickers' },
    { id: 'bags', label: 'Bags' },
    { id: 'other', label: 'Other' }
  ];

  /* Sponsors */
  const sponsors = [
    {id:'spon-1',title:'DriftThreads Blogs',img:'assets/logo.png',url:'/blogs',description:'Bored? Read some of our blogs! 🙃',badge:'Sponsored'},
    {id:'spon-2',title:'Instagram',img:'sponsors/ig.png',url:'https://www.instagram.com/driftthreads.official/',description:'Follow us @driftthreads.official',badge:'Sponsored'},
    {id:'spon-3',title:'TikTok',img:'sponsors/tt.png',url:'https://www.tiktok.com/@driftthreads.official/',description:'Check out our TikToks 👀',badge:'Sponsored'}
  ];

  /* Products + tags */
  const products = [
    {
      title: 'Drift Threads™ Hoodie',
      price: 700,
      cat: 'hoodies',
      img: [
        'products/hoodies/driftthreads_hoodie.jpeg',
        'products/hoodies/driftthreads_hoodie(2).jpeg',
        'products/hoodies/driftthreads_hoodie(3).jpeg'
      ],
      description: "Soft inside, tough outside -- the hoodie that rides with you anywhere",
      badge: 'Official',
      tags: ['hoodie','brand','official','driftthreads','streetwear']
    },
    {
      title: 'Gua Sha + Face Roller (Jade)',
      price: 150,
      cat: 'other',
      img: [
        'products/other/gua_sha.jpeg',
        'products/other/gua_sha(2).jpeg',
        'products/other/gua_sha(3).jpeg',
        'products/other/gua_sha(4).jpeg',
        'products/other/gua_sha(5).jpeg',
        'products/other/gua_sha(6).jpeg',
        'products/other/gua_sha(7).jpeg',
        'products/other/gua_sha(8).jpeg',
        'products/other/gua_sha(9).jpeg'
      ],
      description: "Traditional Chinese scraping tool -- made from pure Jade Stone",
      badge: 'Hot 🔥',
      tags: ['accessory','beauty','gua-sha','wellness']
    },
    {
      title: '"Boss" Couples Hoodie (2)',
      price: 1200,
      cat: 'couples',
      img: [
        'products/couples/boss_couples_hoodie.jpeg',
        'products/couples/boss_couples_hoodie(1).jpeg',
        'products/couples/boss_couples_hoodie(2).jpeg'
      ],
      description: 'Power couple energy -- twin hoodies for maximum flex and matching vibes',
      badge: 'Hot',
      tags: ['hoodie','couples','matching','set']
    },
    {
      title: 'Tokyo Revengers Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/tokyo_revengers.jpeg'],
      description: "Rep the gang, rep the streets -- Tokyo Revengers style",
      badge: '',
      tags: ['hoodie','anime','tokyo-revengers']
    },
    {
      title: '911 GT3 RS Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/911_gt3_rs.jpeg'],
      description: "Porsche vibes, street-ready fit -- feel the speed in every stitch",
      badge: '',
      tags: ['hoodie','car','porsche','911','gt3rs','euro']
    },
    {
      title: 'Akatsuki Hoodie',
      price: 750,
      cat: 'hoodies',
      img: ['products/hoodies/akatsuki.jpeg'],
      description:"Naruto’s legendary Akatsuki clouds, now on a hoodie -- menace approved",
      badge:'',
      tags: ['hoodie','anime','naruto','akatsuki']
    },
    {
      title: 'BMW Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/bmw.jpeg'],
      description:"Roll in style -- 'I need money for BMW' never looked this clean",
      badge:'',
      tags: ['hoodie','car','bmw','euro']
    },
    {
      title: 'Kakashi Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/kakashi.jpeg'],
      description:"Stealthy, iconic, and stylish -- Kakashi fanart hoodie for true anime heads",
      badge:'',
      tags: ['hoodie','anime','naruto','kakashi']
    },
    {
      title: 'Monkey D. Luffy Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/monkey_d_luffy.jpeg'],
      description:"Set sail with Luffy -- One Piece vibes, maximum hype",
      badge:'',
      tags: ['hoodie','anime','one-piece','luffy']
    },
    {
      title: 'Tokyo Ghoul Hoodie',
      price: 520,
      cat: 'hoodies',
      img: ['products/hoodies/tokyo_ghoul.jpeg'],
      description:"Dark, edgy, and savage -- Tokyo Ghoul energy for your streetwear",
      badge:'20% Off',
      tags: ['hoodie','anime','tokyo-ghoul','sale']
    },
    {
      title: 'BMW M Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/bmw_m.jpeg'],
      description:"BMW M series inspired hoodie -- engineered for flexing",
      badge:'',
      tags: ['hoodie','car','bmw','m','euro']
    },
    {
      title: 'One Piece Bros Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/one_piece_bros.jpeg'],
      description:"Luffy, Ace & Sabo -- the ultimate brotherhood, ultimate flex",
      badge:'',
      tags: ['hoodie','anime','one-piece','luffy','ace','sabo']
    },
    {
      title: 'Batman Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/batman.jpeg'],
      description:"Own the night -- Dark Knight vibes in hoodie form",
      badge:'',
      tags: ['hoodie','superhero','batman','dc']
    },
    {
      title: 'Retrowave BMW M3 E46 Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/retrowave_m3_e46.jpeg'],
      description:"Retro neon meets Bavarian muscle -- E46 M3 reimagined in retrowave drip",
      badge:'',
      tags: ['hoodie','car','bmw','e46','retrowave','euro']
    },
    {
      title: 'Mustang White Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/mustang_white.jpeg'],
      description:"American muscle, timeless legend -- Mustang power stitched into street-ready comfort",
      badge:'',
      tags: ['hoodie','car','ford','mustang','muscle','white']
    },
    {
      title: 'Dodge Black Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/dodge_hellcat.jpeg'],
      description:"Hellcat attitude, midnight energy-- Dodge muscle reimagined as everyday drip",
      badge:'',
      tags: ['hoodie','car','dodge','hellcat','muscle','usa','black']
    },
    {
      title: 'Demon Slayer Tee',
      price: 300,
      cat: 'tees',
      img: ['products/tees/demon_slayer.jpeg'],
      description: "Breath of drip -- Demon Slayer design locked onto a clean street tee",
      badge: '',
      tags: ['tee','anime','demon-slayer']
    },
    {
      title: 'Satoru Gojo Tee',
      price: 300,
      cat: 'tees',
      img: ['products/tees/satoru_gojo.jpeg'],
      description: "Infinity-level flex -- Gojo reimagined for casual streetwear",
      badge: '',
      tags: ['tee','anime','jjk','gojo']
    },
    {
      title: 'Ultra Instinct Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/ultra_instinct.jpeg'],
      description: "Goku’s ultimate form -- Ultra Instinct energy stitched into hoodie perfection",
      badge: '',
      tags: ['hoodie','anime','dragon-ball','goku','ultra-instinct']
    },
    {
      title: 'Naruto Tee',
      price: 300,
      cat: 'tees',
      img: ['products/tees/naruto.jpeg'],
      description: "The legendary orange logo itself -- Naruto drip in tee form",
      badge: '',
      tags: ['tee','anime','naruto']
    },
    {
      title: 'Sukuna Tee',
      price: 400,
      cat: 'tees',
      img: ['products/tees/sukuna.jpeg'],
      description: "The King of Curses, printed with menace -- Sukuna energy unleashed",
      badge: '',
      tags: ['tee','anime','jjk','sukuna']
    },
    {
      title: 'McLaren Brown Hoodie',
      price: 700,
      cat: 'hoodies',
      img: ['products/hoodies/mclaren_brown.jpeg', 'products/hoodies/mclaren_brown(2).jpeg'],
      description:"Track-bred precision, street-certified flex -- McLaren speed in hoodie form",
      badge:'',
      tags: ['hoodie','car','mclaren','supercar','brown','euro']
    },
    {
      title: 'Gojo Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/gojo.jpeg'],
      description:"Gojo style, endless charm -- Jujutsu Kaisen energy unlocked",
      badge:'',
      tags: ['hoodie','anime','jjk','gojo']
    },
    {
      title: 'Satoru Gojo Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/satoru_gojo.jpeg'],
      description:"For the real Gojo stans -- keep your style untouchable",
      badge:'',
      tags: ['hoodie','anime','jjk','gojo']
    },
    {
      title: 'Hellcat Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/hellcat_hoodie.jpeg'],
      description:'Supercharged swagger -- Hellcat muscle meets streetwear drip',
      badge:'',
      tags: ['hoodie','car','dodge','hellcat','muscle','usa']
    },
    {
      title: 'Primitive Hellcat Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/prmtv_hellcat_hoodie.jpeg'],
      description:'Aggressive style, street-ready edge -- Hellcat vibes turned hoodie perfection',
      badge:'',
      tags: ['hoodie','car','dodge','hellcat','muscle','usa','primitive']
    },
    {
      title: 'Straw Hats Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/straw_hats.jpeg'],
      description:"One Piece Straw Hats logo hoodie -- ride the Grand Line in style",
      badge:'',
      tags: ['hoodie','anime','one-piece','straw-hat']
    },
    {
      title: 'F1 Aston Martin Hoodie',
      price: 700,
      cat: 'hoodies',
      img: ['products/hoodies/f1_aston_martin.jpeg'],
      description: "Silver Arrows speed, stitched for the streets -- Mercedes AMG energy in hoodie form",
      badge: '',
      tags: ['hoodie','car','f1','aston-martin','racing','euro']
    },
    {
      title: 'Gear 5 Nike Hoodie',
      price: 750,
      cat: 'hoodies',
      img: ['products/hoodies/gear5_nike.jpeg'],
      description: "Luffy Gear 5 meets Nike swagger -- anime drip fused with street legend style",
      badge: '',
      tags: ['hoodie','anime','one-piece','gear5','nike','mashup']
    },
    {
      title: 'Porsche 911 Purple Hoodie',
      price: 700,
      cat: 'hoodies',
      img: ['products/hoodies/porsche_911_purple.jpeg'],
      description: "Royal vibes on a Stuttgart icon -- Porsche 911 flex in purple haze",
      badge: '',
      tags: ['hoodie','car','porsche','911','purple','euro']
    },
    {
      title: 'BMW M4 Hoodie',
      price: 700,
      cat: 'hoodies',
      img: ['products/hoodies/bmw_m4.webp'],
      description: "Bavarian beast, redefined -- M4 aggression printed for everyday drip",
      badge: '',
      tags: ['hoodie','car','bmw','m4','euro']
    },
    {
      title: 'GTR Nismo Hoodie',
      price: 750,
      cat: 'hoodies',
      img: ['products/hoodies/gtr_nismo.jpeg'],
      description: "Godzilla unleashed -- Nismo energy stitched for true JDM fans",
      badge: '',
      tags: ['hoodie','car','nissan','gtr','nismo','jdm']
    },
    {
      title: 'Skyline R34 Hoodie',
      price: 700,
      cat: 'hoodies',
      img: ['products/hoodies/skyline_r34.jpeg'],
      description: "R34 legend, timeless flex -- Skyline dreams turned into wearable drip",
      badge: '',
      tags: ['hoodie','car','nissan','skyline','r34','jdm']
    },
    {
      title: 'BMW Pink Haze Hoodie',
      price: 680,
      cat: 'hoodies',
      img: ['products/hoodies/bmw_pink.jpeg'],
      description: "Bold color, Bavarian power -- BMW vibes with pink heat",
      badge: '',
      tags: ['hoodie','car','bmw','pink','euro']
    },
    {
      title: 'GTRS Red Beam Hoodie',
      price: 720,
      cat: 'hoodies',
      img: ['products/hoodies/gtrs_red_beam.jpeg'],
      description: "Twin turbo legend lit in crimson energy -- GTRS meet red beam chaos",
      badge: '',
      tags: ['hoodie','car','porsche','gt3rs','red','euro']
    },
    {
      title: 'Supra Japan Hoodie',
      price: 700,
      cat: 'hoodies',
      img: ['products/hoodies/supra_japan.jpeg'],
      description: "Toyota’s icon repping the homeland -- JDM Supra hoodie with raw heritage",
      badge: '',
      tags: ['hoodie','car','toyota','supra','jdm','japan']
    },
    {
      title: 'Dodge Charger Hoodie',
      price: 680,
      cat: 'hoodies',
      img: ['products/hoodies/dodge_charger.jpeg'],
      description: "American muscle dominance -- Charger attitude built for the streets",
      badge: '',
      tags: ['hoodie','car','dodge','charger','muscle','usa']
    },
    {
      title: 'Lamborghini Huracan Hoodie',
      price: 750,
      cat: 'hoodies',
      img: ['products/hoodies/lambo_huracan.jpeg'],
      description: "Exotic fury, raging bull vibes -- Huracan spirit stitched into a hoodie",
      badge: '',
      tags: ['hoodie','car','lamborghini','huracan','supercar','euro']
    },
    {
      title: 'The Speed Community Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/the_speed_community.jpeg'],
      description: "For the car culture family -- speed, unity, and drip stitched as one",
      badge: '',
      tags: ['hoodie','car','community','logo','brand']
    },
    {
      title: 'F1 Red Bull Hoodie',
      price: 720,
      cat: 'hoodies',
      img: ['products/hoodies/f1_redbull.jpeg'],
      description: "Max power, team Red Bull vibes -- Formula 1 energy reimagined in streetwear",
      badge: '',
      tags: ['hoodie','car','f1','red-bull','racing','euro']
    },
    {
      title: 'Porsche 911 Petals Hoodie',
      price: 700,
      cat: 'hoodies',
      img: ['products/hoodies/porsche_911_petals.jpeg'],
      description: "Performance and elegance collide -- Porsche 911 wrapped in floral drip",
      badge: '',
      tags: ['hoodie','car','porsche','911','floral','euro']
    },
    {
      title: 'Nasty Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/nasty_hoodie.jpeg'],
      description: 'Bold, unapologetic streetwear energy -- drip hard with \'choeff\' vibes',
      badge: '',
      tags: ['hoodie','streetwear','nasty','logo']
    },
    {
      title: 'Nasty Juice Hoodie',
      price: 650,
      cat: 'hoodies',
      img: ['products/hoodies/nasty_juice_hoodie.jpeg'],
      description: 'Fresh flavors, fresh fit -- channel Nasty Juice energy on the streets',
      badge: '',
      tags: ['hoodie','streetwear','nasty','juice','logo']
    },
    {
      title: 'Drift Threads™ Mug',
      price: 150,
      cat: 'mugs',
      img: ['products/mugs/driftthreads_mug.jpeg'],
      description:"Morning coffee, leveled up -- Drift Threads™ approved",
      badge:'Official',
      tags: ['mug','brand','official','driftthreads','drinkware']
    },
    {
      title: 'Drift Threads™ Mug (White)',
      price: 150,
      cat: 'mugs',
      img: ['products/mugs/driftthreads_mug_white.jpeg'],
      description:"Sleek, clean, and fully Drift Threads™ certified -- sip in style",
      badge:'Official',
      tags: ['mug','brand','official','driftthreads','drinkware','white']
    }
  ];

  /* Normalize images & tags; add ids */
  products.forEach((p, i) => {
    p.images = ensureImagesArray(p);
    if(!p.id) p.id = `prod-${i}`;
    p.tags = Array.isArray(p.tags) ? p.tags.map(t => String(t).trim().toLowerCase()).filter(Boolean) : [];
  });
  sponsors.forEach((s, i) => { if(!s.id) s.id = `spon-${i}`; });

  /* DOM refs */
  const grid = document.getElementById('grid');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const clearBtn = document.getElementById('clearBtn');
  const cartBtn = document.getElementById('cartBtn');
  const cartCount = document.getElementById('cartCount');
  const cartModal = document.getElementById('cartModal');
  const cartItems = document.getElementById('cartItems');
  const cartTotal = document.getElementById('cartTotal');
  const closeCart = document.getElementById('closeCart');
  const clearCartBtn = document.getElementById('clearCartBtn');
  const waOrderBtn = document.getElementById('waOrderBtn');
  const imgLightbox = document.getElementById('imgLightbox');
  const lbFrame = document.getElementById('lbFrame');
  const closeLightboxBtn = document.getElementById('closeLightbox');
  const catBar = document.getElementById('catBar');
  const catScrollHint = document.getElementById('catScrollHint');
  const showAllCatsBtn = document.getElementById('showAllCatsBtn');
  const cartInfoBtn = document.getElementById('cartInfoBtn');
  const cartInfoTooltip = document.getElementById('cartInfoTooltip');
  const productInfoBar = document.getElementById('productInfoBar');
  const globalInfoBtn = document.getElementById('globalInfoBtn');
  const globalInfoTooltip = document.getElementById('globalInfoTooltip');
  const productCountEl = document.getElementById('productCount');
  const headerInfoBtn = document.getElementById('headerInfoBtn');
  const headerInfoTooltip = document.getElementById('headerInfoTooltip');
  const connectionToast = document.getElementById('connectionToast');
  const termsLink = document.getElementById('terms-link');
  const privacyLink = document.getElementById('privacy-link');
  const shippingLink = document.getElementById('shipping-link');
  const policyModal = document.getElementById('policyModal');
  const policyTitle = document.getElementById('policyTitle');
  const policyBody = document.getElementById('policyBody');
  const closePolicyBtn = document.getElementById('closePolicy');
  const tagBar = document.getElementById('tagBar');

  /* State */
  let cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const batchSize = 6;
  let filteredProducts = products.slice();
  let currentIndex = 0;
  let loading = false;
  let lastAdded = null;
  let notifTimer = null;
  let selectedTags = new Set(); // NEW

  /* IntersectionObserver for infinite scroll */
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if(entry.isIntersecting && !loading){
        observer.unobserve(entry.target);
        renderNextBatch();
      }
    });
  }, { root: null, rootMargin: '300px', threshold: 0.1 });

  let displayedNormalCount = 0;
  let sponsorIndex = 0;
  const SPONSOR_AFTER = 6;

  const CATS_SHOW_ALL_KEY = 'catsShowAll';
  let allowInfiniteScroll = false;

  function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); }

  function updateCartDisplay(){
    const totalQty = cart.reduce((a, c) => a + (c.qty || 0), 0);
    cartCount.textContent = totalQty;
    if(totalQty === 0){
      cartCount.style.display = 'none';
      cartCount.setAttribute('aria-hidden','true');
    } else {
      cartCount.style.display = '';
      cartCount.removeAttribute('aria-hidden');
    }
    cartItems.innerHTML = '';
    if(!cart.length){
      cartItems.innerHTML = '<p style="color:#aaa; font-weight: 600; padding: 10px 0 20px 10px; margin:0">Cart is empty</p>';
    } else {
      cart.forEach(item => {
        const row = document.createElement('div');
        row.className = 'cart-item';
        row.style.display = 'flex';
        row.style.gap = '12px';
        row.style.alignItems = 'center';
        row.style.background = '#222';
        row.style.padding = '8px';
        row.style.borderRadius = '8px';
        row.style.marginBottom = '8px';
        row.innerHTML = `
          <img src="${(item.images && item.images[0]) || item.img || 'assets/placeholder.png'}" alt="${item.title} thumbnail" style="width:60px;height:60px;object-fit:cover;border-radius:6px">
          <div style="flex:1"><div style="font-weight:600">${item.title}</div><div style="color:#aaa">${money(item.price)} <span style="opacity:0.9">×${item.qty}</span></div></div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <button class="remove-btn" aria-label="Remove ${item.title}" style="background:#ff2a2a;color:#fff;border:0;padding:6px 8px;border-radius:8px;"><i class="fas fa-trash" aria-hidden="true"></i></button>
          </div>
        `;
        const removeBtn = row.querySelector('.remove-btn');
        removeBtn && removeBtn.addEventListener('click', () => {
          cart = cart.filter(p => p.id !== item.id);
          saveCart(); updateCartDisplay();
        });
        cartItems.appendChild(row);
      });
    }
    cartTotal.textContent = money(cart.reduce((a,c) => a + (c.price * (c.qty || 0)), 0));
  }

  const addNotif = document.getElementById('addNotif');
  const addNotifMsg = document.getElementById('addNotifMsg');
  const addNotifThumb = document.getElementById('addNotifThumb');
  const undoAddBtn = document.getElementById('undoAddBtn');
  const closeAddNotifBtn = document.getElementById('closeAddNotif');

  function showAddNotification(p){
    addNotifThumb.src = (p.images && p.images[0]) || p.img || 'assets/placeholder.png';
    addNotifThumb.alt = p.title || "Product added";
    const ex = cart.find(i => i.id === p.id);
    const qty = ex ? ex.qty : 1;
    addNotifMsg.textContent = qty > 1 ? `${p.title} x${qty} added to cart` : `${p.title} added to cart`;
    addNotif.classList.remove('hiding');
    addNotif.classList.add('visible');
    cartCount.classList.remove('pop'); void cartCount.offsetWidth; cartCount.classList.add('pop');
    lastAdded = { id: p.id, when: Date.now() };
    if(notifTimer) clearTimeout(notifTimer);
    notifTimer = setTimeout(()=> {
      addNotif.classList.remove('visible'); addNotif.classList.add('hiding');
      setTimeout(()=> { addNotif.classList.remove('hiding'); }, 320);
      lastAdded = null;
      notifTimer = null;
    }, 2000);
  }

  function addToCart(p){
    if(!p.id) p.id = `prod-${Math.random().toString(36).slice(2,9)}`;
    const ex = cart.find(i => i.id === p.id);
    if(ex) ex.qty = (ex.qty || 1) + 1;
    else cart.push({...p, qty:1});
    saveCart(); updateCartDisplay(); showAddNotification(p);
  }

  addNotif.addEventListener('click', (e) => {
    if(e.target.closest('#undoAddBtn') || e.target.closest('#closeAddNotif')) return;
    openCartModal();
  });
  undoAddBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if(!lastAdded) return;
    const idx = cart.findIndex(i => i.id === lastAdded.id);
    if(idx > -1){
      if(cart[idx].qty > 1) cart[idx].qty--;
      else cart.splice(idx, 1);
      saveCart(); updateCartDisplay();
    }
    if(notifTimer){ clearTimeout(notifTimer); notifTimer = null; }
    lastAdded = null;
    addNotif.classList.remove('visible'); addNotif.classList.add('hiding');
    setTimeout(()=> addNotif.classList.remove('hiding'), 320);
  });
  closeAddNotifBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if(notifTimer){ clearTimeout(notifTimer); notifTimer = null; }
    lastAdded = null;
    addNotif.classList.remove('visible'); addNotif.classList.add('hiding');
    setTimeout(()=> addNotif.classList.remove('hiding'), 320);
  });

  function productShareUrl(p){
    const base = `${window.location.origin}${window.location.pathname}`;
    const params = new URLSearchParams();
    params.set('q', p.title);
    params.set('cat', p.cat || 'all');
    if(p.tags && p.tags.length) params.set('tags', p.tags.join(','));
    return `${base}?${params.toString()}`;
  }
  function showShareNotification(msg='Link copied!'){
    try { document.getElementById('shareNotifMsg').textContent = msg; document.getElementById('shareNotif').classList.add('visible'); setTimeout(()=> document.getElementById('shareNotif').classList.remove('visible'), 2000); } catch(e){}
  }
  async function shareProduct(p){
    const url = productShareUrl(p);
    const shareData = { title: p.title, text: `${p.title} -- ${money(p.price)}\n\n${(p.description||'').replace(/<[^>]*>?/gm,'')}`, url };
    if(navigator.share){
      try{ await navigator.share(shareData); showShareNotification('Shared!'); return; } catch(err){}
    }
    if(navigator.clipboard && navigator.clipboard.writeText){
      try{ await navigator.clipboard.writeText(url); showShareNotification('Link copied to clipboard!'); return; } catch(err){}
    }
    try { window.prompt('Copy this link:', url); showShareNotification('Link ready -- copied?'); } catch(err){ showShareNotification('Could not copy link'); }
  }

  /* Build a product card */
  function createCard(p, {eager=false} = {}){
    const card = document.createElement('article');
    card.className = 'card';
    card.tabIndex = 0;

    const inner = document.createElement('div');
    inner.className = 'card-inner';

    const front = document.createElement('div');
    front.className = 'card-front';

    const imgWrap = document.createElement('div');
    imgWrap.className = 'img-wrap';
    const images = p.images || ensureImagesArray(p);
    const carouselContainer = document.createElement('div');
    carouselContainer.style.width = '100%';
    carouselContainer.style.height = '100%';

    const carouselAPI = createCarousel(carouselContainer, images, {
      onImageClick: (index, url) => { openLightbox(p.images, index, p.title); },
      startIndex: 0,
      loop: true,
      showDots: false,
      showButtons: true,
      showCounter: true,
      className: 'carousel',
      enableZoom: false,
      eagerFirst: eager,
      getAlt: (i, total) => `${p.title} -- image ${i+1} of ${total}`
    });

    imgWrap.appendChild(carouselContainer);

    const frontBody = document.createElement('div');
    frontBody.className = 'front-body';
    frontBody.innerHTML = `<div class="product-title-front" style="margin-bottom:5px">${p.title}</div>
      <div class="price-row"><div class="price">${money(p.price)}</div>
      <div style="display:flex;gap:8px;align-items:center"><button class="add-btn" type="button" aria-label="Add ${p.title}"><i class="fas fa-plus" aria-hidden="true"></i></button></div></div>`;

    front.appendChild(imgWrap);
    front.appendChild(frontBody);

    const back = document.createElement('div');
    back.className = 'card-back';
    const desc = document.createElement('div');
    desc.className = 'card-desc';
    desc.innerHTML = `<h3 style="margin:0;font-weight:600">${p.title}</h3>
      <p style="margin:0;color:#bcd9f2;">${p.description}</p>`;
    back.appendChild(desc);

    // Tag chips (muted) on back
    const tagsWrap = document.createElement('div');
    tagsWrap.className = 'tag-list';
    (p.tags || []).forEach(t => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'tag-chip-sm';
      btn.dataset.tag = t;
      btn.textContent = `#${t}`;
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleTag(t, true);
      });
      tagsWrap.appendChild(btn);
    });
    back.appendChild(tagsWrap);

    const actions = document.createElement('div');
    actions.className = 'card-actions';
    actions.style.display = 'flex';
    actions.style.gap = '8px';
    actions.style.flexWrap = 'wrap';
    actions.innerHTML = `
      <button class="view-img-btn" type="button" aria-label="View ${p.title} images"><i class="fas fa-image" aria-hidden="true" style="padding-right:3px;"></i><span class="btn-label">View</span></button>
      <button class="share-btn" type="button" aria-label="Share ${p.title}"><i class="fas fa-share-alt" aria-hidden="true" style="padding-right:3px;"></i><span class="btn-label">Share</span></button>
      <button class="add-btn" type="button" aria-label="Add ${p.title}"><i class="fas fa-plus" aria-hidden="true" style="padding-right:3px;"></i><span class="btn-label">Add</span></button>
    `;
    back.appendChild(actions);

    const innerWrap = inner;
    innerWrap.appendChild(front);
    innerWrap.appendChild(back);
    card.appendChild(inner);

    // Badge injection on front image
    try {
      const imgWrapForBadge = front.querySelector('.img-wrap');
      if(imgWrapForBadge && p.badge && String(p.badge).trim()){
        const badgeText = String(p.badge).trim();
        const lower = badgeText.toLowerCase();
        let styleClass = 'neutral';
        if(/\d+\s*%/.test(badgeText) || /off/i.test(badgeText) || /\d+\s*percent/.test(lower)) styleClass = 'sale';
        else if(/limited|exclusive|new|drop|hot/i.test(lower)) styleClass = 'limited';
        const badgeEl = document.createElement('div');
        badgeEl.className = `card-badge ${styleClass}`;
        badgeEl.setAttribute('role','status');
        badgeEl.setAttribute('aria-label', badgeText);
        badgeEl.innerHTML = `<span class="badge-dot" aria-hidden="true"></span><span class="badge-text">${badgeText}</span>`;
        badgeEl.style.pointerEvents = 'none';
        imgWrapForBadge.appendChild(badgeEl);
      }
    } catch(err){ console.error('Badge injection', err); }

    function isControlTarget(el){
      return el.closest('.carousel-btn') || el.closest('.carousel-dots') || el.closest('.view-img-btn') || el.closest('.add-btn') || el.closest('.share-btn') || el.closest('.carousel');
    }

    card.addEventListener('click', (e) => {
      if(isControlTarget(e.target)) return;
      const other = document.querySelector('.card.flipped');
      if(other && other !== card) other.classList.remove('flipped');
      card.classList.toggle('flipped');
    });

    const frontAdd = front.querySelector('.add-btn');
    if(frontAdd) frontAdd.addEventListener('click', (e) => { e.stopPropagation(); addToCart(p); });
    back.querySelectorAll('.add-btn').forEach(b => {
      b.addEventListener('click', e => { e.stopPropagation(); addToCart(p); });
    });

    back.querySelectorAll('.share-btn').forEach(b => {
      b.addEventListener('click', e => { e.stopPropagation(); shareProduct(p); });
    });

    const viewBtn = back.querySelector('.view-img-btn');
    if(viewBtn){
      viewBtn.addEventListener('click', e => {
        e.stopPropagation();
        let idx = 0;
        try { idx = carouselAPI.getIndex(); } catch(err){}
        openLightbox(p.images, idx, p.title);
      });
    }

    card.addEventListener('keydown', e => {
      const isSpace = e.key === ' ' || e.key === 'Spacebar' || e.code === 'Space';
      if(e.key === 'Enter' || isSpace){
        e.preventDefault();
        const other = document.querySelector('.card.flipped');
        if(other && other !== card) other.classList.remove('flipped');
        card.classList.toggle('flipped');
      }
    });

    return card;
  }

  /* Sponsor card (Sponsored label moved to body area) */
  function createSponsorCard(s){
    const card = document.createElement('article');
    card.className = 'card sponsor';
    const inner = document.createElement('div');
    inner.className = 'card-inner';
    const front = document.createElement('div');
    front.className = 'sponsor-card-front';
    front.innerHTML = `
      <div class="img-wrap sponsor-card">
        <img loading="lazy" decoding="async" src="${s.img}" alt="${s.title} logo">
      </div>
      <div class="front-body" role="link" aria-label="${s.title} -- Sponsored" tabindex="-1">
        <div class="sponsor-badge">${s.badge || 'Sponsored'}</div>
        <div class="sponsor-title">${s.title}</div>
        <div class="sponsor-desc">${s.description || ''}</div>
      </div>`;
    inner.appendChild(front); card.appendChild(inner);
    const imgEl = front.querySelector('img'); attachImageFallback(imgEl);
    card.addEventListener('click', () => { const url = s.url || '#'; if(url && url !== '#') window.open(url, '_blank', 'noopener'); });
    card.tabIndex = 0;
    card.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); const url = s.url || '#'; if(url && url !== '#') window.open(url, '_blank', 'noopener'); } });
    return card;
  }

  function showSpinner(){ document.getElementById('loadingSpinner').style.display = 'block'; }
  function hideSpinner(){ document.getElementById('loadingSpinner').style.display = 'none'; }

  function observeLastCard(){
    const cards = grid.querySelectorAll('.card');
    const last = cards[cards.length - 1];
    if(last) observer.observe(last);
  }

  function renderNextBatch(){
    return new Promise((resolve) => {
      if(loading){ resolve(); return; }
      if(currentIndex >= filteredProducts.length){ observer.disconnect(); resolve(); return; }
      loading = true; showSpinner();
      setTimeout(() => {
        const slice = filteredProducts.slice(currentIndex, currentIndex + batchSize);
        slice.forEach((p, i) => {
          const eager = (currentIndex === 0);
          const c = createCard(p, {eager});
          c.classList.add('pop-in');
          c.style.animationDelay = `${i * 60}ms`;
          c.style.opacity = '1';
          grid.appendChild(c);
          displayedNormalCount++;
          if(displayedNormalCount % SPONSOR_AFTER === 0 && sponsors && sponsors.length){
            const s = sponsors[sponsorIndex % sponsors.length]; sponsorIndex++;
            const sc = createSponsorCard(s);
            sc.classList.add('pop-in'); sc.style.animationDelay = `${i * 60 + 80}ms`;
            grid.appendChild(sc);
          }
        });
        currentIndex += slice.length;
        loading = false; hideSpinner();

        if(allowInfiniteScroll){
          if(currentIndex >= filteredProducts.length) observer.disconnect();
          else observeLastCard();
        } else {
          observer.disconnect();
        }

        setTimeout(()=> resolve(), 120);
      }, 60);
    });
  }

  /* Tag index + bar */
  function buildTagIndex(list){
    const freq = new Map();
    list.forEach(p => (p.tags || []).forEach(t => freq.set(t, (freq.get(t)||0)+1)));
    return freq;
  }
  function buildTagBar(){
    const freq = buildTagIndex(products);
    const items = Array.from(freq.entries())
      .sort((a,b) => b[1]-a[1] || a[0].localeCompare(b[0]));
    tagBar.innerHTML = '';
    const MAX_TAGS = 60;
    const toShow = items.slice(0, MAX_TAGS);

    // Clear button first (sticky)
    const clearBtn = document.createElement('button');
    clearBtn.id = 'clearTagsBtn';
    clearBtn.type = 'button';
    clearBtn.textContent = 'Clear tags';
    clearBtn.addEventListener('click', () => {
      selectedTags.clear();
      filterAndRender();
      updateTagBarSelection();
    });
    tagBar.appendChild(clearBtn);

    toShow.forEach(([tag, count], idx) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'tag-chip';
      btn.dataset.tag = tag;
      btn.dataset.order = String(idx);
      btn.textContent = `#${tag}`;
      btn.title = `${count} item${count>1?'s':''}`;
      btn.addEventListener('click', () => toggleTag(tag, true));
      tagBar.appendChild(btn);
    });

    updateTagBarSelection();
  }
  function updateTagBarSelection(){
    const chips = Array.from(tagBar.querySelectorAll('.tag-chip'));
    const selected = selectedTags;
    chips.forEach(ch => {
      const t = ch.dataset.tag;
      ch.classList.toggle('active', selected.has(t));
    });

    // Update Clear button text and state
    const clearEl = document.getElementById('clearTagsBtn');
    if(clearEl){
      const n = selected.size;
      clearEl.innerHTML = n ? `Clear tags (<span class="count">${n}</span>)` : 'Clear tags';
      clearEl.disabled = n === 0;
      clearEl.setAttribute('aria-disabled', n === 0 ? 'true' : 'false');
    }

    // Reorder: active tags first (keep original order within groups)
    const ordered = chips.slice().sort((a,b) => {
      const aActive = selected.has(a.dataset.tag) ? 1 : 0;
      const bActive = selected.has(b.dataset.tag) ? 1 : 0;
      if(bActive !== aActive) return bActive - aActive;
      return (parseInt(a.dataset.order,10)||0) - (parseInt(b.dataset.order,10)||0);
    });

    // Remove all chips then append in the new order (keep clear button as first child)
    chips.forEach(ch => ch.remove());
    ordered.forEach(ch => tagBar.appendChild(ch));
  }
  function getSelectedTagsString(){ return Array.from(selectedTags).join(','); }
  function toggleTag(tag, doFilter=false){
    if(selectedTags.has(tag)) selectedTags.delete(tag); else selectedTags.add(tag);
    updateTagBarSelection();
    if(doFilter) filterAndRender();
  }

  /* Product count text (show only count) */
  function updateProductCount(){
    if(!productCountEl) return;
    const n = filteredProducts.length;
    productCountEl.textContent = `${n} item${n === 1 ? '' : 's'}`;
  }

  /* Filtering (q + category + tags) */
  function filterAndRender(){
    const q = (searchInput.value || '').trim().toLowerCase();
    const cat = document.querySelector('.cat-btn.active')?.dataset?.cat || 'all';
    filteredProducts = products.filter(p => {
      const matchCat = (cat === 'all') || p.cat === cat;
      const matchQ = !q || p.title.toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q) || (p.tags||[]).some(t => t.includes(q));
      const matchTags = selectedTags.size === 0 || Array.from(selectedTags).every(tag => (p.tags||[]).includes(tag));
      return matchCat && matchQ && matchTags;
    });

    currentIndex = 0;
    grid.innerHTML = '';
    displayedNormalCount = 0;
    sponsorIndex = 0;

    updateURL({ q: searchInput.value.trim(), cat, tags: getSelectedTagsString() }, { replace: true });
    updateProductCount();

    if(!filteredProducts.length){
      grid.innerHTML = '<div class="empty-state">No products found</div>';
      hideSpinner();
      observer.disconnect();
      return Promise.resolve();
    }
    return renderNextBatch();
  }

  /* URL state helpers (now includes tags) */
  function updateURL(state = {}, opts = { replace:false }){
    const params = new URLSearchParams(window.location.search);
    if(state.q !== undefined && state.q !== null && String(state.q).trim() !== '') params.set('q', String(state.q).trim()); else params.delete('q');
    if(state.cat !== undefined && state.cat !== null && String(state.cat).trim() !== '' && String(state.cat).trim() !== 'all') params.set('cat', String(state.cat).trim()); else params.delete('cat');
    if(state.tags !== undefined && state.tags !== null && String(state.tags).trim() !== '') params.set('tags', String(state.tags).trim()); else params.delete('tags');
    const newPath = window.location.pathname + (params.toString()?`?${params.toString()}` : '');
    if(opts.replace) history.replaceState({ q: state.q||'', cat: state.cat||'', tags: state.tags||'' }, '', newPath);
    else history.pushState({ q: state.q||'', cat: state.cat||'', tags: state.tags||'' }, '', newPath);
  }
  function readStateFromURL(){
    const params = new URLSearchParams(window.location.search);
    return { q: params.get('q') || '', cat: params.get('cat') || '', tags: params.get('tags') || '' };
  }
  function applyStateToUI(state){
    if(typeof state.q === 'string'){ searchInput.value = state.q; clearBtn.style.display = state.q ? 'flex' : 'none'; }
    const cat = (state.cat && state.cat.trim()) ? state.cat.trim() : 'all';
    document.querySelectorAll('.cat-btn').forEach(b => { b.classList.remove('active'); b.removeAttribute('aria-current'); });
    const match = document.querySelector(`.cat-btn[data-cat="${cat}"]`);
    if(match){ match.classList.add('active'); match.setAttribute('aria-current','true'); setTimeout(()=> match.scrollIntoView({ inline:'center', behavior:'smooth' }), 80); }
    else { const first = document.querySelector('.cat-btn[data-cat="all"]') || document.querySelector('.cat-btn'); if(first){ first.classList.add('active'); first.setAttribute('aria-current','true'); } }

    // Tags
    selectedTags.clear();
    const tagsStr = (state.tags || '').trim();
    if(tagsStr){
      tagsStr.split(',').map(t => t.trim().toLowerCase()).filter(Boolean).forEach(t => selectedTags.add(t));
    }
    updateTagBarSelection();
  }
  function applyStateFromURL(){ const st = readStateFromURL(); applyStateToUI(st); }

  /* Category bar generation + wiring */
  function buildCategoryBar(){
    if(!catBar) return;
    // Clear existing except hint if it exists
    const hint = document.getElementById('catScrollHint');
    catBar.innerHTML = '';
    CATEGORIES.forEach((c, idx) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = `cat-btn${c.id==='all'?' active':''}`;
      btn.dataset.cat = c.id;
      if(c.id==='all'){ btn.setAttribute('aria-current','true'); }
      btn.textContent = c.label;
      catBar.appendChild(btn);
    });
    if(hint){ catBar.appendChild(hint); }
    wireCategoryButtons();
  }
  function wireCategoryButtons(){
    document.querySelectorAll('.cat-btn').forEach(btn => {
      btn.addEventListener('click', ()=> {
        document.querySelectorAll('.cat-btn').forEach(b => { b.classList.remove('active'); b.removeAttribute('aria-current'); });
        btn.classList.add('active');
        btn.setAttribute('aria-current','true');
        const cat = btn.dataset.cat;
        updateURL({ q: searchInput.value.trim(), cat, tags: getSelectedTagsString() }, { replace:false });
        filterAndRender(); setTimeout(()=> updateCatBarUI(), 90);
      });
      btn.addEventListener('keydown', e => { if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); btn.click(); }});
    });
  }

  /* Categories bar UI */
  function updateCatShadow(){
    if(!catBar) return;
    const maxScroll = catBar.scrollWidth - catBar.clientWidth;
    if(maxScroll > 2 && window.matchMedia('(max-width: 900px)').matches){
      if(catBar.scrollLeft < maxScroll - 1){
        catScrollHint.classList.add('visible');
      } else {
        catScrollHint.classList.remove('visible');
      }
    } else {
      catScrollHint.classList.remove('visible');
    }
  }
  function updateCatBarUI(){
    if(!catBar) return;
    const canScroll = catBar.scrollWidth > catBar.clientWidth + 2;
    const isDesktop = window.matchMedia('(min-width: 901px)').matches;
    updateCatShadow();
    if(isDesktop && canScroll){
      showAllCatsBtn.style.display = 'inline-flex';
      const wantShowAll = localStorage.getItem(CATS_SHOW_ALL_KEY) === '1';
      catBar.classList.toggle('show-all', wantShowAll);
      showAllCatsBtn.textContent = wantShowAll ? 'Collapse' : 'Show all';
    } else {
      showAllCatsBtn.style.display = 'none';
      catBar.classList.remove('show-all');
      showAllCatsBtn.textContent = 'Show all';
    }
  }
  catBar && catBar.addEventListener('scroll', debounce(updateCatShadow, 60), { passive:true });
  window.addEventListener('resize', debounce(updateCatBarUI, 150));
  showAllCatsBtn.addEventListener('click', () => {
    const isDesktop = window.matchMedia('(min-width: 901px)').matches;
    if(!isDesktop) return;
    const on = catBar.classList.toggle('show-all');
    showAllCatsBtn.textContent = on ? 'Collapse' : 'Show all';
    localStorage.setItem(CATS_SHOW_ALL_KEY, on ? '1' : '0');
  });

  /* Scroll to top button */
  (function(){
    const btn = document.getElementById('scrollToTopBtn');
    if(!btn) return;
    let bottomHideOffset = 300;
    const setBottomOffset = () => {
      bottomHideOffset = window.matchMedia('(max-width: 600px)').matches ? 420 : 300;
    };
    setBottomOffset();
    function isNearBottom(){
      const doc = document.scrollingElement || document.documentElement;
      const distanceFromBottom = doc.scrollHeight - (doc.scrollTop + window.innerHeight);
      return distanceFromBottom < bottomHideOffset;
    }
    function updateVisibility(){
      const pastTopThreshold = window.scrollY > 240;
      const nearBottom = isNearBottom();
      if(pastTopThreshold && !nearBottom){ btn.classList.add('visible'); } else { btn.classList.remove('visible'); }
    }
    updateVisibility();
    window.addEventListener('scroll', updateVisibility, { passive:true });
    window.addEventListener('resize', () => { setBottomOffset(); updateVisibility(); }, { passive:true });
    function scrollTopHandler(e){ e.preventDefault(); btn.classList.add('click-anim'); setTimeout(()=> btn.classList.remove('click-anim'), 300); window.scrollTo({ top:0, behavior:'smooth' }); btn.blur(); }
    btn.addEventListener('click', scrollTopHandler);
    btn.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); scrollTopHandler(e); }});
    btn.addEventListener('focus', ()=> btn.classList.add('focused'));
    btn.addEventListener('blur', ()=> btn.classList.remove('focused'));
  })();

  /* Keyboard "pressed" class */
  (function(){
    function isButtonLike(el){
      return el && (el.tagName === 'BUTTON' || el.getAttribute('role') === 'button');
    }
    document.addEventListener('keydown', (e) => {
      const target = e.target;
      if(!isButtonLike(target)) return;
      const key = e.key || e.code;
      if(key === 'Enter' || key === ' ' || key === 'Spacebar'){
        target.classList.add('pressed');
      }
    });
    document.addEventListener('keyup', (e) => {
      const target = e.target;
      if(!isButtonLike(target)) return;
      target.classList.remove('pressed');
    });
    document.addEventListener('blur', (e) => {
      const target = e.target;
      if(isButtonLike(target)) target.classList.remove('pressed');
    }, true);
  })();

  /* Legacy cart info tooltip handlers (kept hidden) */
  (function(){
    function hideTooltip(){
      if(!cartInfoTooltip) return;
      cartInfoTooltip.classList.remove('visible');
      cartInfoTooltip.setAttribute('aria-hidden','true');
      if(cartInfoBtn) cartInfoBtn.setAttribute('aria-expanded','false');
    }
    function toggleTooltip(){
      if(!cartInfoTooltip || !cartInfoBtn) return;
      const showing = cartInfoTooltip.classList.toggle('visible');
      cartInfoTooltip.setAttribute('aria-hidden', showing ? 'false' : 'true');
      cartInfoBtn.setAttribute('aria-expanded', showing ? 'true' : 'false');
    }
    if(cartInfoBtn){
      cartInfoBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleTooltip(); });
      cartInfoBtn.addEventListener('mouseenter', () => { if(!/Mobi|Android/i.test(navigator.userAgent)){ cartInfoTooltip.classList.add('visible'); cartInfoTooltip.setAttribute('aria-hidden','false'); cartInfoBtn.setAttribute('aria-expanded','true'); }});
      cartInfoBtn.addEventListener('mouseleave', () => { if(!/Mobi|Android/i.test(navigator.userAgent)){ hideTooltip(); }});
    }
    document.addEventListener('click', (e) => {
      if(!cartInfoBtn || !cartInfoTooltip) return;
      if(e.target === cartInfoBtn || cartInfoTooltip.contains(e.target)) return;
      hideTooltip();
    });
    closeCart && closeCart.addEventListener('click', hideTooltip);
  })();

  function hideGlobalInfoTooltip(){
    if(!globalInfoTooltip) return;
    globalInfoTooltip.classList.remove('visible');
    globalInfoTooltip.setAttribute('aria-hidden','true');
    if(globalInfoBtn) globalInfoBtn.setAttribute('aria-expanded','false');
  }
  (function(){
    function toggleTooltip(){
      const showing = globalInfoTooltip.classList.toggle('visible');
      globalInfoTooltip.setAttribute('aria-hidden', showing ? 'false' : 'true');
      globalInfoBtn.setAttribute('aria-expanded', showing ? 'true' : 'false');
      if(showing){ hideHeaderInfoTooltip(); }
    }
    globalInfoBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleTooltip(); });
    document.addEventListener('click', (e) => {
      if(e.target === globalInfoBtn || globalInfoTooltip.contains(e.target)) return;
      hideGlobalInfoTooltip();
    });
  })();

  function hideHeaderInfoTooltip(){
    if(!headerInfoTooltip) return;
    headerInfoTooltip.classList.remove('visible');
    headerInfoTooltip.setAttribute('aria-hidden','true');
    if(headerInfoBtn) headerInfoBtn.setAttribute('aria-expanded','false');
  }
  (function(){
    if(!headerInfoBtn) return;
    function toggleHeaderTooltip(){
      const showing = headerInfoTooltip.classList.toggle('visible');
      headerInfoTooltip.setAttribute('aria-hidden', showing ? 'false' : 'true');
      headerInfoBtn.setAttribute('aria-expanded', showing ? 'true' : 'false');
      if(showing){ hideGlobalInfoTooltip(); }
    }
    headerInfoBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleHeaderTooltip(); });
    document.addEventListener('click', (e) => {
      if(e.target === headerInfoBtn || (headerInfoTooltip && headerInfoTooltip.contains(e.target))) return;
      hideHeaderInfoTooltip();
    });
    window.addEventListener('resize', debounce(() => {
      if(window.matchMedia('(max-width: 900px)').matches){ hideHeaderInfoTooltip(); }
    }, 120));
  })();

  function updateSearchPlaceholder(){
    try{
      const isMobile = window.matchMedia('(max-width: 600px)').matches;
      if(searchInput) searchInput.placeholder = isMobile ? 'Search...' : 'Search products...';
    } catch(e){}
  }
  window.addEventListener('resize', debounce(updateSearchPlaceholder, 120));

  function showConnectionToast(msg){
    if(!connectionToast) return;
    connectionToast.textContent = msg;
    connectionToast.classList.add('visible');
    setTimeout(()=> connectionToast.classList.remove('visible'), 1800);
  }
  window.addEventListener('offline', () => showConnectionToast('You are offline'));
  window.addEventListener('online', () => showConnectionToast('Back online'));

  const POLICY_CONTENT = {
    terms: {
      title: 'Terms & Conditions',
      html: `<p>All sales are final. DriftThreads reserves the right to update prices, availability, or designs without notice. By purchasing, you agree not to resell counterfeit or altered versions of our products.</p>`
    },
    privacy: {
      title: 'Privacy Policy',
      html: `<p>We don’t sell your data. Info you give us (like shipping details) is used only to process orders and improve your shopping experience. Analytics may run in the background (cookies, etc.), but that’s standard.</p>`
    },
    shipping: {
      title: 'Shipping Info',
      html: `<p>Every item is made-to-order/custom. Standard production + shipping times are 10--20 business days, depending on location and demand. Once shipped, delivery is handled by the courier, and delays are out of our control.</p>`
    }
  };
  let lastPolicyTrigger = null;
  function openPolicyModal(key){
    const c = POLICY_CONTENT[key];
    if(!c) return;
    policyTitle.textContent = c.title;
    policyBody.innerHTML = c.html;
    policyModal.classList.add('active');
    policyModal.setAttribute('aria-hidden','false');
    lastPolicyTrigger = document.activeElement;
    disableBackgroundInteraction([policyModal.querySelector('.info-content')]);
    setTimeout(()=> { try{ closePolicyBtn.focus(); }catch(e){} }, 40);
  }
  function closePolicyModal(){
    policyModal.classList.remove('active');
    policyModal.setAttribute('aria-hidden','true');
    enableBackgroundInteraction();
    try { if(lastPolicyTrigger && lastPolicyTrigger.focus) lastPolicyTrigger.focus(); } catch(e){}
    lastPolicyTrigger = null;
  }
  if(termsLink) termsLink.addEventListener('click', (e) => { e.preventDefault(); openPolicyModal('terms'); });
  if(privacyLink) privacyLink.addEventListener('click', (e) => { e.preventDefault(); openPolicyModal('privacy'); });
  if(shippingLink) shippingLink.addEventListener('click', (e) => { e.preventDefault(); openPolicyModal('shipping'); });
  closePolicyBtn.addEventListener('click', closePolicyModal);
  policyModal.addEventListener('click', (e) => { if(e.target === policyModal) closePolicyModal(); });

  /* Cart modal */
  function openCartModal(){ cartModal.classList.add('active'); cartModal.setAttribute('aria-hidden','false'); disableBackgroundInteraction([cartModal.querySelector('.cart-content')]); setTimeout(()=>{ try{ waOrderBtn.focus(); }catch(e){} }, 50); }
  cartBtn.addEventListener('click', ()=> openCartModal());
  closeCart.addEventListener('click', ()=>{ cartModal.classList.remove('active'); cartModal.setAttribute('aria-hidden','true'); enableBackgroundInteraction(); cartBtn.focus(); });
  cartModal.addEventListener('click', e => { if(e.target === cartModal) closeCart.click(); });
  clearCartBtn.addEventListener('click', ()=> { if(cart.length && confirm('Clear cart?')){ cart = []; saveCart(); updateCartDisplay(); } });

  const WA_NUMBER = '27713468567';
  const ORDER_WEBHOOK_URL = '';

  function genOrderId(){
    const t = new Date();
    const pad = n => String(n).padStart(2,'0');
    const date = `${t.getFullYear()}${pad(t.getMonth()+1)}${pad(t.getDate())}`;
    const time = `${pad(t.getHours())}${pad(t.getMinutes())}${pad(t.getSeconds())}`;
    const rand = Math.random().toString(36).slice(2,6).toUpperCase();
    return `DT-${date}-${time}-${rand}`;
  }
  function buildWhatsAppMessage(orderId){
    if(!cart || !cart.length) return encodeURIComponent("🛒 Hey -- ordering from the site:\n\nNo items in cart. (bruh)");
    let lines = [];
    lines.push("🛒 Hey -- ordering from the site:");
    if(orderId){ lines.push(`Order ID: ${orderId}`); }
    lines.push("");
    cart.forEach(item => { const line = `- ${item.title} (${money(item.price)}) x${item.qty}`; lines.push(line); });
    lines.push("");
    const subtotal = money(cart.reduce((a,c) => a + c.price*c.qty, 0));
    lines.push(`*Subtotal: ${subtotal}*`);
    lines.push("");
    lines.push(`Link: ${window.location.href}`);
    return encodeURIComponent(lines.join("\n"));
  }
  function getWhatsAppLink(orderId){ const base = `https://wa.me/${WA_NUMBER}`; const msg = buildWhatsAppMessage(orderId); return `${base}?text=${msg}`; }
  async function sendOrderToSheet(channel='whatsapp', orderId=null){
    try {
      if(!ORDER_WEBHOOK_URL) return;
      const payload = {
        orderId: orderId || genOrderId(),
        channel,
        items: cart.map(({ id, title, price, qty }) => ({ id, title, price, qty })),
        subtotal: cart.reduce((a,c) => a + c.price * (c.qty||0), 0),
        currency: 'ZAR',
        pageUrl: window.location.href,
        referrer: document.referrer || '',
        userAgent: navigator.userAgent || ''
      };
      const body = JSON.stringify(payload);
      if(navigator.sendBeacon){
        const blob = new Blob([body], { type: 'text/plain' });
        navigator.sendBeacon(ORDER_WEBHOOK_URL, blob);
      } else {
        fetch(ORDER_WEBHOOK_URL, { method:'POST', mode:'no-cors', headers:{ 'Content-Type':'text/plain' }, body }).catch(()=>{});
      }
    } catch(e){}
  }
  waOrderBtn.addEventListener('click', () => {
    const orderId = genOrderId();
    sendOrderToSheet('whatsapp', orderId);
    const link = getWhatsAppLink(orderId);
    window.open(link, '_blank', 'noopener');
  });

  function openLightbox(imgs, startIndex = 0, titleText = 'Image'){
    if(!Array.isArray(imgs) || !imgs.length) imgs = ['assets/placeholder.png'];
    lbFrame.innerHTML = '';
    const carouselHolder = document.createElement('div');
    carouselHolder.style.width = '100%';
    carouselHolder.style.height = '100%';

    const api = createCarousel(carouselHolder, imgs, {
      onImageClick: () => {},
      startIndex: startIndex,
      loop: true,
      showDots: true,
      showButtons: true,
      showCounter: true,
      className: 'carousel',
      enableZoom: true,
      eagerFirst: true,
      getAlt: (i, total) => `${titleText} -- large view ${i+1} of ${total}`
    });
    lightboxState.api = api;

    lbFrame.appendChild(carouselHolder);

    imgLightbox.classList.add('active');
    imgLightbox.setAttribute('aria-hidden','false');

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        try {
          api.setIndex(startIndex);
          if(api.refresh) api.refresh();
        } catch(e){}
        imgLightbox.classList.add('opened');
        setTimeout(()=> { try{ api.refresh && api.refresh(); }catch(e){} }, 60);
      });
    });

    disableBackgroundInteraction([imgLightbox, lbFrame]);
    lightboxState.active = true;

    setTimeout(()=>{ try{ closeLightboxBtn.focus(); }catch(e){} }, 50);

    const isMobile = window.matchMedia('(max-width: 720px)').matches;
    if(isMobile){
      const resetIdle = () => {
        imgLightbox.classList.remove('hide-controls');
        if(lightboxState.idleTimer) clearTimeout(lightboxState.idleTimer);
        lightboxState.idleTimer = setTimeout(() => {
          imgLightbox.classList.add('hide-controls');
        }, 1000);
      };
      ['touchstart','pointermove','mousemove','keydown'].forEach(ev => imgLightbox.addEventListener(ev, resetIdle, {passive:true}));
      resetIdle();
    }

    const onWinResize = debounce(()=> { try{ api.refresh && api.refresh(); }catch(e){} }, 80);
    window.addEventListener('resize', onWinResize);
    imgLightbox._onResize = onWinResize;
  }
  function lightboxClose(withAnim=true){
    if(lightboxState.idleTimer){ clearTimeout(lightboxState.idleTimer); lightboxState.idleTimer = null; }
    if(withAnim){
      imgLightbox.classList.add('closing');
      setTimeout(()=>{
        try{ if(lightboxState.api && typeof lightboxState.api.destroy === 'function') lightboxState.api.destroy(); }catch(e){}
        lightboxState.api = null;
        if(imgLightbox._onResize){ window.removeEventListener('resize', imgLightbox._onResize); imgLightbox._onResize = null; }
        imgLightbox.classList.remove('active','opened','closing','hide-controls');
        imgLightbox.setAttribute('aria-hidden','true');
        lbFrame.innerHTML = '';
        enableBackgroundInteraction();
        lightboxState.active = false;
      }, 260);
    } else {
      try{ if(lightboxState.api && typeof lightboxState.api.destroy === 'function') lightboxState.api.destroy(); }catch(e){}
      lightboxState.api = null;
      if(imgLightbox._onResize){ window.removeEventListener('resize', imgLightbox._onResize); imgLightbox._onResize = null; }
      imgLightbox.classList.remove('active','opened','closing','hide-controls');
      imgLightbox.setAttribute('aria-hidden','true');
      lbFrame.innerHTML = '';
      enableBackgroundInteraction();
      lightboxState.active = false;
    }
  }
  document.getElementById('closeLightbox').addEventListener('click', ()=> lightboxClose(true));
  imgLightbox.addEventListener('click', function(e){
    const isMobile = window.matchMedia('(max-width: 720px)').matches;
    if(e.target === imgLightbox){ lightboxClose(true); return; }
    if(!isMobile){
      const insideImage = e.target.closest('.zoom-wrap');
      const insideControls = e.target.closest('.carousel-controls');
      const insideDots = e.target.closest('.carousel-dots');
      const isCloseBtn = e.target.closest('#closeLightbox');
      if(!insideImage && !insideControls && !insideDots && !isCloseBtn){
        lightboxClose(true);
      }
    }
  });

  window.addEventListener('keydown', (e) => {
    if(e.key === 'Escape'){
      if(cartModal.classList.contains('active')){ closeCart.click(); }
      if(imgLightbox.classList.contains('active')){ lightboxClose(true); }
      if(policyModal.classList.contains('active')){ closePolicyModal(); }
      hideHeaderInfoTooltip();
      hideGlobalInfoTooltip();
    }
  });

  async function preloadCriticalAssets(){
    const pre = document.getElementById('preloader');
    const txt = document.getElementById('preloaderText');
    const bar = document.querySelector('#preloaderBar>span');

    let progress = 0;
    const setProgress = (p) => {
      progress = Math.max(progress, Math.min(100, Math.round(p)));
      if(txt) txt.textContent = `Loading ${progress}%`;
      if(bar) bar.style.width = `${progress}%`;
    };
    setProgress(5);

    try {
      const fontsReady = document.fonts ? document.fonts.ready : Promise.resolve();
      await Promise.race([fontsReady, new Promise(r=>setTimeout(r, 1200))]);
    } catch(e){}
    setProgress(20);

    const st = readStateFromURL();
    const cat = (st.cat && st.cat.trim()) ? st.cat.trim() : 'all';
    const q = (st.q || '').trim().toLowerCase();
    const tags = (st.tags || '').split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
    const list = products.filter(p => {
      const matchCat = (cat === 'all') || p.cat === cat;
      const matchQ = !q || p.title.toLowerCase().includes(q);
      const matchTags = tags.length===0 || tags.every(t => (p.tags||[]).includes(t));
      return matchCat && matchQ && matchTags;
    });

    const first = list[0] || products[0];
    const critImgs = [
      'assets/favicon.png',
      'assets/logo.png',
      (first && first.images && first.images[0]) ? first.images[0] : null
    ].filter(Boolean);

    const step = Math.floor(70 / Math.max(1, critImgs.length));
    const safety = new Promise(r => setTimeout(r, 2500));
    const doLoad = (async () => {
      for(const src of critImgs){
        try { await preloadImage(src); } catch(e){}
        setProgress(progress + step);
      }
      setProgress(90);
    })();

    await Promise.race([doLoad, safety]);

    const hide = () => new Promise((resolve) => {
      setProgress(100);
      setTimeout(()=> {
        if(pre){
          pre.style.opacity = '0';
          setTimeout(()=> { try{ pre.remove(); }catch(e){} resolve(); }, 450);
        } else { resolve(); }
      }, 120);
    });

    return { setProgress, hide };
  }

  function showHintTooltip(){
    try {
      const tip = document.getElementById('hintTooltip');
      if(!tip) return;
      const icon = tip.querySelector('.icon');
      tip.style.display = '';
      requestAnimationFrame(()=> {
        tip.classList.add('visible','glowy');
        tip.setAttribute('aria-hidden', 'false');
        if(icon) icon.classList.add('pulse');
      });
      setTimeout(()=> {
        tip.classList.remove('glowy');
        tip.style.transition = 'opacity 220ms var(--ease), transform 220ms var(--ease)';
        tip.style.opacity = '0';
        tip.setAttribute('aria-hidden', 'true');
        if(icon) icon.classList.remove('pulse');
        setTimeout(()=> { tip.classList.remove('visible'); tip.style.display = 'none'; tip.style.transition = ''; tip.style.opacity = ''; }, 260);
      }, 3000);
    } catch(e){}
  }

  const debouncedSearch = debounce(()=> {
    const cat = document.querySelector('.cat-btn.active')?.dataset?.cat || 'all';
    updateURL({ q: searchInput.value.trim(), cat, tags: getSelectedTagsString() }, { replace:false });
    filterAndRender();
  }, 320);

  searchInput.addEventListener('input', ()=> {
    clearBtn.style.display = searchInput.value ? 'flex' : 'none';
    // support #tag typed in search -> toggle tag quickly
    const val = searchInput.value.trim();
    const tagMatches = val.match(/#[a-z0-9\-]+/gi) || [];
    if(tagMatches.length){
      tagMatches.forEach(m => selectedTags.add(m.replace('#','').toLowerCase()));
      updateTagBarSelection();
    }
    debouncedSearch();
  });
  searchBtn.addEventListener('click', ()=> { filterAndRender(); searchInput.focus(); });
  clearBtn.addEventListener('click', ()=> { searchInput.value = ''; filterAndRender(); clearBtn.style.display = 'none'; searchInput.focus(); });
  document.addEventListener('keydown', (e) => {
    if(e.key === '/' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey){
      const tag = (document.activeElement && document.activeElement.tagName) || '';
      if(!/INPUT|TEXTAREA|SELECT/.test(tag)){
        e.preventDefault();
        searchInput.focus();
      }
    }
  });
  searchInput.addEventListener('keydown', (e) => {
    if(e.key === 'Escape'){
      e.preventDefault();
      clearBtn.click();
    }
  });

  function buildEverythingBars(){
    buildCategoryBar();
    buildTagBar();
  }

  /* Initialize */
  window.addEventListener('DOMContentLoaded', async () => {
    updateCartDisplay();
    buildEverythingBars();
    applyStateFromURL();
    updateCatBarUI();
    updateSearchPlaceholder();

    const pre = await preloadCriticalAssets();

    await filterAndRender();
    await renderNextBatch();

    await pre.hide();

    allowInfiniteScroll = true;
    observeLastCard();

    showHintTooltip();
  });

  /* Dev helper */
  window.__testOrderPing = () => {
    const backup = cart.slice();
    cart = [{ id:'test-1', title:'Test Item', price:123, qty:2 }];
    const id = genOrderId();
    sendOrderToSheet('test', id);
    cart = backup;
    console.log('Sent test order to sheet with ID:', id);
  };
  </script>

  <script>
  /* Accessibility: basic focus trap helpers for modals (existing site assumed to include these) */
  function disableBackgroundInteraction(allowListEls){
    document.body.classList.add('modal-open');
    // Could add inert/aria-hidden to siblings for stricter a11y if desired
  }
  function enableBackgroundInteraction(){
    document.body.classList.remove('modal-open');
  }
  </script>
</body>
</html>
